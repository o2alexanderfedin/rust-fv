---
phase: 29.3-borrow-conflict-detection-implementation
plan: "01"
subsystem: borrow-conflict
tags: [tdd, borrow-checking, lifetime, vcgen, use-after-expiry]
dependency_graph:
  requires: []
  provides: [generate_expiry_vcs, statement_references_local, collect_locals_in_rvalue, collect_locals_in_operand]
  affects: [borrow_conflict.rs]
tech_stack:
  added: []
  patterns: [tdd-red-green, statement-scanning, chain-iterator]
key_files:
  created: []
  modified:
    - crates/analysis/src/borrow_conflict.rs
decisions:
  - "generate_expiry_vcs() iterates shared+mutable borrows via chain() — mirrors generate_reborrow_vcs() chaining pattern already established in the module"
  - "statement_references_local() collects ALL locals from both LHS (place) and RHS (rvalue) of Assign — catches both read and write references to the expired borrow"
  - "Rvalue variants matched exhaustively without wildcard — compiler-enforced completeness when MIR API changes (follows Phase 29-01 CastKind precedent)"
  - "expiry_block computed as live_blocks.last() — represents the final live block, used in human-readable description only (not in VC location)"
metrics:
  duration_seconds: 266
  completed_date: "2026-02-25"
  tasks_completed: 2
  files_modified: 1
---

# Phase 29.3 Plan 01: Borrow Expiry VCGen Implementation Summary

**One-liner:** `generate_expiry_vcs()` with exhaustive statement scanning to detect use-after-lifetime-end for shared and mutable borrows.

## What Was Built

Implemented the `generate_expiry_vcs()` function in `crates/analysis/src/borrow_conflict.rs` (replacing the `Vec::new()` stub at line 144) plus three private helper functions for statement-level local variable reference detection.

### Key Functions Added

**`collect_locals_in_operand(op)`** — Extracts local variable names from an `Operand`. Returns the `local` field for `Copy`/`Move` operands; empty for `Constant`.

**`collect_locals_in_rvalue(rval)`** — Exhaustively matches all `Rvalue` variants (Use, Cast, Repeat, Ref, Len, Discriminant, BinaryOp, CheckedBinaryOp, UnaryOp, Aggregate) to collect referenced locals. No wildcard arm — compiler enforces completeness.

**`statement_references_local(stmt, local)`** — Checks if a `Statement` (Assign, Nop, SetDiscriminant, Assume) references a given local. For `Assign`, checks both the destination place (LHS) and the full rvalue (RHS).

**`generate_expiry_vcs(context, live_ranges, function)`** — Main implementation:
1. Chains `shared_borrows()` and `mutable_borrows()` into a single iterator
2. For each borrow, looks up its live range from `live_ranges`
3. Iterates all basic blocks; skips blocks within the live range
4. For blocks outside the live range, scans every statement with `statement_references_local()`
5. On match: emits a `BorrowValidity` VC with `block`/`statement` indices and a descriptive message

## TDD Flow

**Task 1 (RED):** Test `test_generate_expiry_vcs_use_after_expiry` was already in RED state — the test had been updated (Block 2 with `Statement::Assign` referencing `_1`, assertions for `vcs.len()==1`, `BorrowValidity`, `block==2`, `statement==0`). Confirmed FAIL with `left: 0, right: 1`. Committed as RED.

**Task 2 (GREEN):** Implemented three helpers and the full `generate_expiry_vcs()` body. All 1202 unit tests pass; both expiry tests GREEN:
- `test_generate_expiry_vcs_use_after_expiry`: borrow `_1` live in blocks [0,1], used in block 2 → 1 VC emitted
- `test_generate_expiry_vcs_no_expiry`: borrow live in all 3 blocks → 0 VCs

## Verification Results

```
cargo test -p rust-fv-analysis: 1202 passed; 0 failed; 0 ignored
cargo clippy -p rust-fv-analysis -- -D warnings: 0 warnings
test_generate_expiry_vcs_use_after_expiry: ok (len==1, BorrowValidity, block==2, stmt==0)
test_generate_expiry_vcs_no_expiry: ok (len==0)
All 13 borrow_conflict::tests pass
```

## Deviations from Plan

None — plan executed exactly as written. The test was already in RED state before execution began (the test code had been pre-written in the file).

## Self-Check: PASSED

Files exist:
- FOUND: crates/analysis/src/borrow_conflict.rs (modified, stub replaced)

Commits exist:
- 85fdb5a — test(29.3-01): RED state
- 0d9ffc0 — feat(29.3-01): GREEN implementation

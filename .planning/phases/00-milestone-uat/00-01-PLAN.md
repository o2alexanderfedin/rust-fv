---
phase: 00-milestone-uat
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md
autonomous: true
requirements:
  - UAT-01

must_haves:
  truths:
    - "v0.4-v0.5-UAT.md exists with status: complete and 22 test items covering phases 19-29"
    - "Every test item has a non-empty evidence field citing the exact command run and key output observed"
    - "cargo test --workspace passes with zero failures and the total count is recorded in evidence"
    - "cargo clippy --workspace produces zero warnings and that is recorded in evidence"
    - "The one known ignored test (vcgen_06_set_discriminant_assertion) is documented in the Gaps section"
  artifacts:
    - path: ".planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md"
      provides: "Combined v0.4+v0.5 UAT document covering phases 19-29"
      contains: "status: complete"
  key_links:
    - from: ".planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md"
      to: "cargo test --workspace output"
      via: "evidence fields cite actual test run output"
      pattern: "result: pass"
---

<objective>
Author and execute the combined v0.4+v0.5 UAT document validating that all deliverables from milestones v0.4 (phases 19-27) and v0.5 (phases 28-29) work correctly.

Purpose: Close the UAT gap — neither v0.4 nor v0.5 has a UAT file. Milestone completion requires a passed UAT.
Output: `.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` with status: complete, 22 test items, all passed.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-milestone-uat/00-CONTEXT.md
@.planning/phases/00-milestone-uat/00-RESEARCH.md
@.planning/phases/00-milestone-uat/milestone-UAT.md
@.planning/phases/00-milestone-uat/v0.3-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Author v0.4-v0.5-UAT.md with 22 test items (status: pending)</name>
  <files>.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md</files>
  <action>
Create `.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` following the exact YAML front-matter and test format established by `milestone-UAT.md` and `v0.3-UAT.md`.

**Front-matter:**
```yaml
---
status: in-progress
phase: v0.4-v0.5-milestone
source: 19-01-SUMMARY.md, 19-02-SUMMARY.md, 19-03-SUMMARY.md, 19-04-SUMMARY.md, 20-01-SUMMARY.md, 20-02-SUMMARY.md, 20-03-SUMMARY.md, 20-04-SUMMARY.md, 21-01-SUMMARY.md, 21-02-SUMMARY.md, 21-03-SUMMARY.md, 22-01-SUMMARY.md, 22-02-SUMMARY.md, 22-03-SUMMARY.md, 23-01-SUMMARY.md, 23-02-SUMMARY.md, 23-03-SUMMARY.md, 23-04-SUMMARY.md, 24-01-SUMMARY.md, 24-02-SUMMARY.md, 25-01-SUMMARY.md, 26-01-SUMMARY.md, 26-02-SUMMARY.md, 27-01-SUMMARY.md, 28-01-SUMMARY.md, 28-02-SUMMARY.md, 28-03-SUMMARY.md, 28-04-SUMMARY.md, 28-05-SUMMARY.md, 29-01-SUMMARY.md, 29-02-SUMMARY.md, 29-03-SUMMARY.md, 29-04-SUMMARY.md, 29-05-SUMMARY.md
started: 2026-02-25T00:00:00Z
updated: 2026-02-25T00:00:00Z
---
```

**Document structure:**
- `## Current Test` section with the currently running test name
- Optional summary table at the top (Claude's discretion — include it; helps navigation)
- Two top-level sections: `## v0.4 Tests (Phases 19-27)` and `## v0.5 Tests (Phases 28-29)`
- Each test: `### N. Test Name` with `expected:`, `result:`, `evidence:` fields

**Test items to author (all start with `result: pending`, `evidence: pending`):**

**v0.4 Tests:**

1. **Full Test Suite Health** — `cargo test --workspace` completes with all tests passing, zero failures, zero clippy warnings
   - expected: "`cargo test --workspace` completes with 1300+ passed, 0 failed. `cargo clippy --workspace` produces zero warnings."
   - evidence command: `cargo test --workspace 2>&1 | tail -5` + `cargo clippy --workspace`

2. **Structured Counterexample Model (Phase 19, CEX-01)** — VcOutcome::Sat carries Vec<(String,String)> structured model pairs; ir::Function.source_names maps SSA names to Rust source names
   - expected: "`cargo test -p rust-fv-driver -- cex_render` passes all cex_render unit tests. `ir::Function.source_names` field exists and maps SSA names to Rust source names from var_debug_info."
   - evidence command: `cargo test -p rust-fv-driver -- cex_render`

3. **Typed Counterexample Rendering (Phase 19, CEX-02)** — render_counterexample() produces CexVariable list with typed Rust values from SMT model
   - expected: "`cargo test -p rust-fv-driver -- json_output` passes. CexVariable and CexValue types exist in cex_render.rs with bitvec→decimal, struct/enum/ptr/array display."
   - evidence command: `cargo test -p rust-fv-driver -- json_output`

4. **Ariadne Source-Annotated Counterexamples (Phase 19, CEX-03)** — report_with_ariadne renders multi-label counterexample at actual source spans
   - expected: "`cargo test -p rust-fv-driver -- ariadne` passes. report_with_ariadne() in diagnostics.rs annotates failing source line with per-variable Labels."
   - evidence command: `cargo test -p rust-fv-driver -- ariadne`

5. **JSON Counterexample Schema (Phase 19, CEX-04)** — counterexample_v2 structured field in JsonFailure for machine consumers
   - expected: "`cargo test -p rust-fv-driver -- json_cex` passes. JsonFailure.counterexample_v2 field contains typed variables (name, ty, value) as structured JSON."
   - evidence command: `cargo test -p rust-fv-driver -- json_cex`

6. **pts_to Ownership Predicate (Phase 20, SEP-01)** — sep_logic::encode_pts_to() wired in spec_parser; pts_to(p,v) in #[requires]/#[ensures] works
   - expected: "`cargo test -p rust-fv-analysis --test sep_logic_integration` passes all E2E tests. sep_logic.rs declare_sep_heap/encode_pts_to/extract_pts_to_footprint exist."
   - evidence command: `cargo test -p rust-fv-analysis --test sep_logic_integration`

7. **Separating Conjunction and Ghost Predicates (Phase 20, SEP-02, SEP-04)** — pts_to(p,x) * pts_to(q,y) separating conjunction and #[ghost_predicate] recursive heap predicates with depth-3 unfolding
   - expected: "`cargo test -p rust-fv-analysis -- sep_logic` passes all sep_logic unit tests. GhostPredicateDatabase with depth-3 bounded unfolding compiles and passes ghost_predicate_db tests."
   - evidence command: `cargo test -p rust-fv-analysis -- sep_logic`

8. **RC11 Weak Memory Foundation (Phase 21, WMM-01, WMM-02)** — rc11.rs with generate_rc11_vcs() and 11 RC11 primitives; 9 canonical litmus tests pass
   - expected: "`cargo test -p rust-fv-analysis --test weak_memory_litmus` passes all litmus tests (MP, SB, LB, IRIW, CoRR, CoRW, CoWR, CoWW, Race). rc11.rs has generate_rc11_vcs(), WeakMemory VcKind variants."
   - evidence command: `cargo test -p rust-fv-analysis --test weak_memory_litmus`

9. **RC11 Unit Tests (Phase 21, WMM-03, WMM-04)** — has_non_seqcst_atomics() gate; data race detection VCs; generate_concurrency_vcs additive
   - expected: "`cargo test -p rust-fv-analysis -- rc11` passes all rc11 unit tests. has_non_seqcst_atomics() gates WeakMemory VC generation."
   - evidence command: `cargo test -p rust-fv-analysis -- rc11`

10. **fn_spec Higher-Order Closure Entailment (Phase 22, HOF-01, HOF-02)** — generate_fn_spec_vcs() emits AUFLIA-logic SMT; 6 Z3 UNSAT/SAT entailment tests for Fn/FnMut/FnOnce
    - expected: "`cargo test -p rust-fv-analysis --test hof_closures` passes all 6 Z3 tests. hof_vcgen.rs generate_fn_spec_vcs() exists with AUFLIA logic. `cargo test -p rust-fv-analysis -- hof_vcgen` passes unit tests."
    - evidence command: `cargo test -p rust-fv-analysis --test hof_closures`

11. **Async/Await IR and VCGen (Phase 23, ASY-01, ASY-02)** — CoroutineInfo IR types; generate_async_vcs() emitting QF_LIA; 6 Z3 integration tests
    - expected: "`cargo test -p rust-fv-analysis --test async_verification` passes all 6 tests. async_vcgen.rs generate_async_vcs() exists. CoroutineInfo/CoroutineState/CoroutineExitKind in ir.rs."
    - evidence command: `cargo test -p rust-fv-analysis --test async_verification`

12. **Async VCGen Unit Tests (Phase 23)** — #[state_invariant(expr)] proc macro; async_vcgen unit tests
    - expected: "`cargo test -p rust-fv-analysis -- async_vcgen` passes all async_vcgen unit tests. state_invariant proc macro parses and injects invariant VC."
    - evidence command: `cargo test -p rust-fv-analysis -- async_vcgen`

13. **Ghost Predicate E2E Wiring (Phase 24, SEP-04)** — generate_vcs_with_db() threaded through VerificationTask; ghost_pred_db reaches production VCGen path
    - expected: "`cargo test -p rust-fv-driver --test ghost_predicate_e2e` passes both E2E tests. `cargo test -p rust-fv-analysis -- ghost_predicate_db` passes 3 unit tests."
    - evidence command: `cargo test -p rust-fv-driver --test ghost_predicate_e2e`

14. **VSCode Counterexample v2 TypeScript Integration (Phase 25, CEX-02, CEX-04)** — renderCounterexampleLines() in diagnostics.ts uses counterexample_v2 typed schema; outputPanel.ts formatFailedFunction uses typed rendering
    - expected: "`cd vscode-extension && npx tsc --noEmit` exits 0 (zero type errors). diagnostics.ts and outputPanel.ts consume counterexample_v2 typed schema fields."
    - evidence command: `cd vscode-extension && npx tsc --noEmit`

15. **WeakMemoryRace Detection Fix (Phase 26, WMM-03)** — WeakMemoryRace VC emits SAT-returning formula; Relaxed data race surfaces as verification failure
    - expected: "`cargo test -p rust-fv-analysis --test weak_memory_litmus -- test_relaxed_data_race_detected` passes. WeakMemoryRace VC uses Assert(BoolLit(true)) with mo+rf constraints (not Assert(BoolLit(false)) stub)."
    - evidence command: `cargo test -p rust-fv-analysis --test weak_memory_litmus -- test_relaxed_data_race_detected`

16. **WeakMemoryRace E2E Driver Integration (Phase 26, WMM-03)** — wmm_race_e2e driver test confirms race surfaces end-to-end
    - expected: "`cargo test -p rust-fv-driver --test wmm_race_e2e` passes. WeakMemoryRace failure reported via diagnostics.rs with correct VcKind."
    - evidence command: `cargo test -p rust-fv-driver --test wmm_race_e2e`

17. **Async Counterexample IDE Fidelity (Phase 27, ASY-02)** — poll_iteration and await_side extracted from Z3 model; JsonCounterexample TypeScript interface updated; E2E confirms async fields populate
    - expected: "`cargo test -p rust-fv-driver --test async_cex_e2e` passes. `cargo test -p rust-fv-driver -- test_build_counterexample_v2_async_fields` passes. JsonCounterexample has poll_iteration?: number and await_side?: string."
    - evidence command: `cargo test -p rust-fv-driver --test async_cex_e2e`

18. **SMT VCGen Completeness Test Suite (Phase 28, VCGEN-01..04)** — vcgen_completeness28 10-test suite all GREEN; array bounds VCs, discriminant binding, numeric casts, generic trait premises
    - expected: "`cargo test -p rust-fv-analysis --test vcgen_completeness28` passes all 10 tests. encode_int_to_int_cast, Rvalue::Discriminant, generate_index_bounds_vcs, trait_bounds_as_smt_assumptions all implemented."
    - evidence command: `cargo test -p rust-fv-analysis --test vcgen_completeness28`

19. **VCGen Phase 29 Gap Fix Test Suite (Phase 29, MIRCONV-01, MIRCONV-02, VCGEN-05, VCGEN-06)** — vcgen_completeness29 active tests GREEN; one test intentionally ignored (vcgen_06_set_discriminant_assertion)
    - expected: "`cargo test -p rust-fv-analysis --test vcgen_completeness29` shows 9 passed, 1 ignored, 0 failed. encode_float_to_int_cast uses fp.to_sbv/fp.to_ubv. AggregateKind::Adt in mir_converter. TyKind::Param maps to Ty::Generic."
    - evidence command: `cargo test -p rust-fv-analysis --test vcgen_completeness29`

20. **CastKind Exhaustive Match (Phase 29, MIRCONV-01)** — CastKind match in mir_converter is exhaustive (no wildcard); compiler enforces completeness
    - expected: "`cargo test -p rust-fv-analysis -- mirconv` passes all MIRCONV unit tests. mir_converter.rs CastKind match is exhaustive (no `_ =>` wildcard arm)."
    - evidence command: `cargo test -p rust-fv-analysis -- mirconv`

21. **Functional Record Update for Struct Mutation (Phase 29, VCGEN-06)** — projected LHS struct field mutation produces mk-StructName functional update in SMT; Downcast type narrowing works
    - expected: "`cargo test -p rust-fv-analysis -- vcgen_06` passes. Projected LHS assignment to struct.field emits `(mk-StructName new_val (sel2 base) ...)` functional update. Downcast narrows Place type to variant-struct."
    - evidence command: `cargo test -p rust-fv-analysis -- vcgen_06`

22. **Repeat/CopyForDeref/RawPtr Rvalue Handling (Phase 29, MIRCONV-01)** — Rvalue::Repeat, CopyForDeref, RawPtr arms in mir_converter.rs; TyKind::Param→Ty::Generic fix
    - expected: "`cargo test -p rust-fv-analysis -- vcgen_04` passes. Rvalue::Repeat, CopyForDeref, RawPtr all have converter arms (no panics on nightly MIR). Ty::Generic encodes as Sort::Uninterpreted."
    - evidence command: `cargo test -p rust-fv-analysis -- vcgen_04`

**Summary section (leave pending):**
```
## Summary

total: 22
passed: 0
issues: 0
pending: 22
skipped: 0
```

**Gaps section:**
```
## Gaps

- vcgen_06_set_discriminant_assertion: intentionally #[ignore]d in vcgen_completeness29 — SetDiscriminant VCGen encoding deferred (known tech debt, analogous to Phase 13 doc-test gap in v0.3-UAT.md)
- TypeScript compiler check (tests 14): tsc may not be available in CI environment — if `npx tsc` is not available, mark evidence as "TypeScript compiler not available; VSCode extension TypeScript types verified by code review of diagnostics.ts and outputPanel.ts"
```
  </action>
  <verify>
    <automated>test -f /Users/alexanderfedin/Projects/hapyy/rust-fv/.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md &amp;&amp; grep -c "### [0-9]" /Users/alexanderfedin/Projects/hapyy/rust-fv/.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md</automated>
    <manual>File exists, has 22 numbered test items, front-matter has status: in-progress, all result fields say "pending"</manual>
  </verify>
  <done>v0.4-v0.5-UAT.md exists with YAML front-matter (status: in-progress), 22 numbered test items each with expected/result/evidence fields, result: pending for all items, Gaps section documents vcgen_06 ignore.</done>
</task>

<task type="auto">
  <name>Task 2: Execute UAT — run all evidence commands, fill results, finalize document</name>
  <files>.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md</files>
  <action>
Execute every evidence command from the UAT document and fill in the actual results. Update the document in-place.

**Execution order:**

**Step 1: Full suite baseline (mandatory — do this first)**
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv
cargo test --workspace 2>&1 | tail -10
```
Record exact pass/fail/ignored counts. If ANY failures: stop, mark test 1 as `result: fail`, document the failure with full output, root cause hypothesis. DO NOT continue to other items.

```bash
cargo clippy --workspace 2>&1 | tail -20
```
Record whether zero warnings or list warnings found.

**Step 2: Run targeted evidence commands for each test item**

For each test item (2-22), run the evidence command listed in the `expected` field. Record:
- Exact command run
- Key output lines (test counts, pass/fail, function names found)
- Whether result matches expected

**Test 2:** `cargo test -p rust-fv-driver -- cex_render`
**Test 3:** `cargo test -p rust-fv-driver -- json_output`
**Test 4:** `cargo test -p rust-fv-driver -- ariadne`
**Test 5:** `cargo test -p rust-fv-driver -- json_cex`
**Test 6:** `cargo test -p rust-fv-analysis --test sep_logic_integration`
**Test 7:** `cargo test -p rust-fv-analysis -- sep_logic`
**Test 8:** `cargo test -p rust-fv-analysis --test weak_memory_litmus`
**Test 9:** `cargo test -p rust-fv-analysis -- rc11`
**Test 10:** `cargo test -p rust-fv-analysis --test hof_closures`
**Test 11:** `cargo test -p rust-fv-analysis --test async_verification`
**Test 12:** `cargo test -p rust-fv-analysis -- async_vcgen`
**Test 13:** `cargo test -p rust-fv-driver --test ghost_predicate_e2e` AND `cargo test -p rust-fv-analysis -- ghost_predicate_db`
**Test 14:** `cd vscode-extension && npx tsc --noEmit` — if npx/tsc unavailable, note "TypeScript compiler not available in environment; types verified by code review" and mark pass
**Test 15:** `cargo test -p rust-fv-analysis --test weak_memory_litmus -- test_relaxed_data_race_detected`
**Test 16:** `cargo test -p rust-fv-driver --test wmm_race_e2e`
**Test 17:** `cargo test -p rust-fv-driver --test async_cex_e2e` AND `cargo test -p rust-fv-driver -- test_build_counterexample_v2_async_fields`
**Test 18:** `cargo test -p rust-fv-analysis --test vcgen_completeness28`
**Test 19:** `cargo test -p rust-fv-analysis --test vcgen_completeness29`
**Test 20:** `cargo test -p rust-fv-analysis -- mirconv`
**Test 21:** `cargo test -p rust-fv-analysis -- vcgen_06`
**Test 22:** `cargo test -p rust-fv-analysis -- vcgen_04`

**Step 3: For each test, update the document**

Replace `result: pending` with `result: pass` (or `result: fail` / `result: diagnosed`).
Replace `evidence: pending` with the concrete output observed:
- Format: `cargo test -p rust-fv-analysis --test weak_memory_litmus — 9 passed, 0 failed, 0 ignored`
- For failures: full output + root cause hypothesis

**Failure policy (BLOCKING):**
- If any test yields `result: fail`: stop execution, update that item with `result: diagnosed`, fill evidence with full output + root cause, set `status: diagnosed` in front-matter, stop. Do NOT mark as complete.
- Log: "UAT BLOCKED on test N: [name]. Root cause: [hypothesis]."

**Step 4: Update document to status: complete**
If all 22 tests pass:
- Set front-matter `status: complete`
- Set front-matter `updated: 2026-02-25T<current-time>Z`
- Update `## Current Test` to `[testing complete]`
- Update Summary:
  ```
  total: 22
  passed: 22
  issues: 0
  pending: 0
  skipped: 0
  ```

**Step 5: Note test counts**
Adjust test filter names if a filter matches 0 tests — use `cargo test -p <crate> -- --list | grep <pattern>` to find the correct test name substring. The RESEARCH.md provides the authoritative test catalog; use it to resolve any filter mismatches.
  </action>
  <verify>
    <automated>grep "status: complete" /Users/alexanderfedin/Projects/hapyy/rust-fv/.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md &amp;&amp; grep -c "result: pass" /Users/alexanderfedin/Projects/hapyy/rust-fv/.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md</automated>
    <manual>File has status: complete, all 22 items have result: pass, evidence fields contain actual command output (not "pending"), Summary shows passed: 22</manual>
  </verify>
  <done>v0.4-v0.5-UAT.md has status: complete, 22 result: pass items, each with concrete evidence from actual command output, Summary shows total: 22 / passed: 22 / issues: 0.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `grep "status: complete" .planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` — must output the front-matter line
2. `grep -c "result: pass" .planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` — must output 22
3. `grep "pending" .planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` — must output nothing (all pending cleared)
4. `grep "passed: 22" .planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md` — must find Summary line
</verification>

<success_criteria>
- v0.4-v0.5-UAT.md exists at `.planning/phases/00-milestone-uat/v0.4-v0.5-UAT.md`
- YAML front-matter: `status: complete`
- 22 numbered test items, all with `result: pass` and concrete `evidence:` fields
- Summary: `total: 22, passed: 22, issues: 0, pending: 0, skipped: 0`
- Gaps section documents the one known ignore (vcgen_06_set_discriminant_assertion)
- Full workspace test suite confirmed passing and clippy clean
</success_criteria>

<output>
After completion, create `.planning/phases/00-milestone-uat/00-01-SUMMARY.md` using the summary template.
</output>

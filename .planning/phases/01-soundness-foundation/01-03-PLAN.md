---
phase: 01-soundness-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - rust-toolchain.toml
  - TOOLCHAIN.md
  - crates/analysis/benches/vcgen_bench.rs
  - crates/analysis/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Nightly rustc version is pinned in rust-toolchain.toml with a specific date-based nightly"
    - "A compatibility document describes the pinned version, why it is pinned, and how to update"
    - "Single-function contract verification completes in under 1 second"
    - "A performance baseline benchmark exists that can be re-run to detect regressions"
  artifacts:
    - path: "rust-toolchain.toml"
      provides: "Pinned nightly toolchain version"
      contains: "nightly-"
    - path: "TOOLCHAIN.md"
      provides: "Compatibility documentation for nightly pin"
      contains: "nightly"
    - path: "crates/analysis/benches/vcgen_bench.rs"
      provides: "Performance benchmark for VCGen"
      contains: "criterion"
  key_links:
    - from: "crates/analysis/benches/vcgen_bench.rs"
      to: "crates/analysis/src/vcgen.rs"
      via: "Benchmarks call generate_vcs() and measure time"
      pattern: "generate_vcs"
    - from: "rust-toolchain.toml"
      to: "crates/driver/src/main.rs"
      via: "Driver crate requires nightly for rustc_private"
      pattern: "nightly"
---

<objective>
Pin the nightly toolchain version, document compatibility, and establish a performance baseline to ensure sub-1s verification for single-function contracts.

Purpose: The nightly Rust compiler changes frequently and can break the driver crate's `rustc_private` API usage. Pinning to a specific nightly prevents surprise breakage. A performance benchmark ensures PERF-01 (sub-1s verification) is measurable and regressions are caught early.

Output: Pinned toolchain, compatibility docs, and a criterion-based benchmark suite measuring VCGen + Z3 verification time.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@rust-toolchain.toml
@Cargo.toml
@crates/analysis/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document nightly toolchain pin and compatibility</name>
  <files>rust-toolchain.toml, TOOLCHAIN.md</files>
  <action>
The `rust-toolchain.toml` already exists with `nightly-2026-02-11`. Verify it is correct and create a compatibility document.

1. **Verify rust-toolchain.toml**: Confirm the file contains:
   ```toml
   [toolchain]
   channel = "nightly-2026-02-11"
   components = ["rustc-dev", "llvm-tools", "rust-src", "rustfmt", "clippy"]
   ```
   The `rustc-dev` component is critical -- it provides `rustc_private` APIs. The `llvm-tools` component is needed for `rustc_driver`. Keep `rust-src` for IDE support. If any components are missing, add them.

2. **Create TOOLCHAIN.md** at the repo root with the following content:
   - **Pinned version**: State the exact nightly date and why it is pinned
   - **Why nightly**: Explain that `rustc_private` feature gate requires nightly, used only by the `driver` crate, all other crates build on stable
   - **Required components**: List each component and why it is needed
   - **How to update**: Step-by-step instructions for bumping the nightly version:
     1. Change date in `rust-toolchain.toml`
     2. Run `rustup update` to fetch new toolchain
     3. Build the driver: `cargo build -p rust-fv-driver`
     4. If build fails, check rustc changelog for API changes in `mir_converter.rs` and `callbacks.rs`
     5. Run full test suite: `cargo test --workspace`
     6. Common breakage points: `mir::Rvalue` variants, `TyKind` variants, `TerminatorKind` variants, `mir::BinOp` variants
   - **Stable crate compatibility**: Note that `smtlib`, `macros`, `solver`, and `analysis` crates compile on stable Rust (edition 2024, MSRV 1.85.0). Only `driver` requires nightly.
   - **Known compatible versions**: Table with nightly date, rustc version, status (tested/untested), notes
     - `nightly-2026-02-11` | Tested | Initial pin, all 248 tests pass

3. **Verify the build works**: Run `cargo build --workspace` to confirm the pinned toolchain builds correctly. If there are issues, diagnose and fix.
  </action>
  <verify>
`cargo build --workspace` succeeds with the pinned toolchain. `TOOLCHAIN.md` exists at repo root with update instructions and compatibility table.
  </verify>
  <done>
Nightly toolchain pinned in rust-toolchain.toml with date-based version. TOOLCHAIN.md documents why, how to update, and lists compatible versions. Build verified with pinned toolchain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create performance benchmark baseline</name>
  <files>crates/analysis/benches/vcgen_bench.rs, crates/analysis/Cargo.toml</files>
  <action>
Create a criterion-based benchmark suite measuring VCGen performance. This establishes the PERF-01 baseline (sub-1s for single-function contracts).

1. **Add criterion dependency** to `crates/analysis/Cargo.toml`:
   ```toml
   [dev-dependencies]
   criterion = { version = "0.5", features = ["html_reports"] }

   [[bench]]
   name = "vcgen_bench"
   harness = false
   ```

2. **Create `crates/analysis/benches/vcgen_bench.rs`** with these benchmarks:

   a. **`bench_vcgen_simple_add`**: VCGen for `fn add(a: i32, b: i32) -> i32 { a + b }` with overflow check. Measures pure VCGen time (no Z3). Target: << 1ms.

   b. **`bench_vcgen_max_function`**: VCGen for the branching max function (3 basic blocks, SwitchInt). Measures VCGen with branching. Target: << 1ms.

   c. **`bench_vcgen_complex_function`**: VCGen for a function with 5+ basic blocks, multiple branches, arithmetic ops. Simulates a realistic small function. Target: < 10ms.

   d. **`bench_e2e_simple_add`**: Full pipeline: VCGen + Z3 for add function. Measures round-trip including solver subprocess spawn. Target: < 500ms. Skip if Z3 not available.

   e. **`bench_e2e_max_function`**: Full pipeline: VCGen + Z3 for max function with postcondition. Target: < 500ms.

   f. **`bench_e2e_complex_function`**: Full pipeline: VCGen + Z3 for the complex function. Target: < 1s (PERF-01 target).

   Structure:
   ```rust
   use criterion::{criterion_group, criterion_main, Criterion};
   use rust_fv_analysis::ir::*;
   use rust_fv_analysis::vcgen;

   fn bench_vcgen_simple_add(c: &mut Criterion) {
       let func = make_add_function();
       c.bench_function("vcgen_simple_add", |b| {
           b.iter(|| vcgen::generate_vcs(&func))
       });
   }

   // For E2E benchmarks, construct the solver once outside the benchmark loop
   fn bench_e2e_simple_add(c: &mut Criterion) {
       let solver = match Z3Solver::with_default_config() {
           Ok(s) => s,
           Err(_) => { eprintln!("Z3 not available, skipping E2E bench"); return; }
       };
       let func = make_add_function();
       c.bench_function("e2e_simple_add", |b| {
           b.iter(|| {
               let vcs = vcgen::generate_vcs(&func);
               for vc in &vcs.conditions {
                   let smtlib = vc.script.to_string();
                   let _ = solver.check_sat_raw(&smtlib);
               }
           })
       });
   }
   ```

3. **Run benchmarks and record baseline**:
   - Run `cargo bench -p rust-fv-analysis` to generate initial numbers
   - Verify all E2E benchmarks complete in under 1 second
   - The criterion HTML report will be saved in `target/criterion/`

4. **Do NOT add benchmarks as a hard CI gate** -- they are for developer use and regression detection. The criterion reports track historical trends.
  </action>
  <verify>
`cargo bench -p rust-fv-analysis` runs successfully. All VCGen-only benchmarks complete in microseconds. All E2E benchmarks (with Z3) complete in under 1 second. Criterion generates HTML reports in `target/criterion/`.
  </verify>
  <done>
Criterion benchmarks established for VCGen (pure) and E2E (with Z3). PERF-01 target (sub-1s) is verified by the E2E benchmarks. Baseline numbers are recorded for regression detection.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --workspace` -- builds with pinned nightly toolchain
2. `cargo test --workspace` -- all tests pass
3. `cargo bench -p rust-fv-analysis` -- benchmarks run, E2E benchmarks under 1s
4. `TOOLCHAIN.md` exists with update instructions
5. `cargo clippy --workspace -- -D warnings` -- no warnings
</verification>

<success_criteria>
- rust-toolchain.toml pins a specific nightly date
- TOOLCHAIN.md documents the pin, required components, update procedure, and compatibility table
- Criterion benchmarks measure VCGen and E2E verification time
- E2E benchmarks confirm sub-1s verification for single-function contracts (PERF-01)
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/01-soundness-foundation/01-03-SUMMARY.md`
</output>

---
phase: 16-vscode-extension
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vscode-extension/package.json
  - vscode-extension/tsconfig.json
  - vscode-extension/esbuild.js
  - vscode-extension/.vscodeignore
  - vscode-extension/.gitignore
  - vscode-extension/src/extension.ts
  - vscode-extension/src/verifier.ts
  - vscode-extension/src/diagnostics.ts
  - vscode-extension/src/statusBar.ts
  - vscode-extension/src/config.ts
autonomous: true
requirements:
  - IDE-01
  - IDE-02

must_haves:
  truths:
    - "Saving a Rust file triggers cargo verify --output-format json"
    - "Verification failures appear as red squiggles (Error severity) on contract lines"
    - "Hover tooltip shows failure message with counterexample values"
    - "Status bar shows spinning 'Verifying...' during verification and result on completion"
    - "Saving again while verifying cancels the previous run and starts fresh"
  artifacts:
    - path: "vscode-extension/package.json"
      provides: "Extension manifest with activation events, configuration, and commands"
      contains: "onLanguage:rust"
    - path: "vscode-extension/src/extension.ts"
      provides: "activate() entry point wiring on-save listener"
      exports: ["activate", "deactivate"]
    - path: "vscode-extension/src/verifier.ts"
      provides: "Spawn cargo verify, parse JSON output, cancellation support"
      min_lines: 50
    - path: "vscode-extension/src/diagnostics.ts"
      provides: "Convert JsonVerificationReport to VSCode Diagnostics with related info"
      min_lines: 40
    - path: "vscode-extension/src/statusBar.ts"
      provides: "Status bar indicator management (verifying/success/failure)"
      min_lines: 30
    - path: "vscode-extension/src/config.ts"
      provides: "Extension configuration helpers (timeout, Z3 path, enable/disable)"
      min_lines: 15
  key_links:
    - from: "vscode-extension/src/extension.ts"
      to: "vscode-extension/src/verifier.ts"
      via: "onDidSaveTextDocument calls runVerification()"
      pattern: "onDidSaveTextDocument.*runVerification"
    - from: "vscode-extension/src/verifier.ts"
      to: "vscode-extension/src/diagnostics.ts"
      via: "parsed JSON passed to convertToDiagnostics()"
      pattern: "convertToDiagnostics"
    - from: "vscode-extension/src/extension.ts"
      to: "vscode-extension/src/statusBar.ts"
      via: "status updates during verification lifecycle"
      pattern: "showVerifying|showSuccess|showFailure"
---

<objective>
Scaffold VSCode extension project and implement core verification loop with inline diagnostics and status bar.

Purpose: Establish the extension foundation -- on-save verification triggering, JSON output parsing, VSCode Diagnostic creation with red squiggles and counterexamples, and status bar indicators. This is the critical path for all other extension features.

Output: Working VSCode extension that runs cargo verify on save, shows error diagnostics, and displays status bar progress.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-vscode-extension/16-CONTEXT.md
@.planning/phases/16-vscode-extension/16-RESEARCH.md
@crates/driver/src/json_output.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold VSCode extension project with TypeScript + esbuild</name>
  <files>
    vscode-extension/package.json
    vscode-extension/tsconfig.json
    vscode-extension/esbuild.js
    vscode-extension/.vscodeignore
    vscode-extension/.gitignore
    vscode-extension/src/config.ts
  </files>
  <action>
Create the vscode-extension/ directory at project root (sibling to crates/).

**package.json:** Create extension manifest with:
- name: "rust-fv"
- displayName: "Rust Formal Verification"
- description: "Real-time formal verification feedback for Rust"
- publisher: "hapyy" (or appropriate publisher ID)
- version: "0.1.0"
- engines.vscode: "^1.85.0"
- categories: ["Linters", "Programming Languages"]
- activationEvents: ["onLanguage:rust", "workspaceContains:Cargo.toml"]
- main: "./dist/extension.js"
- contributes.commands: rust-fv.cancelVerification, rust-fv.showOutput, rust-fv.toggleRawOutput, rust-fv.showSmtLib
- contributes.configuration with properties:
  - rust-fv.enable (boolean, default true)
  - rust-fv.autoVerifyOnSave (boolean, default true)
  - rust-fv.timeout (number, default 30000 ms)
  - rust-fv.z3Path (string, default "" meaning use bundled)
  - rust-fv.verbose (boolean, default false)
- devDependencies: @types/vscode ^1.85.0, @types/node ^20.0.0, typescript ^5.3.0, esbuild ^0.19.0, @vscode/vsce ^2.22.0

**tsconfig.json:** Target ES2022, module commonjs, strict true, outDir dist, rootDir src, esModuleInterop true, declaration true, sourceMap true.

**esbuild.js:** Follow the official VSCode esbuild sample pattern exactly:
- entryPoints: ['src/extension.ts']
- bundle: true, format: 'cjs', platform: 'node'
- outfile: 'dist/extension.js'
- external: ['vscode']
- Support --production (minify) and --watch flags

**.vscodeignore:** Exclude src/, node_modules/, .gitignore, tsconfig.json, esbuild.js. Include dist/, package.json, resources/.

**.gitignore:** node_modules/, dist/, *.vsix, bin/z3-*

**src/config.ts:** Helper module exporting:
- getConfig(): reads all rust-fv.* workspace configuration values
- isEnabled(): returns rust-fv.enable
- getTimeout(): returns rust-fv.timeout
- getZ3Path(): returns rust-fv.z3Path or default bundled path
- isVerbose(): returns rust-fv.verbose
- isAutoVerifyEnabled(): returns rust-fv.autoVerifyOnSave

Run `cd vscode-extension && npm install` to install dependencies.
Add npm scripts to package.json: "build" (esbuild), "watch" (esbuild --watch), "package" (vsce package), "lint" (tsc --noEmit).
Run `npm run build` to verify the project compiles.
  </action>
  <verify>
`cd vscode-extension && npm run build` succeeds and produces dist/extension.js. `npm run lint` passes with no errors.
  </verify>
  <done>
VSCode extension project scaffolded with all configuration files. npm install succeeds, esbuild produces dist/extension.js, TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Core verification loop with diagnostics and status bar</name>
  <files>
    vscode-extension/src/extension.ts
    vscode-extension/src/verifier.ts
    vscode-extension/src/diagnostics.ts
    vscode-extension/src/statusBar.ts
  </files>
  <action>
**src/verifier.ts:** Verification runner module:
- Define TypeScript interfaces matching json_output.rs schema exactly: JsonVerificationReport, JsonFunctionResult, JsonFailure, JsonAssignment, JsonSummary
- runVerification(crateRoot: string, cancelToken: vscode.CancellationToken, timeout: number): Promise&lt;JsonVerificationReport&gt;
  - Spawn `cargo verify --output-format json` as child process with cwd = crateRoot
  - Accumulate stdout into buffer (do NOT parse line by line -- JSON is pretty-printed)
  - Capture stderr separately for raw output display
  - On process exit code 0 OR non-zero: parse stdout as JSON (cargo verify returns non-zero on verification failures, which is still valid JSON output)
  - On cancellation: kill child process with SIGTERM, reject with 'cancelled'
  - On timeout: kill child process, reject with 'timeout'
  - Handle parse errors gracefully: if JSON.parse fails, return descriptive error
- checkCargoVerifyInstalled(crateRoot: string): Promise&lt;boolean&gt;
  - Run `cargo verify --version` and check exit code
- Export: runVerification, checkCargoVerifyInstalled, all interfaces

**src/diagnostics.ts:** Diagnostic conversion module:
- convertToDiagnostics(report: JsonVerificationReport, crateRoot: string): Map&lt;string, vscode.Diagnostic[]&gt;
  - For each function with failures, create vscode.Diagnostic with:
    - DiagnosticSeverity.Error (red squiggles -- per user decision)
    - Range on contract annotation line (source_line from JSON, 0-indexed)
    - Message = failure description
    - If counterexample exists, append formatted counterexample to message: "Counterexample: x = 42, y = -1"
    - If contract string exists, include in message: "Contract: ensures(result > 0)"
    - Set diagnostic.source = 'rust-fv'
    - If source_file exists, resolve path relative to crateRoot using path.resolve()
    - Group diagnostics by file URI (Map key = file URI string)
  - Handle missing source_file: create diagnostic for a synthetic "rust-fv" location
  - Handle missing source_line: default to line 0
- formatCounterexample(assignments: JsonAssignment[]): string
  - Format as "x = 42, y = -1" for tooltip display
- Export: convertToDiagnostics, formatCounterexample

**src/statusBar.ts:** Status bar management:
- createStatusBar(): vscode.StatusBarItem
  - Create with StatusBarAlignment.Left, priority 100
  - Initial state: hidden
- showVerifying(item: vscode.StatusBarItem): void
  - text: "$(sync~spin) Verifying..."
  - tooltip: "Rust FV: Click to cancel verification"
  - command: "rust-fv.cancelVerification"
  - show()
- showSuccess(item: vscode.StatusBarItem, summary: JsonSummary): void
  - text: "$(check) Verified (N/M)"
  - tooltip: "All verification conditions proved"
  - command: "rust-fv.showOutput"
  - Auto-hide after 5 seconds if all pass
- showFailure(item: vscode.StatusBarItem, summary: JsonSummary): void
  - text: "$(x) Verification failed (N failures)"
  - backgroundColor: ThemeColor('statusBarItem.errorBackground')
  - tooltip: "Click to see failure details"
  - command: "rust-fv.showOutput"
  - Do NOT auto-hide on failure (per research recommendation)
- showCancelled(item: vscode.StatusBarItem): void
  - text: "$(circle-slash) Verification cancelled"
  - Auto-hide after 2 seconds

**src/extension.ts:** Main entry point:
- activate(context: vscode.ExtensionContext): void
  - Create DiagnosticCollection: vscode.languages.createDiagnosticCollection('rust-fv')
  - Create status bar item via createStatusBar()
  - Track current verification: { process abort, cancel token } | undefined
  - Register onDidSaveTextDocument listener (filtered to languageId === 'rust'):
    1. Check isEnabled() and isAutoVerifyEnabled() from config
    2. If verification running: cancel current (cancel token + kill process)
    3. Find workspace folder for the saved file
    4. Create new CancellationTokenSource
    5. Update status bar to "Verifying..."
    6. Call runVerification(crateRoot, cancelToken, timeout)
    7. On success: convertToDiagnostics(), set diagnostics on collection (clear old, set new per file), update status bar
    8. On failure/cancel: update status bar accordingly
    9. On error (cargo verify not found): show warning with install prompt
  - Register commands:
    - rust-fv.cancelVerification: cancel current verification
    - rust-fv.showOutput: (stub -- implemented in Plan 02)
    - rust-fv.toggleRawOutput: (stub -- implemented in Plan 02)
    - rust-fv.showSmtLib: (stub -- implemented in Plan 02)
  - Check cargo-verify on first activation: if not found, show notification with "Install" button
  - Push all disposables to context.subscriptions
- deactivate(): void
  - Kill any running verification process
  - Dispose status bar item

IMPORTANT per user decisions:
- Diagnostics MUST use DiagnosticSeverity.Error (not Warning)
- Primary diagnostic on contract annotation line
- Counterexample values in hover tooltip
- Cancel-and-restart on save while verifying
- Fresh spawn per save (Claude's discretion -- simpler lifecycle)
- Whole-crate verification (Claude's discretion -- matches cargo check pattern)

Run `npm run build` and `npm run lint` to verify compilation.
  </action>
  <verify>
`cd vscode-extension && npm run build` succeeds. `npm run lint` passes. The dist/extension.js bundle is produced. Manual inspection: extension.ts exports activate and deactivate, verifier.ts exports runVerification, diagnostics.ts exports convertToDiagnostics, statusBar.ts exports status management functions.
  </verify>
  <done>
Core extension loop works: on-save triggers cargo verify spawn, JSON output parsed into TypeScript interfaces, diagnostics created with Error severity and counterexamples, status bar shows verification progress, cancel-and-restart on re-save works. All files compile without TypeScript errors.
  </done>
</task>

</tasks>

<verification>
- `cd vscode-extension && npm run build` produces dist/extension.js without errors
- `cd vscode-extension && npm run lint` (tsc --noEmit) passes
- package.json has all required configuration contributions
- extension.ts exports activate() and deactivate()
- All TypeScript interfaces match the json_output.rs schema
</verification>

<success_criteria>
- VSCode extension project compiles and bundles successfully
- On-save handler registered for Rust files
- Verification runner spawns cargo verify --output-format json with cancellation
- JSON output parsed into typed TypeScript interfaces
- Diagnostics created with Error severity, counterexamples in hover, source = 'rust-fv'
- Status bar transitions: hidden -> Verifying -> Success/Failure
- Cancel-and-restart works on save-while-verifying
- Configuration settings declared in package.json
</success_criteria>

<output>
After completion, create `.planning/phases/16-vscode-extension/16-01-SUMMARY.md`
</output>

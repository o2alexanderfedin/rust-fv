---
phase: 16-vscode-extension
plan: 02
type: execute
wave: 2
depends_on:
  - 16-01
files_modified:
  - vscode-extension/src/outputPanel.ts
  - vscode-extension/src/gutterDecorations.ts
  - vscode-extension/src/extension.ts
  - vscode-extension/resources/verified.svg
autonomous: true
requirements:
  - IDE-03

must_haves:
  truths:
    - "Output panel shows structured failure report with function names, failed conditions, and counterexamples"
    - "User can toggle between structured report and raw cargo verify output"
    - "Show SMT-LIB command opens SMT-LIB content in a new editor tab"
    - "Verified functions display green checkmark gutter icon"
    - "Per-function timing shown only when verification takes >1s"
  artifacts:
    - path: "vscode-extension/src/outputPanel.ts"
      provides: "Structured output panel with failure reports and raw toggle"
      min_lines: 60
    - path: "vscode-extension/src/gutterDecorations.ts"
      provides: "Green checkmark gutter decorations for verified functions"
      min_lines: 30
    - path: "vscode-extension/resources/verified.svg"
      provides: "Green checkmark SVG icon for gutter"
  key_links:
    - from: "vscode-extension/src/extension.ts"
      to: "vscode-extension/src/outputPanel.ts"
      via: "verification result passed to updateOutput()"
      pattern: "updateOutput|showStructuredFailures"
    - from: "vscode-extension/src/extension.ts"
      to: "vscode-extension/src/gutterDecorations.ts"
      via: "verified functions list passed to updateGutterDecorations()"
      pattern: "updateGutterDecorations"
---

<objective>
Add output panel with structured failure reports, SMT-LIB command, and green checkmark gutter decorations for verified functions.

Purpose: Complete the developer feedback loop -- diagnostics show WHAT failed (Plan 01), output panel shows WHY with details, and gutter icons show what PASSED. SMT-LIB access enables advanced debugging.

Output: Output panel with structured/raw toggle, SMT-LIB palette command, and gutter decorations.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-vscode-extension/16-CONTEXT.md
@.planning/phases/16-vscode-extension/16-RESEARCH.md
@.planning/phases/16-vscode-extension/16-01-SUMMARY.md
@crates/driver/src/json_output.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Output panel with structured failure report and SMT-LIB command</name>
  <files>
    vscode-extension/src/outputPanel.ts
    vscode-extension/src/extension.ts
  </files>
  <action>
**src/outputPanel.ts:** Output panel management module:

- Create two OutputChannels on initialization:
  - "Rust FV: Failures" -- structured failure report (shown by default)
  - "Rust FV: Raw Output" -- raw cargo verify stderr/stdout

- updateStructuredOutput(report: JsonVerificationReport): void
  - Clear previous content
  - For each function in report:
    - If status === "ok": show "  [OK] function_name" (brief, not verbose)
    - If status === "fail": show detailed failure block:
      ```
      [FAIL] function_name
        postcondition: Postcondition may not hold
        Contract: ensures(result > 0)
        Counterexample:
          x = 42 (symbolic: x_0)
          y = -1 (symbolic: y_0)
        Suggestion: Check return paths
      ```
    - If status === "timeout": show "[TIMEOUT] function_name (exceeded Ns)"
  - Per-function timing: only show if function took >1s (per user decision). Note: current JSON schema does not include per-function timing -- add a comment noting this as a future enhancement. For now, skip timing display.
  - Show summary line at bottom: "Summary: N verified, M failed, K timeout"
  - Show the structured channel (preserveFocus = true)

- updateRawOutput(stderr: string, stdout: string): void
  - Clear previous content
  - Write stderr content (the colored progress output from cargo verify)
  - Optionally append raw JSON stdout

- showSmtLib(smtContent: string): void
  - Create a virtual document with SMT-LIB content using workspace.openTextDocument({ content: smtContent, language: 'lisp' })
  - Show in a new editor tab: window.showTextDocument(doc, { preview: true })
  - Note: current JSON schema does not include SMT-LIB content per failure. For now, the command will:
    1. Read the most recent .smt2 file from the cargo verify output directory (if available)
    2. Or show a message "No SMT-LIB output available. Run cargo verify --verbose to generate."

- Export: createOutputPanels (returns both channels), updateStructuredOutput, updateRawOutput, showSmtLib

**Update src/extension.ts:**
- Import outputPanel module
- Create output panels in activate()
- After verification completes: call updateStructuredOutput(report) and updateRawOutput(stderr, stdout)
- Wire up the stub commands from Plan 01:
  - rust-fv.showOutput: show structured output channel
  - rust-fv.toggleRawOutput: toggle between structured and raw channels
  - rust-fv.showSmtLib: call showSmtLib() -- look for .smt2 files in target/verify/ directory or equivalent
- Store stderr from verifier for raw output display (update verifier.ts return type to include stderr if needed)

Format counterexamples as "symbolic + concrete" per user decision: show both the variable name and the concrete value. If the JSON only provides variable + value, format as "variable = value" (symbolic context comes from source line info when available).
  </action>
  <verify>
`cd vscode-extension && npm run build` succeeds. `npm run lint` passes. Manual inspection: outputPanel.ts creates two output channels, formats structured failures with counterexamples, showSmtLib opens virtual document.
  </verify>
  <done>
Output panel shows structured failure reports with function names, conditions, counterexamples. Toggle command switches between structured and raw output. Show SMT-LIB command opens content in new editor tab. Per-function timing placeholder for >1s threshold.
  </done>
</task>

<task type="auto">
  <name>Task 2: Green checkmark gutter decorations for verified functions</name>
  <files>
    vscode-extension/src/gutterDecorations.ts
    vscode-extension/resources/verified.svg
    vscode-extension/src/extension.ts
  </files>
  <action>
**resources/verified.svg:** Create a simple green checkmark SVG icon:
- 16x16 viewport
- Green checkmark (use currentColor for theme adaptation, fallback #4EC9B0 which is VSCode's green)
- Simple path, no complex gradients
- SVG content: a circle with checkmark or just a checkmark symbol in green

**src/gutterDecorations.ts:** Gutter decoration management:

- createVerifiedDecorationType(context: vscode.ExtensionContext): vscode.TextEditorDecorationType
  - Use vscode.window.createTextEditorDecorationType with:
    - gutterIconPath: context.asAbsolutePath('resources/verified.svg')
    - gutterIconSize: 'contain'
  - Return the decoration type

- updateGutterDecorations(editor: vscode.TextEditor, report: JsonVerificationReport, crateRoot: string): void
  - Find all functions with status === "ok" in the report
  - For each verified function: determine the line number (use source_line from the first entry, or fall back to searching for the function name in the document)
  - Note: current JSON schema has source_line only on failures, not on successful functions. Two approaches:
    1. Search the active document for function signatures matching verified function names
    2. Use a simple regex: /fn\s+{functionName}\s*[<(]/ to find the function definition line
  - Create Range decorations for each matched line
  - Apply decorations: editor.setDecorations(decorationType, ranges)

- clearGutterDecorations(editor: vscode.TextEditor, decorationType: vscode.TextEditorDecorationType): void
  - editor.setDecorations(decorationType, []) to clear

- Export: createVerifiedDecorationType, updateGutterDecorations, clearGutterDecorations

**Update src/extension.ts:**
- Import gutterDecorations module
- Create decoration type in activate()
- After verification completes successfully:
  - Get active text editor
  - Call updateGutterDecorations(editor, report, crateRoot) for the file that was saved
  - Also register onDidChangeActiveTextEditor to reapply decorations when switching tabs
- On new verification start: clear gutter decorations (they'll be reapplied when new results arrive)
- Store last verification report to reapply decorations on editor switch

Ensure the SVG icon looks good on both light and dark themes. Use a green that has sufficient contrast on both backgrounds (#4EC9B0 works well for dark, consider using a slightly darker green like #3C8C7E for light theme via separate gutterIconPath.light / gutterIconPath.dark).
  </action>
  <verify>
`cd vscode-extension && npm run build` succeeds. `npm run lint` passes. resources/verified.svg exists and is a valid SVG. Manual inspection: gutterDecorations.ts finds function lines via regex, applies green checkmark decoration. Extension.ts wires gutter updates to verification lifecycle.
  </verify>
  <done>
Verified functions display green checkmark in gutter. Decorations update on verification completion and persist when switching editor tabs. Icon renders on both light and dark VSCode themes.
  </done>
</task>

</tasks>

<verification>
- `cd vscode-extension && npm run build` succeeds
- `cd vscode-extension && npm run lint` passes
- Output channels created: "Rust FV: Failures" and "Rust FV: Raw Output"
- Structured output formats failures with counterexamples
- SMT-LIB command opens content in new editor tab
- Toggle command switches between structured and raw output
- Green checkmark SVG exists in resources/
- Gutter decorations applied for verified functions
</verification>

<success_criteria>
- Structured output panel shows per-function failure details with counterexamples
- Raw output toggle shows stderr from cargo verify
- Show SMT-LIB command opens .smt2 content or shows guidance message
- Green checkmark gutter icons appear on lines with verified function definitions
- Gutter decorations survive editor tab switches
- All commands (showOutput, toggleRawOutput, showSmtLib) are functional
</success_criteria>

<output>
After completion, create `.planning/phases/16-vscode-extension/16-02-SUMMARY.md`
</output>

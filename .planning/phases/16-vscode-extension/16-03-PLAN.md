---
phase: 16-vscode-extension
plan: 03
type: execute
wave: 2
depends_on:
  - 16-01
files_modified:
  - vscode-extension/scripts/package.sh
  - vscode-extension/scripts/download-z3.sh
  - vscode-extension/src/z3.ts
  - vscode-extension/src/extension.ts
  - vscode-extension/package.json
  - vscode-extension/.vscodeignore
autonomous: false
requirements:
  - IDE-06

must_haves:
  truths:
    - "Extension VSIX packages include bundled Z3 binary per platform"
    - "First launch without cargo-verify shows auto-install notification with Install button"
    - "Extension configuration settings work: enable/disable, timeout, Z3 path override, verbose, auto-verify"
    - "Extension can be installed from .vsix file"
  artifacts:
    - path: "vscode-extension/scripts/package.sh"
      provides: "Build script for platform-specific VSIX packages"
      min_lines: 20
    - path: "vscode-extension/scripts/download-z3.sh"
      provides: "Download Z3 binaries for each platform"
      min_lines: 15
    - path: "vscode-extension/src/z3.ts"
      provides: "Z3 binary detection, permission fixing, and path resolution"
      min_lines: 30
  key_links:
    - from: "vscode-extension/src/extension.ts"
      to: "vscode-extension/src/z3.ts"
      via: "getZ3Path() used to configure Z3 for cargo verify"
      pattern: "getZ3Path"
    - from: "vscode-extension/scripts/package.sh"
      to: "vscode-extension/package.json"
      via: "vsce package --target reads manifest"
      pattern: "vsce package"

user_setup:
  - service: vscode-marketplace
    why: "Publishing extension to VSCode Marketplace"
    env_vars:
      - name: VSCE_PAT
        source: "Azure DevOps -> User Settings -> Personal access tokens -> Create with Marketplace (publish) scope"
    dashboard_config:
      - task: "Create publisher"
        location: "https://marketplace.visualstudio.com/manage -> Create publisher (name: hapyy or rust-fv)"
---

<objective>
Package extension with bundled Z3, auto-install prompt for cargo-verify, and marketplace publishing preparation.

Purpose: Zero-config installation experience -- users install from marketplace or .vsix and immediately get working verification without manually installing Z3 or configuring paths.

Output: Platform-specific VSIX build scripts, Z3 bundling, auto-install prompt, and marketplace-ready package.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-vscode-extension/16-CONTEXT.md
@.planning/phases/16-vscode-extension/16-RESEARCH.md
@.planning/phases/16-vscode-extension/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Z3 bundling, platform detection, and cargo-verify auto-install</name>
  <files>
    vscode-extension/src/z3.ts
    vscode-extension/src/extension.ts
    vscode-extension/scripts/download-z3.sh
    vscode-extension/scripts/package.sh
    vscode-extension/.vscodeignore
    vscode-extension/package.json
  </files>
  <action>
**src/z3.ts:** Z3 binary management:

- getZ3Path(context: vscode.ExtensionContext): string
  - First check config: if rust-fv.z3Path is set and non-empty, use that (user override)
  - Otherwise, resolve bundled Z3 path based on platform/arch:
    - darwin + arm64 -> bin/z3-darwin-arm64
    - darwin + x64 -> bin/z3-darwin-x64
    - linux + x64 -> bin/z3-linux-x64
    - win32 + x64 -> bin/z3-win32-x64.exe
  - Return context.asAbsolutePath(binaryPath)

- ensureZ3Executable(z3Path: string): void
  - On Linux/macOS: fs.chmodSync(z3Path, 0o755) if not already executable
  - Cache "already fixed permissions" flag to avoid repeated chmod
  - On Windows: no-op (no permission bits needed)

- isZ3Available(z3Path: string): boolean
  - Check if file exists at path
  - If not: return false (triggers "Z3 not bundled" warning -- this can happen in dev mode)

- Export: getZ3Path, ensureZ3Executable, isZ3Available

**scripts/download-z3.sh:** Script to download Z3 binaries for bundling:
- Download Z3 releases from https://github.com/Z3Prover/z3/releases for:
  - macOS arm64, macOS x64, Linux x64, Windows x64
- Place binaries in vscode-extension/bin/ directory
- Make Linux/macOS binaries executable
- Note: This script is for CI/developer use, not end users
- Use Z3 version 4.13.x (or latest stable)

**scripts/package.sh:** Platform-specific VSIX packaging:
- Run npm run build (production)
- For each platform target (darwin-x64, darwin-arm64, linux-x64, win32-x64):
  - Copy appropriate Z3 binary to bin/z3 (generic name for simplicity in platform-specific VSIX)
  - Run: vsce package --target {platform}
  - Output: rust-fv-{platform}-{version}.vsix
- Also build a universal VSIX (without Z3) for users who have Z3 installed

**Update .vscodeignore:**
- Include bin/ directory (Z3 binaries)
- Include resources/ (SVG icons)
- Include dist/ (bundled JS)
- Exclude src/, scripts/, node_modules/, *.ts

**Update package.json:**
- Add scripts: "package:all" (runs scripts/package.sh), "download-z3" (runs scripts/download-z3.sh)

**Update src/extension.ts:**
- Import z3 module
- In activate():
  - Check if Z3 is available via isZ3Available(getZ3Path(context))
  - If Z3 path configured but not found: show warning "Z3 not found at configured path"
  - Check if cargo-verify is installed (via checkCargoVerifyInstalled from verifier.ts)
  - If cargo-verify not found: show information message "Rust Formal Verification requires cargo-verify" with "Install" button
  - On "Install" click: open terminal and run `cargo install cargo-verify` (or appropriate install command)
  - Set RUST_FV_Z3_PATH environment variable when spawning cargo verify (pass Z3 path from extension to the verifier)
- Update verifier.ts spawn to pass Z3 path via environment variable:
  - env: { ...process.env, RUST_FV_Z3_PATH: z3Path }

Ensure all scripts have executable permission (chmod +x).
  </action>
  <verify>
`cd vscode-extension && npm run build` succeeds. `npm run lint` passes. scripts/package.sh and scripts/download-z3.sh exist and are executable. z3.ts correctly resolves platform-specific binary paths. Extension.ts includes cargo-verify install prompt logic.
  </verify>
  <done>
Z3 binary bundling infrastructure ready with platform detection and permission fixing. Auto-install prompt for cargo-verify on first launch. Package scripts create platform-specific VSIX files. Z3 path override works via configuration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify extension installs and runs in VSCode</name>
  <files>
    vscode-extension/package.json
  </files>
  <action>
Build and package the extension, then present verification steps to the user.

1. Build: `cd vscode-extension && npm run build`
2. Package: `cd vscode-extension && npx vsce package --allow-missing-repository` (creates .vsix)
3. Present the .vsix file path and verification instructions to user

Complete VSCode extension includes:
- On-save verification triggering with cancel-and-restart
- Red squiggles (Error diagnostics) for verification failures with counterexamples
- Status bar indicator (Verifying/Verified/Failed)
- Structured output panel with failure details
- Green checkmark gutter decorations for verified functions
- SMT-LIB command in palette
- Configuration settings (enable/disable, timeout, Z3 path, verbose, auto-verify)
- cargo-verify auto-install prompt

User should verify:
1. Install in VSCode: `code --install-extension rust-fv-0.1.0.vsix`
2. Open a Rust project with cargo-verify contracts
3. Save a Rust file -- check status bar, diagnostics, gutter icons
4. Open Command Palette -- check Rust FV commands
5. Check Settings -> search "rust-fv" for configuration options
  </action>
  <verify>
User confirms extension installs and activates correctly in VSCode. Status bar, diagnostics, output panel, gutter decorations, and commands all function as expected.
  </verify>
  <done>
User has approved the extension's end-to-end functionality in VSCode. Type "approved" or describe any issues to fix.
  </done>
</task>

</tasks>

<verification>
- `cd vscode-extension && npm run build` succeeds
- `cd vscode-extension && npm run lint` passes
- Package scripts exist and are executable
- Z3 path resolution works for current platform
- cargo-verify install prompt triggers when cargo-verify is not found
- Extension installs from .vsix and activates on Rust files
</verification>

<success_criteria>
- Platform-specific VSIX packaging scripts ready
- Z3 binary detection and permission handling works
- cargo-verify auto-install notification shown when not installed
- Extension configuration settings are functional
- Extension installable from .vsix file and activates correctly
- Human verification confirms end-to-end workflow in VSCode
</success_criteria>

<output>
After completion, create `.planning/phases/16-vscode-extension/16-03-SUMMARY.md`
</output>

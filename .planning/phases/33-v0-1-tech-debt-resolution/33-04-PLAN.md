---
phase: 33-v0-1-tech-debt-resolution
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/analysis/tests/trigger_integration.rs
  - .planning/phases/15-trigger-customization/15-VERIFICATION.md
autonomous: true
requirements:
  - PERF-03
  - PERF-04
must_haves:
  truths:
    - "9 new tests in trigger_integration.rs covering trigger/quantifier schema edge cases all pass"
    - "Phase 15 DEBTLINES removed — VERIFICATION.md updated to reflect edge cases are now tested"
    - "No regressions in the existing 17 trigger_integration.rs tests"
  artifacts:
    - path: "crates/analysis/tests/trigger_integration.rs"
      provides: "9 new edge case tests for trigger/quantifier interaction"
      contains: "test_nested_quantifier_triggers"
    - path: ".planning/phases/15-trigger-customization/15-VERIFICATION.md"
      provides: "Updated status with DEBTLINES removed"
  key_links:
    - from: "crates/analysis/tests/trigger_integration.rs"
      to: "crates/analysis/src/encode_quantifier.rs"
      via: "annotate_quantifier called with TriggerHint"
      pattern: "annotate_quantifier"
    - from: "crates/analysis/tests/trigger_integration.rs"
      to: "crates/analysis/src/trigger_validation.rs"
      via: "TriggerValidator used for edge case validation"
      pattern: "TriggerValidationError"
---

<objective>
Add 9 targeted E2E tests to `trigger_integration.rs` covering the trigger/quantifier schema edge cases documented as tech debt in the v0.1 milestone audit. If any tests expose bugs in trigger validation or quantifier annotation, fix them.

Purpose: Close the Phase 15 tech debt item by providing test coverage for the 9 DEBTLINE scenarios in trigger/quantifier schema interaction — particularly the known limitation "No E2E test with actual Rust code" through the full pipeline.

Output: 9 new passing tests, DEBTLINES removed from 15-VERIFICATION.md.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-trigger-customization/15-VERIFICATION.md

<interfaces>
<!-- Existing test pattern from crates/analysis/tests/trigger_integration.rs -->
```rust
// Existing test pattern (from 15-VERIFICATION.md):
use rust_fv_analysis::encode_quantifier::{annotate_quantifier, extract_manual_triggers};
use rust_fv_analysis::trigger_validation::{TriggerValidator, TriggerValidationError};
use rust_fv_smtlib::term::{Term, Sort};

// Typical test structure:
#[test]
fn test_manual_trigger_single_annotation() {
    let trigger = Term::App("f".into(), vec![Term::Const("x".into())]);
    let body = Term::Forall(
        vec![("x".into(), Sort::Int)],
        Box::new(Term::App("P".into(), vec![Term::Const("x".into())]))
    );
    let result = annotate_quantifier(body, Some(vec![vec![trigger]]));
    assert!(result.is_ok());
}

// Error test pattern:
#[test]
fn test_error_interpreted_symbol_arithmetic() {
    let trigger = Term::IntAdd(
        Box::new(Term::Const("x".into())),
        Box::new(Term::IntLit(1))
    );
    let result = TriggerValidator::new().validate(&[vec![trigger.clone()]], &["x"]);
    assert!(matches!(result, Err(TriggerValidationError::InterpretedSymbol { .. })));
}
```
</interfaces>
</context>

<feature>
  <name>Trigger/quantifier edge case tests</name>
  <files>crates/analysis/tests/trigger_integration.rs</files>
  <behavior>
    9 edge case scenarios covering trigger/quantifier interaction:

    1. test_nested_quantifier_triggers — `forall x, forall y, trigger(f(x, y))` — cross-scope trigger binding both x and y → should succeed (both vars covered)
    2. test_trigger_with_struct_selector — trigger is `Term::App("Point-x", [x])` (struct field selector) — should validate or warn about selector triggers
    3. test_trigger_in_exists_with_shadowed_var — exists quantifier with trigger where bound var name shadows outer scope → should handle without confusing scopes
    4. test_overlapping_multiple_triggers — two trigger sets that share a sub-term: `[f(x), g(x)]` where g contains f as sub-expression → should accept (non-conflicting)
    5. test_trigger_on_arithmetic_result_as_arg — `trigger(h(x + 0))` where `x + 0` is the argument — the arithmetic is inside the trigger arg, not the trigger function itself → behavior test (may warn or pass)
    6. test_trigger_outer_scope_variable — trigger in inner forall references variable from outer forall scope → should validate correctly (outer var not in inner quantifier's var list)
    7. test_trigger_on_recursive_function_application — `trigger(f(g(x)))` — two-level application → should accept (f is the outermost function, not self-instantiating)
    8. test_missing_variable_in_multi_trigger_set — trigger set `[f(x)]` but quantifier binds both x and y — incomplete coverage → should return TriggerValidationError::IncompleteCoverage
    9. test_e2e_trigger_through_spec_parser — Parse a spec string `"forall |x: i64| #[trigger(is_prime(x))] is_prime(x) ==> x > 1"` through `spec_parser::parse_spec_expr` → confirms triggers survive full parse pipeline (this is the "No E2E with real Rust code" gap from 15-VERIFICATION.md)

    For each test: construct the Term/quantifier structure, call annotate_quantifier or TriggerValidator::validate, assert expected outcome (Ok, specific Err variant, or specific term structure in output).
  </behavior>
  <implementation>
    TDD approach:
    RED — Write all 9 tests. Most should expose current behavior (not necessarily bugs). Run and note which fail.
    GREEN — Fix any genuine bugs exposed. For tests that document current limitation behavior (e.g., test 9 may require spec_parser integration), implement the minimal fix needed.
    REFACTOR — None expected (9 small, independent tests).
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: TDD RED — Write 9 edge case tests (append to trigger_integration.rs)</name>
  <files>crates/analysis/tests/trigger_integration.rs</files>
  <action>
    Read the existing trigger_integration.rs first to understand exact imports, helper patterns, and avoid name collisions:
    ```bash
    head -50 /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/analysis/tests/trigger_integration.rs
    grep -n "^fn test_\|^pub fn test_" /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/analysis/tests/trigger_integration.rs
    ```

    Append 9 new test functions to the file using the existing `annotate_quantifier` and `TriggerValidator::new().validate()` pattern.

    For test 9 (spec_parser E2E): check what spec_parser exports that can be called from tests:
    ```bash
    grep -n "pub fn\|pub struct" /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/analysis/src/spec_parser.rs | head -20
    ```
    If the spec_parser can parse a trigger annotation in a spec string and produce a Term with TriggerHint, write the test using that API. If not, write the test to call `parse_spec_expr` and assert the output contains a Forall with trigger hints.

    Run after writing:
    ```bash
    cargo test -p rust-fv-analysis --test trigger_integration 2>&1 | tail -20
    ```
    Note which tests fail.
  </action>
  <verify>
    <automated>cargo test -p rust-fv-analysis --test trigger_integration 2>&1 | grep -E "test result|FAILED|error\[" | head -10</automated>
  </verify>
  <done>9 new test functions added to trigger_integration.rs. Tests compile. Some may fail RED — expected.</done>
</task>

<task type="auto">
  <name>Task 2: TDD GREEN + update VERIFICATION.md</name>
  <files>crates/analysis/tests/trigger_integration.rs
crates/analysis/src/trigger_validation.rs
crates/analysis/src/encode_quantifier.rs
.planning/phases/15-trigger-customization/15-VERIFICATION.md</files>
  <action>
    Step 1 — For each failing test from Task 1: determine if it exposes a genuine bug (wrong behavior per the spec) vs. documenting an unimplemented feature. Fix genuine bugs in `trigger_validation.rs` or `encode_quantifier.rs` with minimal targeted changes.

    For test 9 (spec_parser E2E): if `parse_spec_expr` doesn't preserve trigger hints in its output Term, add that support. The trigger annotation `#[trigger(expr)]` should survive parsing and appear as a TriggerHint annotation in the resulting Term. If the spec_parser already handles it, the test just needs the right assertion.

    Step 2 — Confirm all 9 new tests + all existing 17 tests pass:
    ```bash
    cargo test -p rust-fv-analysis --test trigger_integration 2>&1
    ```

    Step 3 — Run full workspace test to check for regressions:
    ```bash
    cargo test --workspace 2>&1 | tail -5
    ```

    Step 4 — Run clippy + fmt:
    ```bash
    cargo clippy -p rust-fv-analysis 2>&1 | grep -E "^error|^warning"
    cargo fmt -p rust-fv-analysis -- --check
    ```

    Step 5 — Update `15-VERIFICATION.md`:
    - Add a new subsection in Test Evidence: "Phase 33 Edge Case Tests (9 new)"
    - List all 9 test names and their status
    - Update the "Known Limitations" section: mark "No E2E test with actual Rust code" as RESOLVED (test 9 covers this)
    - Update the warning about "driver integration incomplete" — leave it (separate tech debt, not Phase 33 scope)
    - Add: "Phase 33 tech debt: 9 DEBTLINES RESOLVED — edge case tests added 2026-02-27"
    - Update test count: "75 tests" → "84 tests (75 original + 9 Phase 33 edge cases)"
    - Do NOT change top-level `status: passed` or `score: 5/5`
  </action>
  <verify>
    <automated>cargo test -p rust-fv-analysis --test trigger_integration 2>&1 | grep "test result"</automated>
  </verify>
  <done>All 26 tests in trigger_integration.rs pass (17 original + 9 new). cargo test --workspace shows 0 failures. 15-VERIFICATION.md updated with new test list and DEBTLINES marked resolved.</done>
</task>

</tasks>

<verification>
```bash
# All tests pass
cargo test -p rust-fv-analysis --test trigger_integration 2>&1 | grep "test result"
# Count new tests
cargo test -p rust-fv-analysis --test trigger_integration 2>&1 | grep "passed"
# No regressions
cargo test --workspace 2>&1 | tail -3
# DEBTLINES resolved
grep -i "DEBTLINE\|RESOLVED\|Phase 33" /Users/alexanderfedin/Projects/hapyy/rust-fv/.planning/phases/15-trigger-customization/15-VERIFICATION.md | head -5
```
</verification>

<success_criteria>
- 9 new tests in trigger_integration.rs all pass
- All existing 17 tests continue to pass (0 regressions)
- Test 9 (spec_parser E2E) passes — confirming triggers survive full parse pipeline
- Full workspace test: 0 failures
- 15-VERIFICATION.md DEBTLINES section updated to "RESOLVED"
- cargo clippy: 0 new errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/33-v0-1-tech-debt-resolution/33-04-SUMMARY.md`
</output>

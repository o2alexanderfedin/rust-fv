---
phase: 31-z3-bv2int-fix-ghost-locals
plan: "02"
type: execute
wave: 2
depends_on:
  - "31-01"
files_modified:
  - crates/analysis/src/vcgen.rs
  - crates/analysis/tests/e2e_verification.rs
autonomous: true
requirements:
  - Phase-04-bv2int
must_haves:
  truths:
    - "uses_spec_int_types() returns true when any spec expression (requires/ensures/invariants) contains 'as int' or 'as nat' substring"
    - "SMT scripts for functions with 'as int' in ensures and non-SpecInt IR types select (set-logic ALL)"
    - "test_unbounded_int_addition_no_overflow is un-commented, has no #[ignore], passes GREEN"
    - "test_unbounded_int_sum_formula is un-commented, has no #[ignore], passes GREEN"
    - "phase04_bv2int_logic_selection test from plan 31-01 now passes GREEN"
    - "All previously GREEN tests remain GREEN"
  artifacts:
    - path: "crates/analysis/src/vcgen.rs"
      provides: "Extended uses_spec_int_types() that detects 'as int'/'as nat' in spec strings"
      contains: "as int"
    - path: "crates/analysis/tests/e2e_verification.rs"
      provides: "Two un-commented E2E tests verifying bv2int under ALL logic"
      contains: "test_unbounded_int_addition_no_overflow"
  key_links:
    - from: "uses_spec_int_types()"
      to: "base_script(uses_int=true)"
      via: "return value triggers ALL logic selection"
      pattern: "set-logic ALL"
    - from: "test_unbounded_int_addition_no_overflow"
      to: "vcgen::generate_vcs"
      via: "asserts (set-logic ALL) and bv2int present in script"
      pattern: "bv2int"
---

<objective>
Fix `uses_spec_int_types()` in vcgen.rs to detect `"as int"` / `"as nat"` substrings in spec
expressions, so functions using `bv2int` casts in their spec strings select `(set-logic ALL)`.
Then un-comment and activate the two E2E tests that validate the fix end-to-end with Z3.

Purpose: Make SpecInt/SpecNat unbounded arithmetic functional for the common case where the Rust
function body uses BV types (I32, U64) but the spec asserts properties via integer arithmetic
using `as int` casts.

Output: Patched vcgen.rs + two activated E2E tests, all GREEN.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-z3-bv2int-fix-ghost-locals/31-RESEARCH.md
@.planning/phases/31-z3-bv2int-fix-ghost-locals/31-01-SUMMARY.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

Target function in crates/analysis/src/vcgen.rs (line 1528):
```rust
fn uses_spec_int_types(func: &Function) -> bool {
    // Check return type
    if func.return_local.ty.is_spec_int() { return true; }
    // Check parameters
    for param in &func.params { if param.ty.is_spec_int() { return true; } }
    // Check locals
    for local in &func.locals { if local.ty.is_spec_int() { return true; } }
    false
}
```

Logic selection code (vcgen.rs line 1567) — the `uses_int` parameter feeds from `uses_spec_int_types()`:
```rust
if uses_int {
    script.push(Command::SetLogic("ALL".to_string()));
} else if datatype_declarations.is_empty() {
    script.push(Command::SetLogic("QF_BV".to_string()));
} else {
    script.push(Command::SetLogic("QF_UFBVDT".to_string()));
}
```

Contracts struct (from ir.rs):
```rust
pub struct Contracts {
    pub requires: Vec<SpecExpr>,
    pub ensures: Vec<SpecExpr>,
    pub invariants: Vec<SpecExpr>,
    pub state_invariant: Option<SpecExpr>,
    pub is_pure: bool,
    pub decreases: Option<SpecExpr>,
}
pub struct SpecExpr { pub raw: String; }
```

The two commented-out tests in e2e_verification.rs (lines ~1519-1682):
```rust
// TODO: #[test]
// TODO: fn test_unbounded_int_addition_no_overflow() { ... }
// TODO: #[test]
// TODO: fn test_unbounded_int_sum_formula() { ... }
```
Each line starts with `// TODO: `. Un-commenting means removing the `// TODO: ` prefix from every
line between the `#[test]` and closing `}` of each test function.

NOTE: The `// TODO(Phase 04-01):` comments inside the test bodies should be left as regular
comments (they become `// TODO(Phase 04-01):` not code). The block delimiter:
```
// ===========================================================================
// Unbounded Integer Tests (Phase 04-01)
// TODO: // ===========================================================================
```
The `// TODO: // ===` line needs the prefix stripped too (resulting in `// ===`).

Pitfall 2 from research — use `contains("as int")` without leading space OR check for both:
- `" as int"` (space before) catches most cases
- The spec parser tokenizes with spaces, so `" as int"` is safe
- But use `contains("as int")` (no leading space) to be robust against edge cases
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend uses_spec_int_types() to detect 'as int'/'as nat' in spec strings</name>
  <files>crates/analysis/src/vcgen.rs</files>
  <action>
    Extend the `uses_spec_int_types()` function (line 1528) to also scan spec expression strings.
    After the existing local/param/return type checks, add a closure-based scan over all spec
    expressions in the function's contracts.

    The fixed function body (append after the existing three loops, before the final `false`):

    ```rust
    // Check spec expressions for "as int" / "as nat" casts (produce Term::Bv2Int).
    // This covers the common case: I32 params/return with "as int" in ensures/requires.
    let spec_uses_bv2int = |expr: &SpecExpr| {
        expr.raw.contains("as int") || expr.raw.contains("as nat")
    };
    for pre in &func.contracts.requires {
        if spec_uses_bv2int(pre) { return true; }
    }
    for post in &func.contracts.ensures {
        if spec_uses_bv2int(post) { return true; }
    }
    for inv in &func.contracts.invariants {
        if spec_uses_bv2int(inv) { return true; }
    }
    if let Some(ref inv) = func.contracts.state_invariant {
        if spec_uses_bv2int(inv) { return true; }
    }
    ```

    Replace `false` at the end of the function with the above block + `false`.

    Important: The `SpecExpr` type must be in scope. It is imported via `use crate::ir::SpecExpr`
    or available through `crate::ir::*`. Check the existing imports at the top of vcgen.rs — it
    likely already imports `crate::ir::*`. If `SpecExpr` is not visible, add `use crate::ir::SpecExpr;`.

    Do NOT change the function signature. Do NOT change the logic-selection code (`base_script`).
    The `uses_int` parameter that feeds into `base_script` is derived from `uses_spec_int_types()`
    at each call site — verify a few call sites to confirm (grep for `uses_spec_int_types(func)`
    and check that it feeds into `uses_int` for `base_script`).

    After the change, run unit test to verify:
    - `phase04_bv2int_logic_selection` goes GREEN
    - All other vcgen_completeness29 tests remain GREEN
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_bv2int_logic_selection -- --nocapture 2>&1 | tail -10
    ```
    Expected: test PASSES (GREEN)

    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "FAILED|error\[" | head -10
    ```
    Expected: No failures, no compile errors (only the phase04_ghost test should still fail from plan 31-01)
  </verify>
  <done>
    `uses_spec_int_types()` returns true for functions with "as int" in spec strings.
    `phase04_bv2int_logic_selection` test GREEN. No regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Un-comment the two bv2int E2E tests and verify GREEN with Z3</name>
  <files>crates/analysis/tests/e2e_verification.rs</files>
  <action>
    Un-comment the two test functions currently blocked with `// TODO: ` prefix in e2e_verification.rs,
    lines approximately 1519-1682.

    Each commented line currently looks like:
    ```
    // TODO: #[test]
    // TODO: fn test_unbounded_int_addition_no_overflow() {
    // TODO:     let func = Function {
    ...
    // TODO: }
    ```

    The task is to remove the `// TODO: ` prefix (exactly: forward slash, forward slash, space, T, O, D, O, colon, space) from every such line. The section delimiter line:
    ```
    // TODO: // ===========================================================================
    ```
    becomes:
    ```
    // ===========================================================================
    ```
    (The inner `// ` becomes a regular line comment — this is correct.)

    The test comment lines like:
    ```
    // TODO:         // TODO(Phase 04-01): Z3 bv2int integration requires ...
    ```
    become:
    ```
    //         // TODO(Phase 04-01): Z3 bv2int integration requires ...
    ```
    which is a valid (though odd) double-commented line. Alternatively, the inner `// TODO(Phase 04-01):` becomes a standalone comment — either is acceptable.

    After un-commenting, the two test functions should be:
    - `test_unbounded_int_addition_no_overflow` — no `#[ignore]`, no `// TODO:` prefix
    - `test_unbounded_int_sum_formula` — no `#[ignore]`, no `// TODO:` prefix

    Both tests assert:
    1. `smtlib.contains("(set-logic ALL)")` — now passes because uses_spec_int_types() detects "as int"
    2. `smtlib.contains("bv2int")` — passes because spec parser already produces Bv2Int terms
    3. A tracing info line (passes unconditionally)

    Note: The original tests had a TODO comment saying "Full Z3 verification pending bv2int support confirmation". The tests do NOT call Z3 directly — they only check the generated SMT-LIB script text. Z3 verification is not in scope for this plan (it would require integration test infrastructure). The `tracing::info!` lines are sufficient.

    Run the tests:
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis test_unbounded_int 2>&1 | tail -20
    ```

    If either test fails after un-commenting, diagnose and fix:
    - If `(set-logic ALL)` assertion fails: verify Task 1 is complete and test_unbounded_int uses non-SpecInt IR types with "as int" in ensures
    - If `bv2int` assertion fails: check that spec parser (parse_spec/parse_spec_postcondition) produces Bv2Int term for "result as int" — may need to grep for "as int" handling in spec_parser.rs
    - If compile error: check Contracts field names (is_pure, decreases) — use `..Default::default()` pattern
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis test_unbounded_int_addition_no_overflow -- --nocapture 2>&1 | tail -15
    ```
    Expected: PASSES (set-logic ALL + bv2int assertions pass)

    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis test_unbounded_int_sum_formula -- --nocapture 2>&1 | tail -15
    ```
    Expected: PASSES

    Full suite regression check:
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis 2>&1 | grep -E "^test .* FAILED" | head -20
    ```
    Expected: No failures (except possibly phase04_ghost_local_leaks_into_vc which plan 31-03 fixes)
  </verify>
  <done>
    Both `test_unbounded_int_addition_no_overflow` and `test_unbounded_int_sum_formula` pass GREEN.
    SMT scripts contain `(set-logic ALL)` and `bv2int`. No regressions in full analysis test suite.
  </done>
</task>

</tasks>

<verification>
Full Phase 31-02 verification:

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_bv2int -- --nocapture 2>&1 | tail -5
```
Expected: `phase04_bv2int_logic_selection` PASSES

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis test_unbounded_int 2>&1 | grep -E "PASSED|FAILED"
```
Expected: Both test_unbounded_int tests PASS

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy 2>&1 | grep "^error" | head -10
```
Expected: No errors
</verification>

<success_criteria>
- `uses_spec_int_types()` detects "as int" in spec expression strings
- `phase04_bv2int_logic_selection` test is GREEN
- `test_unbounded_int_addition_no_overflow` is un-commented and GREEN
- `test_unbounded_int_sum_formula` is un-commented and GREEN
- All previously GREEN tests remain GREEN
- `cargo clippy 2>&1 | grep "^error"` shows no errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-z3-bv2int-fix-ghost-locals/31-02-SUMMARY.md`
</output>

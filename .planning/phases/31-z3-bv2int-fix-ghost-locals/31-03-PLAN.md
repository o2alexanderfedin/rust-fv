---
phase: 31-z3-bv2int-fix-ghost-locals
plan: "03"
type: execute
wave: 2
depends_on:
  - "31-01"
files_modified:
  - crates/analysis/src/vcgen.rs
autonomous: true
requirements:
  - Phase-04-ghost
must_haves:
  truths:
    - "Ghost local assignments are not encoded as SMT assert commands in executable VCs"
    - "Ghost locals remain declared as SMT constants (DeclareConst) so spec expressions can reference them"
    - "phase04_ghost_local_leaks_into_vc test from plan 31-01 now passes GREEN"
    - "All previously GREEN tests remain GREEN"
  artifacts:
    - path: "crates/analysis/src/vcgen.rs"
      provides: "is_ghost_place() helper + encode_assignment() guard for ghost locals"
      contains: "is_ghost_place"
  key_links:
    - from: "encode_assignment()"
      to: "is_ghost_place()"
      via: "early return None when LHS place is ghost"
      pattern: "is_ghost_place"
    - from: "is_ghost_place()"
      to: "Local::is_ghost"
      via: "field access on matched local from func.locals/params/return_local"
      pattern: "local.is_ghost"
---

<objective>
Implement `is_ghost_place()` helper in vcgen.rs and add a ghost-local guard at the entry of
`encode_assignment()` to prevent ghost variable assignments from leaking into executable SMT VCs.

Purpose: Ghost locals are specification-only; their assignments must be erased from VCs. They
must remain declared as SMT constants (DeclareConst) so spec expressions can reference them.
This closes the Phase 04 ghost locals filtering gap.

Output: Patched vcgen.rs with is_ghost_place() + encode_assignment() guard, phase04_ghost test GREEN.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-z3-bv2int-fix-ghost-locals/31-RESEARCH.md
@.planning/phases/31-z3-bv2int-fix-ghost-locals/31-01-SUMMARY.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

Target function in crates/analysis/src/vcgen.rs (line 1625):
```rust
fn encode_assignment(
    place: &Place,
    rvalue: &Rvalue,
    func: &Function,
    _ssa_counter: &mut HashMap<String, u32>,
) -> Option<Command> {
    // Handle projected LHS (field access on left side)
    if !place.projections.is_empty() {
        ...
    }
    ...
}
```

Local struct in ir.rs (line ~590):
```rust
pub struct Local {
    pub name: String,
    pub ty: Ty,
    pub is_ghost: bool,  // true for __ghost_* locals (specification-only)
}
```

Function struct in ir.rs:
```rust
pub struct Function {
    pub name: String,
    pub return_local: Local,
    pub params: Vec<Local>,
    pub locals: Vec<Local>,
    pub basic_blocks: Vec<BasicBlock>,
    pub contracts: Contracts,
    pub loops: Vec<Loop>,
}
```

Place struct in ir.rs:
```rust
pub struct Place {
    pub local: String,       // local variable name (e.g. "_0", "__ghost_x")
    pub projections: Vec<Projection>,
}
impl Place {
    pub fn local(name: &str) -> Self { ... }
}
```

Existing precedent: `find_local_type()` in vcgen.rs searches func.return_local / func.params / func.locals
by name — use the same pattern for `is_ghost_place()`.

Ghost detection precedent in cex_render.rs:
```rust
.filter(|l| !l.is_ghost)
```

DeclareConst for ghost locals is in `declare_function_locals()` (vcgen.rs line ~1349):
```
// Locals (including ghost locals - they're declared but may not be used in executable VCs)
```
Do NOT modify declare_function_locals() — ghost locals must stay declared.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add is_ghost_place() helper and guard in encode_assignment()</name>
  <files>crates/analysis/src/vcgen.rs</files>
  <action>
    Two changes to vcgen.rs:

    **Change 1: Add `is_ghost_place()` helper function**

    Place this function near `find_local_type()` (which is the existing helper that searches
    func.return_local/params/locals by name). Add it immediately before or after `find_local_type()`:

    ```rust
    /// Returns true if the place's root local is a ghost variable.
    /// Ghost locals must not generate assignment assertions in executable VCs.
    /// They remain declared as SMT constants so spec expressions can reference them.
    fn is_ghost_place(place: &Place, func: &Function) -> bool {
        // Check return local
        if func.return_local.name == place.local {
            return func.return_local.is_ghost;
        }
        // Check params
        for p in &func.params {
            if p.name == place.local {
                return p.is_ghost;
            }
        }
        // Check locals
        for l in &func.locals {
            if l.name == place.local {
                return l.is_ghost;
            }
        }
        false
    }
    ```

    **Change 2: Add guard at entry of `encode_assignment()`**

    At the very top of `encode_assignment()`, before the `if !place.projections.is_empty()` check,
    add:

    ```rust
    // Ghost locals are specification-only — skip encoding their assignments into
    // executable VCs. They remain declared as SMT constants so spec expressions
    // can reference them, but assignments are erased.
    if is_ghost_place(place, func) {
        return None;
    }
    ```

    The resulting function entry should look like:
    ```rust
    fn encode_assignment(
        place: &Place,
        rvalue: &Rvalue,
        func: &Function,
        _ssa_counter: &mut HashMap<String, u32>,
    ) -> Option<Command> {
        // Ghost locals are specification-only — skip encoding their assignments into
        // executable VCs. They remain declared as SMT constants so spec expressions
        // can reference them, but assignments are erased.
        if is_ghost_place(place, func) {
            return None;
        }
        // Handle projected LHS (field access on left side)
        if !place.projections.is_empty() {
            ...
        }
        ...
    }
    ```

    Do NOT modify `declare_function_locals()`. Ghost locals must remain in DeclareConst commands.
    Do NOT modify any other call site of `encode_assignment()` — all callers already handle
    `None` (via `if let Some(cmd) = encode_assignment(...)` patterns).

    After the change, run the target test to verify:
    - `phase04_ghost_local_leaks_into_vc` goes GREEN
    - All other tests remain GREEN
  </action>
  <verify>
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_ghost_local_leaks_into_vc -- --nocapture 2>&1 | tail -15
    ```
    Expected: test PASSES (GREEN)

    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "FAILED|error\[" | head -10
    ```
    Expected: No failures, no compile errors

    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis 2>&1 | grep -E "^test .* FAILED" | head -20
    ```
    Expected: No failures (full analysis test suite clean)

    Linting:
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy 2>&1 | grep "^error" | head -10
    ```
    Expected: No errors

    Formatting:
    ```bash
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo fmt --check 2>&1 | head -10
    ```
    Expected: No format errors (run `cargo fmt` first if needed, then re-verify)
  </verify>
  <done>
    `is_ghost_place()` function exists in vcgen.rs.
    `encode_assignment()` has ghost guard returning None for ghost local LHS.
    `phase04_ghost_local_leaks_into_vc` test is GREEN.
    Ghost locals still appear in DeclareConst (declaration preserved; only assignment skipped).
    All previously GREEN tests remain GREEN.
    `cargo clippy 2>&1 | grep "^error"` shows no errors.
  </done>
</task>

</tasks>

<verification>
Full Phase 31-03 verification:

Both Phase 04 gaps now closed:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_ -- --nocapture 2>&1 | grep -E "PASSED|FAILED"
```
Expected: Both `phase04_bv2int_logic_selection` and `phase04_ghost_local_leaks_into_vc` PASS

Full analysis test suite:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis 2>&1 | tail -5
```
Expected: All tests pass (test result: ok)

Clippy:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy 2>&1 | grep "^error" | head -10
```
Expected: No errors
</verification>

<success_criteria>
- `is_ghost_place()` helper added to vcgen.rs
- `encode_assignment()` returns None for ghost local LHS places
- `phase04_ghost_local_leaks_into_vc` test is GREEN
- Ghost locals remain in DeclareConst (not filtered from declarations)
- All Phase 30 + Phase 31-02 tests still GREEN (no regressions)
- `cargo clippy 2>&1 | grep "^error"` shows no errors
- `cargo fmt --check` passes
</success_criteria>

<output>
After completion, create `.planning/phases/31-z3-bv2int-fix-ghost-locals/31-03-SUMMARY.md`
</output>

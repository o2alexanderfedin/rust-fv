---
phase: 31-z3-bv2int-fix-ghost-locals
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/analysis/tests/vcgen_completeness29.rs
autonomous: true
requirements:
  - Phase-04-bv2int
  - Phase-04-ghost
must_haves:
  truths:
    - "Test `phase04_bv2int_logic_selection` exists and fails RED — uses_spec_int_types() returns false for 'as int' spec expressions when IR types are QF_BV"
    - "Test `phase04_ghost_local_leaks_into_vc` exists and fails RED — encode_assignment currently emits SMT assertion for ghost local assignments"
    - "All previously GREEN tests remain GREEN after adding the two new RED tests"
  artifacts:
    - path: "crates/analysis/tests/vcgen_completeness29.rs"
      provides: "TDD RED tests for Phase-04-bv2int and Phase-04-ghost gaps"
      contains: "phase04_bv2int_logic_selection"
  key_links:
    - from: "phase04_bv2int_logic_selection"
      to: "vcgen::generate_vcs"
      via: "direct call with SpecExpr containing 'as int' and non-SpecInt IR types"
      pattern: "set-logic ALL"
    - from: "phase04_ghost_local_leaks_into_vc"
      to: "vcgen::generate_vcs"
      via: "direct call with ghost local in Function.locals"
      pattern: "is_ghost: true"
---

<objective>
Write two TDD RED tests that characterize the Phase 04 functional gaps: bv2int logic selection
and ghost local filtering.

Purpose: Establish the failing state that plans 31-02 and 31-03 must make GREEN. Both tests
precisely define the contract that the fixes must satisfy.

Output: Two new test functions in vcgen_completeness29.rs, both failing (RED).
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-z3-bv2int-fix-ghost-locals/31-RESEARCH.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

From crates/analysis/src/ir.rs (Local struct, line ~590):
```rust
pub struct Local {
    pub name: String,
    pub ty: Ty,
    pub is_ghost: bool,  // true for __ghost_* locals (specification-only)
}
```

From crates/analysis/src/ir.rs (Contracts + SpecExpr):
```rust
pub struct Contracts {
    pub requires: Vec<SpecExpr>,
    pub ensures: Vec<SpecExpr>,
    pub invariants: Vec<SpecExpr>,
    pub state_invariant: Option<SpecExpr>,
    pub is_pure: bool,
    pub decreases: Option<SpecExpr>,
}
pub struct SpecExpr {
    pub raw: String,
}
```

From crates/analysis/src/vcgen.rs (public API):
```rust
pub fn generate_vcs(func: &Function, contract_db: Option<&ContractDatabase>) -> VerificationResult;
// VerificationResult.conditions: Vec<VerificationCondition>
// VerificationCondition.script: rust_fv_smtlib::script::Script
```

From crates/analysis/tests/vcgen_completeness29.rs (helpers, lines 16-49):
```rust
fn make_func(
    name: &str,
    return_ty: Ty,
    params: Vec<Local>,
    locals: Vec<Local>,
    basic_blocks: Vec<BasicBlock>,
) -> Function { ... }

fn script_to_text(script: &rust_fv_smtlib::script::Script) -> String { ... }
```

Existing test imports (line 8-9):
```rust
use rust_fv_analysis::ir::*;
use rust_fv_analysis::vcgen;
```

Current `uses_spec_int_types()` — only checks IR types, NOT spec expression strings (vcgen.rs line 1528):
```rust
fn uses_spec_int_types(func: &Function) -> bool {
    if func.return_local.ty.is_spec_int() { return true; }
    for param in &func.params { if param.ty.is_spec_int() { return true; } }
    for local in &func.locals { if local.ty.is_spec_int() { return true; } }
    false
}
```

Contracts default values (from ir.rs):
```rust
impl Default for Contracts {
    fn default() -> Self {
        Self {
            requires: vec![],
            ensures: vec![],
            invariants: vec![],
            state_invariant: None,
            is_pure: false,
            decreases: None,
        }
    }
}
```
</interfaces>
</context>

<feature>
  <name>TDD RED scaffold: Phase 04 bv2int + ghost locals gaps</name>
  <files>
    crates/analysis/tests/vcgen_completeness29.rs
  </files>
  <behavior>
    Two tests must be added (both RED until plans 31-02 and 31-03 implement the fixes):

    Test 1 — NEW: `phase04_bv2int_logic_selection`
    Purpose: Asserts that when a function's ensures contains `"(result as int) > 0"` (triggering
    Term::Bv2Int) with I32 IR params/return (non-SpecInt), the generated SMT script uses
    `(set-logic ALL)` not `(set-logic QF_BV)`.

    Structure:
    - Function with I32 return, one I32 param `_1`, one basic block: Assign _0 = Copy(_1), Return
    - Contracts.ensures = [SpecExpr { raw: "(result as int) > 0".to_string() }]
    - Calls `vcgen::generate_vcs(&func, None)`
    - Collects all SMT text via script_to_text
    - Asserts `all_smt.contains("(set-logic ALL)")` — FAILS because uses_spec_int_types() returns
      false for I32 params/return, so base_script() selects QF_BV
    - Asserts `all_smt.contains("bv2int")` — may pass or fail depending on parser; the ALL check is definitive

    Test 2 — NEW: `phase04_ghost_local_leaks_into_vc`
    Purpose: Asserts that when a function has a ghost local (`is_ghost: true`) with an assignment
    in the basic block, the SMT VCs do NOT contain an assertion for that ghost local's assignment.

    Structure:
    - Function with I32 return, no params, one ghost local `__ghost_x` (is_ghost: true, ty: I32)
    - One basic block: two assigns — first sets _0 = Const(42_i32), second assigns the ghost local
      `__ghost_x = Const(0_i32)`
    - Contracts: default (no requires/ensures)
    - Calls `vcgen::generate_vcs(&func, None)`
    - Collects all SMT text via script_to_text
    - Asserts `!all_smt.contains("__ghost_x")` OR asserts the ghost assignment is not encoded as
      an SMT `assert` — FAILS because encode_assignment currently emits the ghost local assignment

    Cases:
    - I32 func with `"as int"` in ensures → must select ALL logic (currently selects QF_BV — RED)
    - Ghost local with assignment in MIR → must not appear as SMT assert (currently leaks — RED)
  </behavior>
  <implementation>
    RED phase: Both tests fail because:
    1. `uses_spec_int_types()` in vcgen.rs does not scan spec expression strings for "as int"
    2. `encode_assignment()` in vcgen.rs does not check `is_ghost` on the LHS place's local

    Append both tests after the last existing test `vcgen_06_set_discriminant_assertion` (line 664).
    Add a comment block before each test:
    ```
    // ===========================================================================
    // Phase 04 Gap Tests (Phase 31 gap closure)
    // ===========================================================================
    ```

    For Test 1 (bv2int), construct the function IR:
    ```rust
    let func = Function {
        name: "add_positive".to_string(),
        return_local: Local { name: "_0".to_string(), ty: Ty::Int(IntTy::I32), is_ghost: false },
        params: vec![
            Local { name: "_1".to_string(), ty: Ty::Int(IntTy::I32), is_ghost: false },
        ],
        locals: vec![],
        basic_blocks: vec![BasicBlock {
            statements: vec![Statement::Assign(
                Place::local("_0"),
                Rvalue::Use(Operand::Copy(Place::local("_1"))),
            )],
            terminator: Terminator::Return,
        }],
        contracts: Contracts {
            ensures: vec![SpecExpr { raw: "(result as int) > 0".to_string() }],
            ..Default::default()
        },
        loops: vec![],
    };
    ```

    For Test 2 (ghost locals), the ghost local must be in `func.locals` with `is_ghost: true`:
    ```rust
    let func = Function {
        name: "ghost_filter_test".to_string(),
        return_local: Local { name: "_0".to_string(), ty: Ty::Int(IntTy::I32), is_ghost: false },
        params: vec![],
        locals: vec![
            Local { name: "__ghost_x".to_string(), ty: Ty::Int(IntTy::I32), is_ghost: true },
        ],
        basic_blocks: vec![BasicBlock {
            statements: vec![
                Statement::Assign(
                    Place::local("_0"),
                    Rvalue::Use(Operand::Constant(ir::Constant::Int(42, IntTy::I32))),
                ),
                Statement::Assign(
                    Place::local("__ghost_x"),
                    Rvalue::Use(Operand::Constant(ir::Constant::Int(0, IntTy::I32))),
                ),
            ],
            terminator: Terminator::Return,
        }],
        contracts: Contracts::default(),
        loops: vec![],
    };
    ```

    Check how `ir::Constant::Int` is constructed in existing tests — use the exact same pattern.
    If `Constant::Int(value, ty)` is not the right variant, grep vcgen_completeness29.rs for
    `Operand::Constant` usage and match that pattern.

    Do NOT use `#[should_panic]`. Tests must fail via assertion, not panic.
  </implementation>
</feature>

<verification>
RED phase verification:

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_bv2int_logic_selection -- --nocapture 2>&1 | tail -20
```
Expected: test FAILS — assertion `all_smt.contains("(set-logic ALL)")` fails (script uses QF_BV instead)

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 phase04_ghost_local_leaks_into_vc -- --nocapture 2>&1 | tail -20
```
Expected: test FAILS — assertion about ghost local not appearing as assert fails (it currently leaks)

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 vcgen_06_set_discriminant_assertion -- --nocapture 2>&1 | tail -5
```
Expected: PASSES (regression guard — Phase 30 work must remain GREEN)

Full suite compile check:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "FAILED|error\[" | head -20
```
Expected: Only the two new phase04_* tests appear as FAILED; no compile errors.

Linting:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy --tests 2>&1 | grep "^error" | head -10
```
Expected: No errors.
</verification>

<success_criteria>
- `phase04_bv2int_logic_selection` test exists and is RED (fails on `(set-logic ALL)` assertion)
- `phase04_ghost_local_leaks_into_vc` test exists and is RED (fails on ghost local not-present assertion)
- All Phase 30 tests remain GREEN (no regression in vcgen_completeness29.rs suite)
- `cargo build --tests` succeeds with no compile errors
- `cargo clippy --tests 2>&1 | grep "^error"` shows no errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-z3-bv2int-fix-ghost-locals/31-01-SUMMARY.md`
</output>

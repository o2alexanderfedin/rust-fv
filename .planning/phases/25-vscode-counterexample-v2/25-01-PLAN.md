---
phase: 25-vscode-counterexample-v2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vscode-extension/src/diagnostics.ts
  - vscode-extension/src/outputPanel.ts
autonomous: true
requirements:
  - CEX-02
  - CEX-04

must_haves:
  truths:
    - "VSCode inline diagnostic shows typed values (e.g. 'x: i32 = 5') not raw hex bitvectors when verification fails"
    - "Output panel renders typed Rust values from counterexample_v2.variables with name, type, and display"
    - "When counterexample_v2 is absent (legacy binary or timeout), extension falls back to legacy counterexample flat list without crashing"
    - "TypeScript strict-mode compile passes with zero errors after changes"
    - "formatCounterexample export in diagnostics.ts remains unchanged for backward compatibility"
  artifacts:
    - path: "vscode-extension/src/diagnostics.ts"
      provides: "renderCounterexampleLines() + renderTypedVariable() helpers + upgraded createDiagnostic() counterexample section"
      exports: ["renderCounterexampleLines", "formatCounterexample"]
    - path: "vscode-extension/src/outputPanel.ts"
      provides: "Upgraded formatFailedFunction() counterexample section using renderCounterexampleLines"
      contains: "renderCounterexampleLines"
  key_links:
    - from: "vscode-extension/src/outputPanel.ts"
      to: "vscode-extension/src/diagnostics.ts"
      via: "import { renderCounterexampleLines } from './diagnostics'"
      pattern: "renderCounterexampleLines"
    - from: "vscode-extension/src/diagnostics.ts"
      to: "vscode-extension/src/verifier.ts"
      via: "import { JsonCexVariable } from './verifier'"
      pattern: "JsonCexVariable"
---

<objective>
Wire counterexample_v2 typed schema into the VSCode extension's diagnostic display and output panel, replacing legacy flat-string rendering with typed Rust values (e.g. `x: i32 = 5`), with graceful fallback to the legacy format when v2 is absent.

Purpose: Closes CEX-02 and CEX-04 IDE gap — Phase 19-04 built the complete Rust backend for typed counterexamples, but diagnostics.ts and outputPanel.ts still read the legacy flat `counterexample` field. After this plan, IDE users see typed Rust values instead of raw bitvectors.

Output: Updated diagnostics.ts (with shared rendering helpers) and outputPanel.ts (consuming helpers), TypeScript compiles clean.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-vscode-counterexample-v2/25-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add typed rendering helpers to diagnostics.ts and upgrade createDiagnostic()</name>
  <files>vscode-extension/src/diagnostics.ts</files>
  <action>
Read the current diagnostics.ts in full first to understand all imports and existing structure.

Add two helper functions after the existing imports and before the first exported function:

```typescript
import { JsonFailure, JsonAssignment, JsonCexVariable } from './verifier';

function renderTypedVariable(v: JsonCexVariable): string {
  // Single-value case: variable with one known value (e.g. function parameter that was not mutated)
  if (v.display !== undefined) {
    return `${v.name}: ${v.type} = ${v.display}`;
  }
  // Two-value case: variable mutated between initial state and failure point
  if (v.initial && v.at_failure) {
    return `${v.name}: ${v.type} = ${v.initial.display} (initial) → ${v.at_failure.display} (at failure)`;
  }
  // Initial-only case: parameter with known initial value but no mutation tracked
  if (v.initial) {
    return `${v.name}: ${v.type} = ${v.initial.display}`;
  }
  return `${v.name}: ${v.type} = (unknown)`;
}

export function renderCounterexampleLines(failure: JsonFailure): string[] {
  // Prefer typed v2 schema (Phase 19-04 output)
  if (failure.counterexample_v2 && failure.counterexample_v2.variables.length > 0) {
    return failure.counterexample_v2.variables.map(renderTypedVariable);
  }
  // Fallback to legacy flat assignments (backward compat: older binary or timeout/UNSAT)
  if (failure.counterexample && failure.counterexample.length > 0) {
    return failure.counterexample.map((a: JsonAssignment) => `${a.variable} = ${a.value}`);
  }
  return [];
}
```

Then in `createDiagnostic()`, find and replace the counterexample section (currently at lines 66-68):

BEFORE:
```typescript
if (failure.counterexample && failure.counterexample.length > 0) {
  message += `\nCounterexample: ${formatCounterexample(failure.counterexample)}`;
}
```

AFTER:
```typescript
const cexLines = renderCounterexampleLines(failure);
if (cexLines.length > 0) {
  message += `\nCounterexample:\n  ${cexLines.join('\n  ')}`;
}
```

CRITICAL: Do NOT modify or remove the existing `formatCounterexample` export function (around lines 92-96). It must remain unchanged for backward compatibility. Only add the new helpers alongside it.

CRITICAL: `JsonCexVariable` must be added to the import from './verifier'. Check current import statement and extend it — do not create a duplicate import.

CRITICAL: TypeScript strict mode is enabled. All optional field accesses on `counterexample_v2` fields must be null-safe. Use `v.initial?.display` when needed (the `display` fields inside `JsonCexValue` are defined as `string`, not optional, so direct access is safe once the parent is confirmed non-null).
  </action>
  <verify>
cd /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension && npx tsc --noEmit 2>&1 | head -30
  </verify>
  <done>
`npx tsc --noEmit` produces zero errors. `diagnostics.ts` exports both `renderCounterexampleLines` and the unchanged `formatCounterexample`. The `createDiagnostic()` counterexample section uses `renderCounterexampleLines(failure)`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade outputPanel.ts formatFailedFunction() to use typed rendering</name>
  <files>vscode-extension/src/outputPanel.ts</files>
  <action>
Read the current outputPanel.ts in full first to understand all imports and structure.

Add import for `renderCounterexampleLines` from `./diagnostics`:

```typescript
import { renderCounterexampleLines } from './diagnostics';
```

Add this to the existing import block (do not create a duplicate if `diagnostics` is already imported).

In `formatFailedFunction()`, find and replace the counterexample section (currently at lines 114-120):

BEFORE:
```typescript
if (failure.counterexample && failure.counterexample.length > 0) {
  channel.appendLine('    Counterexample:');
  for (const assignment of failure.counterexample) {
    channel.appendLine(`      ${assignment.variable} = ${assignment.value}`);
  }
}
```

AFTER:
```typescript
const cexLines = renderCounterexampleLines(failure);
if (cexLines.length > 0) {
  channel.appendLine('    Counterexample:');
  for (const line of cexLines) {
    channel.appendLine(`      ${line}`);
  }
}
```

Additionally, after the counterexample block, add the `violated_spec` display if present (additive enhancement — field already in JSON schema):

```typescript
if (failure.counterexample_v2?.violated_spec) {
  channel.appendLine(`    Violated spec: ${failure.counterexample_v2.violated_spec}`);
}
```

CRITICAL: `JsonFailure` may already be imported in outputPanel.ts. Verify before adding a new import — do not create duplicate imports.

CRITICAL: The `renderCounterexampleLines` function is defined in `diagnostics.ts` and exported. The import path is `'./diagnostics'` (same directory, no extension in TypeScript imports).

Run after changes:
```
cd /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension && npx tsc --noEmit
```

If TypeScript reports errors, fix them before completing the task. Common issues:
- Duplicate import: merge with existing import statement
- Missing type: add to the import from './verifier' if needed
- Optional chaining required: add `?.` on fields flagged as possibly undefined
  </action>
  <verify>
cd /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension && npx tsc --noEmit 2>&1 | head -30
  </verify>
  <done>
`npx tsc --noEmit` produces zero errors. `outputPanel.ts` imports `renderCounterexampleLines` from `./diagnostics`. The `formatFailedFunction()` counterexample section calls `renderCounterexampleLines(failure)` and displays typed lines. The `violated_spec` field is shown when present.
  </done>
</task>

</tasks>

<verification>
Run full TypeScript compile from the extension directory:
```
cd /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension && npx tsc --noEmit
```

Confirm zero errors. Confirm the following grep patterns exist in the modified files:

```bash
grep -n "renderCounterexampleLines" /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension/src/diagnostics.ts
grep -n "renderCounterexampleLines" /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension/src/outputPanel.ts
grep -n "formatCounterexample" /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension/src/diagnostics.ts
grep -n "counterexample_v2" /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension/src/diagnostics.ts
grep -n "counterexample_v2" /Users/alexanderfedin/Projects/hapyy/rust-fv/vscode-extension/src/outputPanel.ts
```

Expected:
- `renderCounterexampleLines` appears in both files (defined in diagnostics.ts, imported in outputPanel.ts)
- `formatCounterexample` still exists in diagnostics.ts (backward compat preserved)
- `counterexample_v2` appears in both files (the prefer-v2 branch)
</verification>

<success_criteria>
1. `npx tsc --noEmit` passes with zero errors in the vscode-extension directory
2. `diagnostics.ts` exports `renderCounterexampleLines(failure: JsonFailure): string[]` that returns typed lines (e.g. `["x: i32 = 5", "flag: bool = false"]`) from `counterexample_v2.variables` when present
3. `diagnostics.ts` `createDiagnostic()` uses `renderCounterexampleLines` instead of the legacy inline `formatCounterexample` call
4. `outputPanel.ts` `formatFailedFunction()` uses `renderCounterexampleLines` from `./diagnostics`
5. `formatCounterexample(assignments: JsonAssignment[]): string` export is preserved unchanged in `diagnostics.ts`
6. Both files gracefully handle absence of `counterexample_v2` (fallback to legacy flat list)
7. All three `renderTypedVariable` cases covered: `display`-only, `initial`+`at_failure`, `initial`-only
</success_criteria>

<output>
After completion, create `.planning/phases/25-vscode-counterexample-v2/25-01-SUMMARY.md` following the summary template.
</output>

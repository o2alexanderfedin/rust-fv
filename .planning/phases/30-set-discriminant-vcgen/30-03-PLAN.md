---
phase: 30-set-discriminant-vcgen
plan: "03"
type: execute
wave: 3
depends_on:
  - 30-02
files_modified:
  - crates/analysis/tests/vcgen_completeness29.rs
autonomous: true
requirements:
  - VCGEN-06
  - MIRCONV-02
must_haves:
  truths:
    - "vcgen_06_set_discriminant_assertion test has no #[ignore] attribute"
    - "vcgen_06_set_discriminant_assertion test body contains real assertions (no todo!())"
    - "The full vcgen_completeness29 test suite runs with 0 FAILED tests"
    - "cargo test -p rust-fv-analysis passes with 0 failed"
  artifacts:
    - path: "crates/analysis/tests/vcgen_completeness29.rs"
      provides: "Final vcgen_06_set_discriminant_assertion test with real body, no #[ignore]"
      contains: "vcgen_06_set_discriminant_assertion"
  key_links:
    - from: "vcgen_06_set_discriminant_assertion"
      to: "generate_set_discriminant_vcs"
      via: "vcgen::generate_vcs call with SetDiscriminant statement"
      pattern: "Statement::SetDiscriminant"
---

<objective>
Remove `#[ignore]` from `vcgen_06_set_discriminant_assertion` and replace its `todo!()` body with real assertions — finalizing VCGEN-06 gap closure.

Purpose: The implementation from plan 30-02 makes the assertion work. This plan completes the TDD cycle by confirming the full test suite is GREEN and VCGEN-06 is satisfied.
Output: Updated vcgen_completeness29.rs with a fully exercised `vcgen_06_set_discriminant_assertion` test. Full suite at 0 failures.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-set-discriminant-vcgen/30-CONTEXT.md
@.planning/phases/30-set-discriminant-vcgen/30-RESEARCH.md
@.planning/phases/30-set-discriminant-vcgen/30-02-SUMMARY.md

<interfaces>
<!-- Key interfaces the executor needs. -->

Current state of vcgen_06_set_discriminant_assertion (line ~601, must be replaced):
```rust
/// VCGEN-06c: SetDiscriminant + mk- functional update in VC.
///
/// TODO Plan 03/05: Depends on Statement::SetDiscriminant (Plan 03) and
/// projected LHS functional update for discriminant (Plan 05).
#[test]
#[ignore = "TODO Plan 03/05: Statement::SetDiscriminant not yet in ir::Statement"]
fn vcgen_06_set_discriminant_assertion() {
    todo!("Plan 03/05: implement after Statement::SetDiscriminant exists")
}
```

Target state — replace with (variant index 2 per CONTEXT.md decision, contains-check assertions):
```rust
/// VCGEN-06c: SetDiscriminant VCGen emits discriminant assertion VC.
///
/// Verifies that `generate_vcs` produces a VC containing `discriminant(place) == 2`
/// for a function with `Statement::SetDiscriminant(Place::local("_1"), 2)`.
#[test]
fn vcgen_06_set_discriminant_assertion() {
    use rust_fv_analysis::ir::IntTy;
    let blocks = vec![BasicBlock {
        statements: vec![Statement::SetDiscriminant(Place::local("_1"), 2)],
        terminator: Terminator::Return,
    }];
    let func = make_func("set_disc", Ty::Int(IntTy::I32), vec![], vec![], blocks);
    let vcs = vcgen::generate_vcs(&func, None);

    assert!(
        !vcs.conditions.is_empty(),
        "VCGEN-06c: expected at least one VC for SetDiscriminant, got 0"
    );

    let all_smt: String = vcs
        .conditions
        .iter()
        .map(|vc| script_to_text(&vc.script))
        .collect::<Vec<_>>()
        .join("\n");

    assert!(
        all_smt.contains("discriminant"),
        "VCGEN-06c: expected 'discriminant' in SMT output, got:\n{all_smt}"
    );
    assert!(
        all_smt.contains('2'),
        "VCGEN-06c: expected variant index '2' in SMT output, got:\n{all_smt}"
    );
}
```

From vcgen_completeness29.rs (existing helpers already available):
```rust
fn make_func(name: &str, return_ty: Ty, params: Vec<Local>, locals: Vec<Local>, basic_blocks: Vec<BasicBlock>) -> Function { ... }
fn script_to_text(script: &rust_fv_smtlib::script::Script) -> String { ... }

// Existing imports at file top:
use rust_fv_analysis::ir::*;
use rust_fv_analysis::vcgen;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace vcgen_06_set_discriminant_assertion with real test body, remove #[ignore]</name>
  <files>crates/analysis/tests/vcgen_completeness29.rs</files>
  <action>
Find the `vcgen_06_set_discriminant_assertion` function (around line 595-603) and replace the ENTIRE function including its doc comment, `#[test]`, `#[ignore]` attribute, and `todo!()` body with the new implementation shown in the interfaces section above.

Two changes MUST happen together:
1. Remove the `#[ignore = "TODO Plan 03/05: ..."]` attribute line entirely
2. Replace the `todo!("Plan 03/05: ...")` body with the real assertion body

Also update the doc comment to remove the TODO text and describe what the test actually verifies.

The test MUST use variant index `2` (not `1`) to be distinct from `vcgen_06_set_discriminant_unit` which uses variant index `1`. This follows the CONTEXT.md decision on test coverage breadth.

After making the change, run the full test suite to confirm 0 failures:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | tail -10
```

Then run clippy:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy --tests 2>&1 | grep "^error"
```
  </action>
  <verify>
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 vcgen_06_set_discriminant_assertion -- --nocapture 2>&1 | tail -5
```
Expected: `test vcgen_completeness29::vcgen_06_set_discriminant_assertion ... ok`

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "FAILED|ignored" | head -10
```
Expected: zero FAILED lines; `vcgen_06_set_discriminant_assertion` no longer in ignored count.

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis 2>&1 | tail -5
```
Expected: `test result: ok. X passed; 0 failed; ...`

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy --tests 2>&1 | grep "^error" | head -5
```
Expected: no output (zero clippy errors).
  </verify>
  <done>
    - `vcgen_06_set_discriminant_assertion` has no `#[ignore]` attribute
    - `vcgen_06_set_discriminant_assertion` body has real assertions (no `todo!()`)
    - Test passes (GREEN)
    - Full vcgen_completeness29 suite: 0 FAILED
    - `cargo test -p rust-fv-analysis` passes: 0 failed
    - Zero clippy errors
    - VCGEN-06 requirement is fully closed
    - MIRCONV-02 requirement is fully closed (IR variant + MIR lowering was already done in Phase 29, VCGen now complete)
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "test result|FAILED"
```
Expected: `test result: ok. X passed; 0 failed; 0 ignored` (no FAILED lines, vcgen_06 no longer ignored).

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis 2>&1 | grep "test result"
```
Expected: `test result: ok.` with `0 failed`.
</verification>

<success_criteria>
- `vcgen_06_set_discriminant_assertion` exists without `#[ignore]`, with real assertion body
- Full test suite: 0 FAILED, 0 ignored (for vcgen_06_set_discriminant_assertion specifically)
- `cargo test -p rust-fv-analysis` passes with 0 failed
- Zero clippy errors
- VCGEN-06: SetDiscriminant assertion VC emission is fully verified by the test suite
- MIRCONV-02: IR SetDiscriminant coverage is complete (IR variant + MIR lowering in Phase 29, VCGen in Phase 30)
- Phase 30 gap closure is complete
</success_criteria>

<output>
After completion, create `.planning/phases/30-set-discriminant-vcgen/30-03-SUMMARY.md`
</output>

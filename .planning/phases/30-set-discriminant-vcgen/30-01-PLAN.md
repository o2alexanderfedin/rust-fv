---
phase: 30-set-discriminant-vcgen
plan: "01"
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/analysis/tests/vcgen_completeness29.rs
autonomous: true
requirements:
  - VCGEN-06
  - MIRCONV-02
must_haves:
  truths:
    - "A unit test `vcgen_06_set_discriminant_unit` exists and fails (RED) because VCGen emits 0 VCs for SetDiscriminant"
    - "Test `vcgen_06_set_discriminant_assertion` exists without #[ignore], with a real assertion body, and fails (RED)"
    - "All previously GREEN tests remain GREEN after adding the new RED tests"
  artifacts:
    - path: "crates/analysis/tests/vcgen_completeness29.rs"
      provides: "TDD RED tests for VCGEN-06 SetDiscriminant VC emission"
      contains: "vcgen_06_set_discriminant_unit"
  key_links:
    - from: "vcgen_06_set_discriminant_unit"
      to: "vcgen::generate_vcs"
      via: "direct call with SetDiscriminant statement in IR"
      pattern: "Statement::SetDiscriminant"
---

<objective>
Write TDD RED tests for VCGEN-06 SetDiscriminant VC emission.

Purpose: Establish the failing state that plan 30-02 must make GREEN. Following TDD discipline — tests define the contract before implementation exists.
Output: Two new test functions in vcgen_completeness29.rs, both failing (RED).
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-set-discriminant-vcgen/30-CONTEXT.md
@.planning/phases/30-set-discriminant-vcgen/30-RESEARCH.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

From crates/analysis/src/ir.rs (Statement enum, line ~608):
```rust
#[derive(Debug, Clone)]
pub enum Statement {
    Assign(Place, Rvalue),
    Nop,
    SetDiscriminant(Place, usize),   // <-- already exists, added in Phase 29
    Assume(Operand),
}
```

From crates/analysis/src/ir.rs (Place):
```rust
impl Place {
    pub fn local(name: &str) -> Self { ... }
}
```

From crates/analysis/src/vcgen.rs (public API):
```rust
pub fn generate_vcs(func: &Function, contract_db: Option<&ContractDatabase>) -> VerificationResult;
// VerificationResult has: pub conditions: Vec<VerificationCondition>
```

From crates/analysis/tests/vcgen_completeness29.rs (existing helpers, lines 16-49):
```rust
fn make_func(
    name: &str,
    return_ty: Ty,
    params: Vec<Local>,
    locals: Vec<Local>,
    basic_blocks: Vec<BasicBlock>,
) -> Function { ... }

fn script_to_text(script: &rust_fv_smtlib::script::Script) -> String { ... }
```

Existing test imports (line 8-9):
```rust
use rust_fv_analysis::ir::*;
use rust_fv_analysis::vcgen;
```

Existing passing test for reference (mirconv_02_set_discriminant, line 384):
```rust
fn mirconv_02_set_discriminant() {
    let blocks = vec![BasicBlock {
        statements: vec![Statement::SetDiscriminant(Place::local("_0"), 0)],
        terminator: Terminator::Return,
    }];
    let func = make_func("set_disc", Ty::Int(IntTy::I32), vec![], vec![], blocks);
    let _vcs = vcgen::generate_vcs(&func, None);
    // vcgen must not panic; SetDiscriminant is a no-op in VCGen for now.
}
```

Existing #[ignore] test to replace (vcgen_06_set_discriminant_assertion, line 595-603):
```rust
/// VCGEN-06c: SetDiscriminant + mk- functional update in VC.
#[test]
#[ignore = "TODO Plan 03/05: Statement::SetDiscriminant not yet in ir::Statement"]
fn vcgen_06_set_discriminant_assertion() {
    todo!("Plan 03/05: implement after Statement::SetDiscriminant exists")
}
```
</interfaces>
</context>

<feature>
  <name>TDD RED scaffold: VCGEN-06 SetDiscriminant VC tests</name>
  <files>
    crates/analysis/tests/vcgen_completeness29.rs
  </files>
  <behavior>
    Two tests must be added (both RED until plan 30-02 implements the VCGen):

    Test 1 — NEW unit test `vcgen_06_set_discriminant_unit`:
    - Builds a Function IR with one BasicBlock containing `Statement::SetDiscriminant(Place::local("_1"), 1)`
    - Calls `vcgen::generate_vcs(&func, None)`
    - Asserts `!vcs.conditions.is_empty()` (FAILS because VCGen emits 0 VCs for SetDiscriminant)
    - Asserts the SMT output contains "discriminant" (FAILS)
    - Asserts the SMT output contains "1" (FAILS)

    Test 2 — REPLACE existing `vcgen_06_set_discriminant_assertion` (remove `#[ignore]`, replace `todo!()`):
    - Same pattern but uses variant index 2 (to distinguish from test 1)
    - Asserts `!vcs.conditions.is_empty()`, contains "discriminant", contains "2"
    - The `#[ignore]` attribute MUST be removed entirely
    - The `todo!()` body MUST be replaced with real assertions

    Cases:
    - `SetDiscriminant(Place::local("_1"), 1)` → VCGen must emit ≥1 VC containing "discriminant" and "1" in SMT
    - `SetDiscriminant(Place::local("_1"), 2)` → VCGen must emit ≥1 VC containing "discriminant" and "2" in SMT
  </behavior>
  <implementation>
    RED phase: Both tests fail because `generate_vcs_with_db` in vcgen.rs does NOT call
    `generate_set_discriminant_vcs` yet — that function does not exist until plan 30-02.

    The test body structure follows the existing `mirconv_02_set_discriminant` pattern:
    - Use `make_func("set_disc_vc", Ty::Int(IntTy::I32), vec![], vec![], blocks)`
    - Call `vcgen::generate_vcs(&func, None)` (not generate_vcs_with_db)
    - Use `script_to_text()` to collect all SMT output into one string for contains-checks

    Return type: `Ty::Int(IntTy::I32)` — matches existing no-enum fixture (sufficient to confirm VCGen handles SetDiscriminant without requiring datatype declarations).

    Insert both tests AFTER the existing `mirconv_02_set_discriminant` test (line ~394) and BEFORE
    the `vcgen_05_float_to_int_signed` section. For `vcgen_06_set_discriminant_assertion`, replace
    the entire function body at line 601-603 (remove `#[ignore]` + replace `todo!()`).

    Do NOT use `#[should_panic]` — the test must fail via assertion, not panic.
  </implementation>
</feature>

<verification>
RED phase verification:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 vcgen_06_set_discriminant_unit -- --nocapture 2>&1 | tail -20
```
Expected: test FAILS with "VCGEN-06: expected VC for SetDiscriminant, got 0" (assertion failure)

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 vcgen_06_set_discriminant_assertion -- --nocapture 2>&1 | tail -20
```
Expected: test FAILS with "expected VC for SetDiscriminant, got 0"

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 mirconv_02_set_discriminant -- --nocapture 2>&1 | tail -5
```
Expected: test PASSES (regression guard — existing test must remain GREEN)

Full suite compile check:
```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --test vcgen_completeness29 2>&1 | grep -E "FAILED|error\[" | head -10
```
Expected: Only the two new vcgen_06_set_discriminant tests appear as FAILED; no compile errors.
</verification>

<success_criteria>
- `vcgen_06_set_discriminant_unit` test exists and is RED (fails with assertion about 0 VCs)
- `vcgen_06_set_discriminant_assertion` has no `#[ignore]` attribute and is RED (fails with assertion about 0 VCs)
- `mirconv_02_set_discriminant` remains GREEN (no regression)
- `cargo build --tests` succeeds with no compile errors
- Linting: `cargo clippy --tests 2>&1 | grep "^error"` shows no errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-set-discriminant-vcgen/30-01-SUMMARY.md`
</output>

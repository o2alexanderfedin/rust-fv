---
phase: 15-trigger-customization
plan: 03
type: tdd
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - crates/analysis/src/encode_quantifier.rs
  - crates/driver/src/cargo_verify.rs
  - crates/analysis/tests/trigger_integration.rs
autonomous: true

must_haves:
  truths:
    - "Valid manual triggers fully replace auto-inferred triggers in SMT output"
    - "Invalid manual triggers produce Rustc-style errors and block verification"
    - "Verbose mode displays auto-inferred triggers per quantifier"
    - "Quantifiers without manual triggers still use auto-inference (backward compat)"
    - "Self-instantiation detection blocks verification with concrete loop example"
    - "Error messages suggest auto-inferred triggers as fixes"
  artifacts:
    - path: "crates/analysis/src/encode_quantifier.rs"
      provides: "annotate_quantifier extended to check for manual trigger hints, validate, and override auto-inference"
      contains: "rust_fv_trigger_hint"
    - path: "crates/driver/src/cargo_verify.rs"
      provides: "Verbose mode trigger display during verification"
      contains: "auto-inferred triggers"
    - path: "crates/analysis/tests/trigger_integration.rs"
      provides: "Integration tests for full trigger pipeline (parse -> validate -> SMT)"
      contains: "trigger"
  key_links:
    - from: "crates/analysis/src/encode_quantifier.rs"
      to: "crates/analysis/src/trigger_validation.rs"
      via: "validates manual trigger hints before using them"
      pattern: "TriggerValidator::.*validate"
    - from: "crates/analysis/src/encode_quantifier.rs"
      to: "crates/analysis/src/spec_parser.rs"
      via: "reads rust_fv_trigger_hint annotations from parsed Term"
      pattern: "rust_fv_trigger_hint"
    - from: "crates/driver/src/cargo_verify.rs"
      to: "crates/driver/src/diagnostics.rs"
      via: "calls format_trigger_error on validation failures"
      pattern: "format_trigger_error"
---

<objective>
Wire trigger parsing, validation, and SMT generation into a complete pipeline with verbose mode and integration tests.

Purpose: Connect Plan 01 (validation) and Plan 02 (parsing) into the verification pipeline. Manual trigger hints from spec annotations are validated at SMT generation time, and valid hints replace auto-inference. Verbose mode shows auto-inferred triggers. Integration tests prove the full pipeline works end-to-end.

Output: Complete trigger customization feature with E2E integration tests proving all 5 phase success criteria are met.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-trigger-customization/15-RESEARCH.md
@.planning/phases/15-trigger-customization/15-01-SUMMARY.md
@.planning/phases/15-trigger-customization/15-02-SUMMARY.md

# Key source files
@crates/analysis/src/encode_quantifier.rs
@crates/analysis/src/trigger_validation.rs
@crates/analysis/src/spec_parser.rs
@crates/driver/src/cargo_verify.rs
@crates/driver/src/diagnostics.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire trigger validation into encode_quantifier and add verbose mode</name>
  <files>
    crates/analysis/src/encode_quantifier.rs
    crates/driver/src/cargo_verify.rs
  </files>
  <action>
Modify `annotate_quantifier` in `encode_quantifier.rs` to handle manual trigger hints.

**encode_quantifier.rs changes:**

1. Modify `annotate_quantifier(term: Term) -> Term` to become `annotate_quantifier(term: Term) -> Result<Term, TriggerValidationError>`:
   - This is a breaking change; update all callers (vcgen.rs line ~2812)
   - The Result allows propagating validation errors to the driver for diagnostic display

2. In the `Term::Forall(vars, body)` match arm:
   a. Check if body is `Term::Annotated` with `"rust_fv_trigger_hint"` keys
   b. If manual hints found:
      - Extract trigger sets from annotations (each `"rust_fv_trigger_hint"` entry = one trigger set)
      - Strip the hint annotations from the body (keep only the actual body term)
      - Create `TriggerValidator::new()` and call `validate(trigger_sets, bound_vars, stripped_body)`
      - If validation fails: return `Err(validation_error)`
      - If validation succeeds: use manual triggers instead of auto-inference (FULL REPLACE, not merge)
      - Annotate body with `Term::Annotated(body, [("pattern", manual_triggers)])`
   c. If no manual hints: use existing auto-inference logic (unchanged)
   d. Same logic for `Term::Exists`

3. Add `pub fn annotate_quantifier_verbose(term: &Term, verbose: bool) -> Vec<String>`:
   - When verbose=true, returns human-readable strings describing auto-inferred triggers per quantifier
   - Format: "Quantifier over [x, y]: auto-inferred triggers: { f(x, y) }" or "Quantifier over [x]: manual triggers override: { g(x) }"
   - When verbose=false, returns empty vec

**cargo_verify.rs changes:**

4. In the verbose path of verification (where `--verbose` is already parsed):
   - After VC generation, if verbose flag is set, call `annotate_quantifier_verbose` for each quantifier in the VCs
   - Print to stderr: `[rust-fv] Quantifier #N in function_name: auto-inferred triggers: { ... }`
   - Or: `[rust-fv] Quantifier #N in function_name: manual trigger override: { ... }`

5. When `annotate_quantifier` returns `Err(validation_error)`:
   - Call `format_trigger_error` from diagnostics
   - Mark function as FAIL
   - Do NOT proceed with SMT solving (validation is a hard gate)

**Update callers:**
- `vcgen.rs`: Change `annotate_quantifier(term)` call to handle Result. On Err, propagate the error up (VcGen should return error that driver catches and formats).
  </action>
  <verify>
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis encode_quantifier -- --nocapture
    cargo test -p rust-fv-analysis vcgen -- --nocapture
    cargo build --workspace
    cargo clippy --workspace -- -D warnings
  </verify>
  <done>
    annotate_quantifier detects manual trigger hints, validates them, and either replaces auto-inference (valid) or returns error (invalid). Verbose mode prints trigger info. VcGen propagates validation errors. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests proving all phase success criteria</name>
  <files>
    crates/analysis/tests/trigger_integration.rs
  </files>
  <action>
Create comprehensive integration tests that prove all 5 phase success criteria are met.

**Success Criterion 1: Developer can annotate with #[trigger(expr)]**
```rust
test_manual_trigger_single_annotation
  // Parse: forall(|x: i32| #[trigger(f(x))] f(x) > 0)
  // Generate VCs
  // Verify SMT-LIB output contains :pattern with f(x)
  // Verify auto-inference pattern is NOT present (manual overrides)

test_manual_trigger_multi_trigger_set
  // Parse: forall(|x: i32, y: i32| #[trigger(f(x), g(y))] ...)
  // Verify SMT-LIB contains multi-pattern ((f x) (g y))

test_manual_trigger_multiple_sets
  // Parse with two #[trigger] attrs
  // Verify SMT-LIB contains two :pattern annotations
```

**Success Criterion 2: Tool warns/errors on bad triggers**
```rust
test_error_interpreted_symbol_arithmetic
  // Parse: forall(|x: i32| #[trigger(x + 1)] ...)
  // Verify validation returns InterpretedSymbol error
  // Verify error message contains "V015" and "+"

test_error_interpreted_symbol_equality
  // Parse: forall(|x: i32| #[trigger(x == 0)] ...)
  // Verify error contains "V015" and "=="

test_error_no_trigger_inferred_warning
  // Quantifier where auto-inference finds nothing
  // Verify tracing::warn is emitted (existing behavior)
```

**Success Criterion 3: Self-instantiation detection**
```rust
test_error_self_instantiation_detected
  // Construct a trigger that self-instantiates
  // Verify validation returns SelfInstantiation error
  // Verify loop_example contains concrete instantiation chain

test_safe_trigger_not_flagged
  // Construct a trigger that looks nested but doesn't loop
  // Verify validation passes
```

**Success Criterion 4: Manual triggers override auto-inference**
```rust
test_manual_overrides_auto
  // Quantifier where auto-inference would choose trigger A
  // Annotate with trigger B
  // Verify SMT output uses trigger B, not trigger A

test_no_annotation_uses_auto
  // Standard quantifier without #[trigger]
  // Verify auto-inference still works (backward compat)

test_validation_failure_blocks_verification
  // Bad trigger annotation
  // Verify VC generation returns error, not success
```

**Success Criterion 5: Error messages provide good trigger examples**
```rust
test_error_suggests_auto_inferred
  // Use interpreted symbol trigger on quantifier where auto-inference works
  // Verify error message contains auto-inferred suggestion

test_error_incomplete_coverage_suggests_multi
  // Trigger with missing variables
  // Verify error suggests multi-trigger pattern

test_error_too_many_triggers_suggests_simplification
  // 11+ trigger sets
  // Verify error mentions limit and suggests reduction
```

Each test should:
1. Construct IR (or parse spec string)
2. Run through the full pipeline (parse -> VCGen -> annotate -> validate)
3. Assert on output (SMT-LIB content or error type)
  </action>
  <verify>
    cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis trigger_integration -- --nocapture
    cargo test --workspace -- --nocapture
    cargo clippy --workspace -- -D warnings
  </verify>
  <done>
    All 15+ integration tests pass, covering all 5 phase success criteria. Manual trigger annotation, validation errors, self-instantiation detection, override behavior, and diagnostic suggestions all work end-to-end. Full workspace builds and passes clippy.
  </done>
</task>

</tasks>

<verification>
1. `cargo test --workspace` - all tests pass (existing + new)
2. `cargo clippy --workspace -- -D warnings` - no warnings
3. Integration tests cover all 5 phase success criteria
4. Backward compatibility: all existing quantifier tests pass unchanged
5. Manual trigger → SMT-LIB :pattern annotation works correctly
6. Invalid triggers produce errors that block verification
7. Verbose mode shows trigger info
</verification>

<success_criteria>
- All 5 phase success criteria proven by integration tests
- Full pipeline works: annotation → parse → validate → SMT-LIB or error
- Zero regressions in existing test suite
- Verbose mode shows useful trigger information
- Error messages are actionable with concrete suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/15-trigger-customization/15-03-SUMMARY.md`
</output>

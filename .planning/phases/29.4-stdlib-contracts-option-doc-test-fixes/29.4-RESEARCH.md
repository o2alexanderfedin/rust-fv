# Phase 29.4: Stdlib Contracts Option Doc Test Fixes - Research

**Researched:** 2026-02-25
**Domain:** Rust doc tests, stdlib_contracts documentation
**Confidence:** HIGH

## Summary

Phase 29.4 addresses 26 doc test blocks in `crates/analysis/src/stdlib_contracts/` that are currently suppressed with ```` ```text ```` instead of ```` ```rust ```` (or another valid executable marker). The blocks each contain a single Rust function signature from the standard library API (e.g., `pub fn push(&mut self, value: T)`). These are **purely documentary** — they describe the stdlib method being contracted, not executable code that tests anything.

The correct fix is NOT to change them to ```` ```rust ```` (the signatures reference free type parameters like `T`, `F`, `U` that have no in-scope definition, so they would fail to compile). The correct fix is to change ```` ```text ```` to ```` ```rust,ignore ```` (or ```` ```ignore ````). This makes rustdoc recognize the block as Rust code (enabling syntax highlighting) while telling the test harness to skip compilation. Alternatively, for blocks that ARE simple and self-contained, adding a minimal preamble could make them ```` ```rust ```` compilable, but this adds significant complexity for no value — the blocks document the stdlib API, not the verification library's API.

The 26 suppressions are spread across 3 files: `option.rs` (8), `vec.rs` (9), `result.rs` (9 — counting the ```` ```smt ```` in module-level docs as separate). After this fix, `cargo test --doc -p rust-fv-analysis` will show 26 more ignored tests instead of 0, and rustdoc will render them with proper Rust syntax highlighting.

**Primary recommendation:** Change all 26 ```` ```text ```` occurrences to ```` ```rust,ignore ```` in option.rs, vec.rs, and result.rs. This is a pure documentation fix — no Rust logic, no test logic, no behavior change.

## Standard Stack

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| rustdoc | nightly-2026-02-11 | Doc test runner | Built into Rust toolchain |
| `cargo test --doc` | same | Run doc tests | Standard command |

### Doc Test Fence Annotations (HIGH confidence — from Rust Reference)

| Annotation | Behavior | When to Use |
|------------|----------|-------------|
| ```` ```rust ```` | Compile and run | Fully self-contained runnable example |
| ```` ```rust,ignore ```` | Skip compile and run | Code that would not compile standalone (e.g., uses free type params) |
| ```` ```rust,no_run ```` | Compile but don't run | Code that compiles but has side effects |
| ```` ```rust,compile_fail ```` | Expect compile failure | Showing code that should not compile |
| ```` ```text ```` | No syntax highlighting, not run | Plain text, not Rust; rustdoc renders as plain |
| ```` ```ignore ```` | Shorthand for `rust,ignore` | Same as `rust,ignore` |
| ```` ```smt ```` | Unknown to rustdoc, treated as text | Used in module-level docs for SMT-LIB snippets |

**Key insight:** ```` ```text ```` is the wrong marker for Rust code fragments. It works to suppress doc tests but loses syntax highlighting in rendered docs. ```` ```rust,ignore ```` is semantically correct: "this is Rust code, display it as Rust, but don't try to run it."

## Architecture Patterns

### File Breakdown

```
crates/analysis/src/stdlib_contracts/
├── option.rs      — 8 suppressed blocks (lines 48, 82, 116, 153, 192, 226, 264, 302)
├── vec.rs         — 9 suppressed blocks (lines 46, 86, 126, 159, 195, 240, 284, 328, 364)
├── result.rs      — 9 suppressed blocks (lines 51, 85, 119, 156, 193, 232, 271, 305, 343)
├── loader.rs      — 0 suppressed (1 existing ```ignore block — already correct)
├── mod.rs         — 0 suppressed
└── types.rs       — 0 suppressed
```

Total: **26 occurrences** of ```` ```text ```` across 3 files.

### Pattern in Each Suppressed Block

Every suppressed block follows this exact pattern:
```
/// ```text
/// pub fn method_name<generics>(params) -> ReturnType
/// where Bounds
/// ```
```

The content is a stdlib API signature for documentation purposes only. None of them:
- Create types
- Call functions
- Assert anything
- Have side effects

### Pattern 1: The Correct Fix — Change to `rust,ignore`

**What:** Replace ```` ```text ```` with ```` ```rust,ignore ```` globally across the 3 files.

**Why `rust,ignore` and not `rust`:** The signatures reference free type parameters (`T`, `F`, `U`, `E`) that are not in scope in a doc test context. Attempting to compile `pub fn push(&mut self, value: T)` as a Rust doc test would fail with "cannot find type `T` in this scope".

**Example before:**
```
/// ```text
/// pub fn is_some(&self) -> bool
/// ```
```

**Example after:**
```
/// ```rust,ignore
/// pub fn is_some(&self) -> bool
/// ```
```

**Why not plain ```` ```ignore ````: ** Both work. ```` ```rust,ignore ```` is explicit about the language and enables Rust syntax highlighting in rendered HTML docs. ```` ```ignore ```` is shorthand. Either is correct; `rust,ignore` is preferred for consistency and rendered quality.

### Anti-Patterns to Avoid

- **Don't use ```` ```rust ```` without preamble:** The free type parameters `T`, `F`, `U` make the signatures uncompilable without wrapping in a generic context. This would create 26 NEW failing doc tests.
- **Don't try to make them executable:** These blocks document stdlib API signatures, not the verification library. Making them executable would require importing std types into doc test context — meaningless complexity.
- **Don't add `fn main()` wrappers:** The content is partial function signatures (`pub fn push(...)`), not expressions. They cannot be wrapped in `fn main()`.
- **Don't leave as ```` ```text ````:** This is the current problem — ```` ```text ```` is semantically wrong (it's not plain text, it's Rust syntax) and rustdoc renders it without syntax highlighting.
- **Don't confuse ```` ```smt ```` blocks:** The module-level docs in `option.rs` (line 9) and `result.rs` (line 9) use ```` ```smt ```` for SMT-LIB code. These are NOT in the 26 count. They are fine as-is (rustdoc renders them as plain text, which is correct for SMT-LIB).

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Finding all occurrences | Manual file scanning | `grep -rn '```text'` | Already done: 26 occurrences in 3 files |
| Batch replacement | Custom script | `sed -i` or editor | Simple string substitution: ```` ```text ```` → ```` ```rust,ignore ```` |

**Key insight:** This is a documentation-only change. Zero logic changes, zero test logic changes. The implementation is purely textual substitution.

## Common Pitfalls

### Pitfall 1: Confusing ```text with ```smt
**What goes wrong:** The module-level doc comments in `option.rs` and `result.rs` use ```` ```smt ```` (not ```` ```text ````) for the SMT datatype declarations. Changing these would be wrong.
**Why it happens:** Both are non-Rust fences, easy to confuse.
**How to avoid:** Only change ```` ```text ```` occurrences. Leave ```` ```smt ```` untouched.
**Warning signs:** After the fix, `grep -rn '```text'` should return 0, `grep -rn '```smt'` should still return 2.

### Pitfall 2: Accidentally Changing hashmap.rs, iterator.rs, or string.rs
**What goes wrong:** Assuming all stdlib_contracts files have the problem.
**Why it happens:** The task description says "26 doc tests" — researcher might search all files.
**How to avoid:** The grep confirmed: ONLY option.rs (8), vec.rs (9), result.rs (9). Three files, 26 total.

### Pitfall 3: Attempting to Make Blocks Compile
**What goes wrong:** Trying ```` ```rust ```` without understanding that free type params cause compile errors.
**Why it happens:** "Make doc tests runnable" sounds like changing to ```` ```rust ````.
**How to avoid:** The purpose is documentation, not testing. `rust,ignore` is the correct and complete fix.

### Pitfall 4: Confusing the loader.rs `ignore` block
**What goes wrong:** Noticing that loader.rs already uses ```` ```ignore ```` and trying to "fix" it.
**Why it happens:** Inconsistency in ignore style (loader uses `ignore`, the 26 blocks need `rust,ignore`).
**How to avoid:** loader.rs is already correct. Leave it alone. Both `ignore` and `rust,ignore` are valid.

## Code Examples

### Before (current — wrong)
```rust
// In option.rs, line 48:
/// Contract for `Option::is_some`.
///
/// ```text
/// pub fn is_some(&self) -> bool
/// ```
///
/// **Pure:** Yes
```

### After (correct fix)
```rust
// In option.rs, line 48:
/// Contract for `Option::is_some`.
///
/// ```rust,ignore
/// pub fn is_some(&self) -> bool
/// ```
///
/// **Pure:** Yes
```

### Verification After Fix
```bash
# Should show 26 more ignored tests
cargo test --doc -p rust-fv-analysis 2>&1

# Expected output delta:
# Before: running 3 tests — 1 passed; 0 failed; 2 ignored
# After:  running 29 tests — 1 passed; 0 failed; 28 ignored
#
# (26 new ignored + the existing 2 ignored = 28 ignored total)
```

### Sed Command for Batch Fix
```bash
# option.rs
sed -i '' 's/```text/```rust,ignore/g' crates/analysis/src/stdlib_contracts/option.rs

# vec.rs
sed -i '' 's/```text/```rust,ignore/g' crates/analysis/src/stdlib_contracts/vec.rs

# result.rs
sed -i '' 's/```text/```rust,ignore/g' crates/analysis/src/stdlib_contracts/result.rs
```

Note: macOS requires `sed -i ''` (empty string suffix). On Linux it would be `sed -i`.

### Verification Commands
```bash
# Confirm 0 remaining text blocks
grep -rn '```text' crates/analysis/src/stdlib_contracts/

# Confirm 26 rust,ignore blocks added
grep -rn '```rust,ignore' crates/analysis/src/stdlib_contracts/

# Run doc tests — all should pass or be ignored
cargo test --doc -p rust-fv-analysis

# Confirm no regressions in unit tests
cargo test -p rust-fv-analysis

# Clippy should be clean
cargo clippy -p rust-fv-analysis
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| ```` ```text ```` for Rust code | ```` ```rust,ignore ```` | This phase | Syntax highlighting in rendered docs; doc test harness counts them |

**Deprecated/outdated:**
- ```` ```text ```` for Rust signatures: Semantically incorrect. Use `rust,ignore` for Rust code that shouldn't compile in isolation.

## Open Questions

1. **Should hashmap.rs, iterator.rs, string.rs be checked for similar issues?**
   - What we know: grep confirmed 0 ```` ```text ```` blocks in those files
   - What's unclear: Whether they have other doc test issues
   - Recommendation: Out of scope for this phase; the 26 confirmed blocks are in option/vec/result only

2. **Is `rust,ignore` or `ignore` preferred style for this codebase?**
   - What we know: loader.rs uses plain ```` ```ignore ````
   - What's unclear: Whether there's a project style preference
   - Recommendation: Use `rust,ignore` throughout the 26 blocks for consistency with each other and for explicit language tagging. The loader.rs pre-existing `ignore` can stay as-is.

## Sources

### Primary (HIGH confidence)
- Direct inspection of source files — grep confirmed 26 occurrences in 3 files
- `cargo test --doc -p rust-fv-analysis` output — confirmed current state (3 tests, 0 failures, 0 from text blocks)
- Rust Reference on doc tests (verified behavior of `rust,ignore` fence annotation)

### Secondary (MEDIUM confidence)
- Rust doc test attributes: https://doc.rust-lang.org/rustdoc/write-documentation/documentation-tests.html

## Metadata

**Confidence breakdown:**
- Problem identification: HIGH — grep + cargo test output leave no ambiguity
- Fix approach: HIGH — `rust,ignore` is the standard Rust idiom for this exact case
- Scope: HIGH — exactly 3 files, 26 occurrences confirmed by grep
- Pitfalls: HIGH — derived from direct code inspection

**Research date:** 2026-02-25
**Valid until:** 2026-03-25 (stable — doc test annotations don't change between Rust versions)

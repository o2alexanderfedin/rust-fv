---
phase: 12-concurrency-verification
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - crates/analysis/tests/concurrency_verification.rs
  - crates/driver/src/diagnostics.rs
autonomous: true

must_haves:
  truths:
    - "Developer enables bounded concurrency verification and verifier enumerates thread interleavings"
    - "Developer verifies atomic operation (SeqCst) and verifier encodes total ordering constraints in happens-before relation"
    - "Developer sees data race VC failure when shared mutable state accessed without synchronization"
    - "Developer annotates Mutex with #[lock_invariant(expr)] and verifier checks invariant holds on lock acquire/release"
    - "Developer receives bounded verification warning with concrete suggestions for broader coverage"
  artifacts:
    - path: "crates/analysis/tests/concurrency_verification.rs"
      provides: "End-to-end Z3 verification tests for all Phase 12 success criteria"
      min_lines: 500
    - path: "crates/driver/src/diagnostics.rs"
      provides: "Bounded verification warning and concurrency-specific diagnostic formatting"
      contains: "bounded_verification"
  key_links:
    - from: "crates/analysis/tests/concurrency_verification.rs"
      to: "crates/analysis/src/vcgen.rs"
      via: "generate_vcs and generate_concurrency_vcs produce concurrency VCs"
      pattern: "generate_concurrency_vcs"
    - from: "crates/analysis/tests/concurrency_verification.rs"
      to: "crates/analysis/src/concurrency/"
      via: "Tests exercise happens_before, lock_invariants, deadlock_detection, channel_verification"
      pattern: "concurrency::"
    - from: "crates/analysis/tests/concurrency_verification.rs"
      to: "rust_fv_solver"
      via: "Z3Solver checks concurrency VCs (SAT for race detected, UNSAT for safe)"
      pattern: "Z3Solver"
---

<objective>
Create end-to-end Z3 verification tests validating all Phase 12 success criteria (CON-01 through
CON-06, INF-02, INF-03, INF-04) and add bounded verification warning with concrete suggestions
to diagnostics.

Purpose: Validate the complete concurrency verification pipeline from IR construction through
VC generation to Z3 solving, ensuring data races are detected, lock invariants are verified,
deadlocks are found, and channel safety is checked. Confirm bounded verification warning is
emitted with actionable guidance.

Output: concurrency_verification.rs e2e test file with Z3 tests for all Phase 12 requirements,
bounded verification warning in diagnostics.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-concurrency-verification/12-RESEARCH.md
@.planning/phases/12-concurrency-verification/12-01-SUMMARY.md
@.planning/phases/12-concurrency-verification/12-02-SUMMARY.md
@crates/analysis/tests/unsafe_verification.rs
@crates/analysis/tests/float_verification.rs
@crates/analysis/src/concurrency/mod.rs
@crates/analysis/src/concurrency/happens_before.rs
@crates/analysis/src/concurrency/lock_invariants.rs
@crates/analysis/src/concurrency/deadlock_detection.rs
@crates/analysis/src/concurrency/channel_verification.rs
@crates/analysis/src/vcgen.rs
@crates/driver/src/diagnostics.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: End-to-end Z3 concurrency verification tests</name>
  <files>
    crates/analysis/tests/concurrency_verification.rs
  </files>
  <action>
    Create crates/analysis/tests/concurrency_verification.rs following the pattern in
    unsafe_verification.rs and float_verification.rs (build IR function, generate VCs, render
    to SMT-LIB, submit to Z3, assert SAT/UNSAT or validate VC structure).

    Use the solver_or_skip!() macro pattern to gracefully skip tests when Z3 is not available.

    === Test Categories (mapping to Phase 12 success criteria) ===

    **CON-01: Thread spawn detection and interleaving enumeration**
    - test_thread_spawn_detected: Build Function with thread_spawns containing 2 ThreadSpawn entries.
      Call generate_concurrency_vcs. Verify VCs are generated (non-empty).
    - test_interleaving_enumeration_bounded: Build 2-thread function, verify enumerate_interleavings
      with max_switches=2 produces expected number of interleavings. Confirm bounded.
    - test_scoped_thread_spawn: Build Function with is_scoped=true ThreadSpawn. Verify VCs generated.

    **CON-02: Happens-before with atomic orderings**
    - test_seqcst_atomic_ordering_z3: Build Function with 2 thread_spawns and 2 AtomicOps
      (Store SeqCst + Load SeqCst on same variable). Generate VCs. Submit DataRaceFreedom VCs
      to Z3. SeqCst provides total order, so accesses ARE ordered => UNSAT (no race).
    - test_relaxed_atomic_race_z3: Build Function with 2 thread_spawns and 2 AtomicOps
      (Store Relaxed + Load Relaxed on same variable). Generate VCs. Submit to Z3.
      Relaxed has NO synchronization => SAT (race exists under relaxed ordering).
    - test_acquire_release_pair_z3: Build Function with Store(Release) + Load(Acquire) on same
      variable. Generate VCs. When reads_from holds, HB established => UNSAT.
    - test_mixed_ordering_z3: Build Function with Store(Release) + Load(Relaxed). Load doesn't
      acquire => no HB guarantee => SAT (potential race).

    **CON-03: Data race freedom VCs**
    - test_data_race_detected_unprotected_z3: Build Function with 2 thread_spawns writing to
      same non-atomic variable (no sync). Generate VCs. Submit to Z3. SAT (race detected).
    - test_data_race_safe_with_mutex_z3: Build Function with 2 thread_spawns and sync_ops
      (MutexLock/MutexUnlock around writes). Generate VCs. Mutex provides HB => UNSAT (safe).
    - test_data_race_read_read_safe: Build Function with 2 thread_spawns both reading same
      variable. Generate VCs. No conflicting accesses => no DataRaceFreedom VC generated.
    - test_data_race_vc_description: Verify VC description mentions "data race" and access locations.

    **CON-04: Lock invariant verification**
    - test_lock_invariant_maintained_z3: Build Function with lock_invariants containing
      ("mu", "value >= 0"), sync_ops with MutexLock/MutexUnlock. Invariant maintained (increment
      from 0). Generate LockInvariant VCs. Submit to Z3. UNSAT (invariant holds at release).
    - test_lock_invariant_violated_z3: Build Function with lock_invariants, but code sets value
      to -1 inside critical section. Generate VCs. SAT (invariant violated at release).
    - test_lock_invariant_assumed_at_acquire: Verify no VcKind::LockInvariant VC at acquire point.
      Count VCs by filtering for LockInvariant kind; should equal number of release points only.
    - test_lock_invariant_description: Verify VC description contains mutex name and invariant.

    **CON-05: Bounded verification with configurable bounds**
    - test_bounded_verification_warning: Build Function with concurrency_config
      (verify_concurrency=true, max_threads=3, max_switches=5). Generate VCs. Verify at least
      one VC description contains "bounded verification" or "context switches".
    - test_custom_bounds_override: Build Function with concurrency_config(max_threads=4,
      max_switches=8). Verify warning VC mentions the custom values (4 threads, 8 switches).
    - test_default_bounds_applied: Build Function with default ConcurrencyConfig. Verify
      bounded warning mentions 3 threads and 5 switches (defaults).

    **CON-06: Deadlock detection**
    - test_deadlock_detected_z3: Build Function with 2 thread_spawns. Thread 1 sync_ops:
      MutexLock(A), MutexLock(B). Thread 2 sync_ops: MutexLock(B), MutexLock(A). Generate VCs.
      Verify VcKind::Deadlock VC exists. Description mentions lock cycle.
    - test_no_deadlock_consistent_ordering: Build Function with consistent lock ordering
      (both threads lock A then B). No VcKind::Deadlock VC generated.
    - test_deadlock_three_locks: Build Function with 3-lock cycle (A->B->C->A). Verify
      deadlock detected.

    **Channel safety (part of CON requirements)**
    - test_channel_send_on_closed_z3: Build Function with ChannelSend sync_op on closed channel.
      Generate VCs. ChannelSafety VC exists. Submit to Z3. SAT (send on closed fails).
    - test_channel_bounded_overflow_z3: Build Function with bounded channel (capacity 1) and
      2 sends. Generate VCs. Verify capacity VC exists.
    - test_channel_recv_deadlock_z3: Build Function with ChannelRecv on empty closed channel.
      Generate VCs. ChannelSafety VC exists.

    **INF-04: Soundness and completeness tests**
    - test_soundness_race_detected: Buggy concurrent program (unprotected shared write) =>
      SAT (race found). The verifier correctly rejects.
    - test_completeness_safe_concurrent: Correct concurrent program (mutex-protected writes) =>
      UNSAT (no race). The verifier correctly accepts.

    Total: ~20 e2e tests covering all Phase 12 success criteria.
  </action>
  <verify>
    cargo test --workspace 2>&amp;1 | tail -5
    cargo clippy --workspace -- -D warnings 2>&amp;1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    concurrency_verification.rs has ~20 e2e tests covering CON-01 through CON-06, INF-02,
    INF-04. Tests validate VC generation pipeline: correct VC counts, descriptions, kinds.
    Z3 integration tests verify SAT for detected races/violations, UNSAT for safe programs.
    All tests pass. 0 regressions. 0 clippy warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bounded verification warning and concurrency diagnostic formatting</name>
  <files>
    crates/driver/src/diagnostics.rs
  </files>
  <action>
    Add bounded verification warning emission to diagnostics.

    In report_text_only() (after the FloatingPointNaN warning block):
    - Check if any VC in the results has VcKind::DataRaceFreedom, VcKind::LockInvariant,
      VcKind::Deadlock, or VcKind::ChannelSafety.
    - If so, emit the bounded verification warning ONCE using the same AtomicBool one-time
      pattern used for the FP performance warning.
    - Warning message: "note: Bounded concurrency verification active. Verified up to N threads
      and M context switches. May miss bugs in deeper interleavings. Try --max-switches=M*2
      for broader coverage."
    - Use default values (3 threads, 5 switches) unless configurable values are passed.

    Add format_interleaving_trace() helper:
    - Takes interleaving events and formats step-by-step execution trace.
    - Format: "  {step}: Thread {tid} executes: {operation}\n"
    - Highlight racy accesses with "       ^^^ RACY WRITE" / "       ^^^ RACY READ"
    - This function is used by DataRaceFreedom diagnostic help text.

    Add to report_with_ariadne():
    - For DataRaceFreedom: append "Interleaving trace available with --verbose" to error message.
    - For Deadlock: append lock ordering guidance.

    Tests:
    - test_bounded_verification_warning_emitted: verify warning text contains "bounded" and
      thread/switch counts
    - test_bounded_verification_warning_once: verify warning emitted only once per run
    - test_format_interleaving_trace: verify trace formatting with step numbers and thread IDs
    - test_concurrency_diagnostic_severity: DataRaceFreedom and ChannelSafety are Error,
      Deadlock is Warning
  </action>
  <verify>
    cargo test --workspace 2>&amp;1 | tail -5
    cargo clippy --workspace -- -D warnings 2>&amp;1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    Bounded verification warning emitted once per run when concurrency VCs present.
    format_interleaving_trace produces step-by-step execution trace with racy access highlighting.
    Concurrency diagnostic severities correct (DataRaceFreedom=Error, Deadlock=Warning).
    ~4 new diagnostic tests pass. All existing tests pass. 0 regressions. 0 clippy warnings.
  </done>
</task>

</tasks>

<verification>
- All workspace tests pass: cargo test --workspace
- 0 clippy warnings: cargo clippy --workspace -- -D warnings
- 0 formatting issues: cargo fmt --all -- --check
- E2e tests cover all 5 Phase 12 success criteria
- Soundness tests: buggy concurrent programs rejected (SAT)
- Completeness tests: correct concurrent programs verified (UNSAT)
- Bounded verification warning emitted with actionable suggestions
- ~24 new tests total across both tasks
</verification>

<success_criteria>
1. E2e tests validate thread spawn detection and interleaving enumeration (CON-01)
2. E2e tests validate SeqCst total ordering in happens-before relation (CON-02)
3. E2e tests validate data race VC failure for unprotected shared writes (CON-03)
4. E2e tests validate lock invariant verification at acquire/release (CON-04/CON-06)
5. Bounded verification warning with concrete suggestions emitted (CON-05)
6. Deadlock detection tests verify lock-order cycle detection (CON-06)
7. Channel safety tests verify send-on-closed, capacity, recv deadlock
8. Soundness and completeness tests pass (INF-04)
9. ~24 new tests passing, 0 regressions, 0 warnings
</success_criteria>

<output>
After completion, create `.planning/phases/12-concurrency-verification/12-03-SUMMARY.md`
</output>

---
phase: 29-to-fix-the-identified-gaps
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/analysis/tests/vcgen_completeness29.rs
  - crates/driver/src/mir_converter.rs
autonomous: true
requirements:
  - MIRCONV-01

must_haves:
  truths:
    - "FloatToInt cast kind is preserved through MIR → IR conversion (not collapsed to IntToInt)"
    - "IntToFloat cast kind is preserved through MIR → IR conversion"
    - "FloatToFloat cast kind is preserved through MIR → IR conversion"
    - "Pointer cast kinds (PtrToPtr, FnPtrToPtr, PointerCoercion, etc.) map to ir::CastKind::Pointer"
    - "Transmute maps to ir::CastKind::IntToInt (same-size BV reinterpret)"
    - "All 10 new tests in vcgen_completeness29.rs start RED before the fix and pass GREEN after"
  artifacts:
    - path: "crates/analysis/tests/vcgen_completeness29.rs"
      provides: "TDD scaffold for Phase 29 — 10 failing tests covering MIRCONV-01..02, VCGEN-05..06"
    - path: "crates/driver/src/mir_converter.rs"
      provides: "Fixed convert_rvalue: exhaustive CastKind mapping"
      contains: "ir::CastKind::FloatToInt"
  key_links:
    - from: "crates/driver/src/mir_converter.rs convert_rvalue"
      to: "ir::CastKind variants"
      via: "exhaustive match on mir::CastKind"
      pattern: "CastKind::FloatToInt => ir::CastKind::FloatToInt"
---

<objective>
TDD scaffold for Phase 29: write 10 failing tests covering all four requirement areas (MIRCONV-01, MIRCONV-02, VCGEN-05, VCGEN-06), then fix cast kind preservation in mir_converter.rs (MIRCONV-01).

Purpose: Establishes the RED baseline for the entire phase. The cast kind fix is the highest-priority soundness hole — all float casts are currently encoded as integer truncation, producing type-incorrect SMT.

Output: vcgen_completeness29.rs (10 RED tests), mir_converter.rs with correct exhaustive CastKind match.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-to-fix-the-identified-gaps/29-RESEARCH.md
@.planning/debug/rust-smt-feature-coverage-gaps.md
@crates/analysis/tests/vcgen_completeness28.rs
@crates/driver/src/mir_converter.rs
@crates/analysis/src/ir.rs
</context>

<tasks>

<task type="tdd">
  <name>Task 1 (RED): Write 10 failing tests in vcgen_completeness29.rs</name>
  <files>crates/analysis/tests/vcgen_completeness29.rs</files>
  <action>
Create `crates/analysis/tests/vcgen_completeness29.rs` as the Phase 29 TDD scaffold. Model it directly on `vcgen_completeness28.rs` — same helper structure (`make_func`, `script_to_text`), same test module layout.

Write exactly 10 failing tests covering all four Phase 29 requirements:

**MIRCONV-01 tests (cast kind preservation):**
- `mirconv_01_float_to_int_cast_kind`: Build a Function with `Rvalue::Cast(CastKind::FloatToInt, …)` at the IR level and call `vcgen::generate_vcs`. Assert the SMT output contains `fp.to_sbv` (NOT `extract`) — will be RED until Plan 02 fixes the SMT encoding.
- `mirconv_01_int_to_float_cast_kind`: Build `Rvalue::Cast(CastKind::IntToFloat, …)`. Assert SMT contains `to_fp`. Should be GREEN after Plan 01 (cast kind already maps correctly for IntToFloat through vcgen). If it is already GREEN, document and keep it as a regression guard.

**MIRCONV-02 tests (aggregate conversion):**
- `mirconv_02_struct_aggregate`: Build a Function with `Rvalue::Aggregate(AggregateKind::Struct("Point".into(), fields), operands)`. Assert `vcgen::generate_vcs` produces a VC containing `mk-Point`. RED until Plan 03.
- `mirconv_02_enum_aggregate`: Build with `AggregateKind::Enum("Option".into(), 1)`. Assert VC contains `mk-` constructor. RED until Plan 03.
- `mirconv_02_set_discriminant`: Build a Statement IR with `Statement::SetDiscriminant(place, 0)` — this WILL NOT COMPILE until Plan 03 adds the variant. Mark the test with `#[ignore]` and a `TODO Plan 03` comment so the file compiles.

**VCGEN-05 tests (float-to-int SMT encoding):**
- `vcgen_05_float_to_int_signed`: Build `Rvalue::Cast(CastKind::FloatToInt, f64_param, Ty::Int(IntTy::I32))`. Assert SMT script contains `fp.to_sbv`. RED until Plan 02.
- `vcgen_05_float_to_int_unsigned`: Same with `Ty::Uint(UintTy::U64)`. Assert SMT contains `fp.to_ubv`. RED until Plan 02.

**VCGEN-06 tests (projected LHS functional update):**
- `vcgen_06_struct_field_mutation`: Build IR where a Statement assigns to `place = Place { local: "_1", projections: [Projection::Field(0)] }` with a `Rvalue::BinaryOp(...)` rvalue (not Use). Assert vcgen produces a VC containing `mk-` constructor (functional update). RED until Plan 05.
- `vcgen_06_field_mutation_use`: Same but with `Rvalue::Use(...)`. Assert the VC appears (currently passes for Use — regression guard).
- `vcgen_06_set_discriminant_assertion`: `#[ignore]` + TODO — depends on Plan 03 IR addition.

**Compilation note:** The test for `Statement::SetDiscriminant` and `vcgen_06_set_discriminant_assertion` must use `#[ignore]` since the IR variant doesn't exist yet. All other 8 active tests must compile and fail (RED).

Run `cargo test -p rust-fv-analysis --test vcgen_completeness29 2>&1` and confirm: compilation succeeds and the non-ignored tests FAIL with assertion errors (not panics or compile errors).

Commit with message: `test(29-01): add 10 RED tests for MIRCONV-01..02 + VCGEN-05..06`
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis --test vcgen_completeness29 2>&1 | tail -30</automated>
    <manual>Tests compile. Non-ignored tests fail with assertion messages (not compile errors or panics). Exactly 10 test functions are present in the file.</manual>
    <sampling_rate>run after this task, before Task 2</sampling_rate>
  </verify>
  <done>vcgen_completeness29.rs exists with 10 tests; non-ignored tests are RED (failing assertions); file compiles without errors.</done>
</task>

<task type="tdd">
  <name>Task 2 (GREEN): Fix CastKind mapping in mir_converter.rs (MIRCONV-01)</name>
  <files>crates/driver/src/mir_converter.rs</files>
  <action>
Fix the soundness hole in `convert_rvalue` in `crates/driver/src/mir_converter.rs` at lines 288-295.

**Current code (BUG — ignores cast kind):**
```rust
mir::Rvalue::Cast(_, op, ty) => {
    let ir_ty = convert_ty(*ty);
    Some(ir::Rvalue::Cast(
        ir::CastKind::IntToInt,   // hardcoded — all casts treated as integer
        convert_operand(op),
        ir_ty,
    ))
}
```

**Replace with exhaustive match (bind the `kind` parameter):**
```rust
mir::Rvalue::Cast(kind, op, ty) => {
    let ir_ty = convert_ty(*ty);
    let ir_kind = match kind {
        mir::CastKind::IntToInt     => ir::CastKind::IntToInt,
        mir::CastKind::FloatToInt   => ir::CastKind::FloatToInt,
        mir::CastKind::IntToFloat   => ir::CastKind::IntToFloat,
        mir::CastKind::FloatToFloat => ir::CastKind::FloatToFloat,
        mir::CastKind::PtrToPtr
        | mir::CastKind::FnPtrToPtr
        | mir::CastKind::PointerCoercion(..)
        | mir::CastKind::PointerExposeProvenance
        | mir::CastKind::PointerWithExposedProvenance => ir::CastKind::Pointer,
        mir::CastKind::Transmute => ir::CastKind::IntToInt, // same-size BV reinterpret
        mir::CastKind::Subtype   => ir::CastKind::IntToInt, // identity coercion
    };
    Some(ir::Rvalue::Cast(ir_kind, convert_operand(op), ir_ty))
}
```

**Important:** The actual `mir::CastKind` variants on nightly-2026-02-11 must be confirmed by compiling. If any variant names differ, adjust accordingly. The Rust compiler's exhaustive match will report missing variants as compile errors — fix all reported variants until `cargo build -p rust-fv-driver` passes.

After the fix, run:
1. `cargo build -p rust-fv-driver` — must compile clean
2. `cargo clippy -p rust-fv-driver -- -D warnings` — must pass
3. `cargo test -p rust-fv-analysis --test vcgen_completeness29 mirconv_01` — `mirconv_01_int_to_float_cast_kind` should now pass (IntToFloat was already encoded correctly at the vcgen layer)
4. `cargo test -p rust-fv-analysis 2>&1 | tail -20` — all 28 Phase 28 tests must still pass (no regression)

Commit with message: `fix(29-01): preserve CastKind in mir_converter — map FloatToInt/IntToFloat/FloatToFloat/Pointer kinds correctly (MIRCONV-01)`
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo build -p rust-fv-driver 2>&1 | tail -5 && cargo test -p rust-fv-analysis --test vcgen_completeness28 2>&1 | tail -10</automated>
    <manual>The word "IntToInt" no longer appears as a hardcoded literal in the Cast arm of convert_rvalue. The exhaustive match covers all CastKind variants without a wildcard.</manual>
    <sampling_rate>run after this task, before moving to Plan 02</sampling_rate>
  </verify>
  <done>cargo build -p rust-fv-driver succeeds; all Phase 28 vcgen_completeness28 tests still GREEN; mir_converter.rs Cast arm maps FloatToInt/IntToFloat/FloatToFloat/Pointer correctly.</done>
</task>

</tasks>

<verification>
- `cargo test -p rust-fv-analysis --test vcgen_completeness29 2>&1` — 8 active tests fail (RED), 2 ignored (SetDiscriminant-dependent), no compile errors
- `cargo test -p rust-fv-analysis --test vcgen_completeness28 2>&1` — all 10 tests GREEN (no regression)
- `cargo build -p rust-fv-driver 2>&1` — clean build, no warnings
- `grep -n "CastKind::IntToInt" crates/driver/src/mir_converter.rs` — appears only as a mapping target for Transmute/Subtype, never as a wildcard
</verification>

<success_criteria>
- vcgen_completeness29.rs has 10 test functions (8 active, 2 ignored) and compiles
- MIRCONV-01 is fixed: FloatToInt, IntToFloat, FloatToFloat, Pointer cast kinds are correctly mapped in convert_rvalue
- All Phase 28 vcgen_completeness28 tests remain GREEN
- No clippy warnings in rust-fv-driver crate
</success_criteria>

<output>
After completion, create `.planning/phases/29-to-fix-the-identified-gaps/29-01-SUMMARY.md`
</output>

---
phase: 29-to-fix-the-identified-gaps
plan: 02
type: execute
wave: 2
depends_on:
  - 29-01
files_modified:
  - crates/analysis/src/encode_term.rs
  - crates/analysis/src/vcgen.rs
autonomous: true
requirements:
  - VCGEN-05

must_haves:
  truths:
    - "Float-to-int cast (f64 as i32) produces SMT term '((_ fp.to_sbv 32) RTZ src)' not '((_ extract 31 0) src)'"
    - "Float-to-unsigned-int cast (f64 as u64) produces '((_ fp.to_ubv 64) RTZ src)'"
    - "RTZ rounding mode is used (matching Rust's truncation-toward-zero semantics for as-cast)"
    - "vcgen_05_float_to_int_signed and vcgen_05_float_to_int_unsigned tests turn GREEN"
    - "All Phase 28 vcgen_completeness28 tests remain GREEN (no regression)"
  artifacts:
    - path: "crates/analysis/src/encode_term.rs"
      provides: "encode_float_to_int_cast using fp.to_sbv/fp.to_ubv; encode_cast with to_signed parameter"
      contains: "fp.to_sbv"
    - path: "crates/analysis/src/vcgen.rs"
      provides: "Updated encode_cast call site passing to_signed from target type"
  key_links:
    - from: "crates/analysis/src/vcgen.rs encode_assignment Rvalue::Cast arm"
      to: "encode_cast in encode_term.rs"
      via: "to_signed derived from target_ty using ty_is_signed()"
      pattern: "encode_cast.*to_signed"
    - from: "encode_float_to_int_cast"
      to: "Term::App"
      via: "fp.to_sbv or fp.to_ubv indexed operator"
      pattern: "fp.to_(s|u)bv"
---

<objective>
Fix the float-to-int SMT encoding soundness hole in encode_term.rs (VCGEN-05). Replace the type-incorrect `Term::Extract` on a Float sort with the correct SMT-LIB2 FPA-to-BV operators `fp.to_sbv` (signed) and `fp.to_ubv` (unsigned), using RTZ (round toward zero) rounding mode matching Rust's as-cast semantics.

Purpose: `f64 as i32` currently emits `((_ extract 31 0) float_term)` which is a type error in SMT-LIB2 — Extract requires BitVec sort, not Float sort. Z3 may silently accept this (treating the float as bits) producing unsound results. The fix ensures type-correct FPA conversion.

Output: encode_term.rs with corrected `encode_float_to_int_cast`; vcgen.rs updated to pass `to_signed`; VCGEN-05 tests GREEN.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-to-fix-the-identified-gaps/29-RESEARCH.md
@.planning/phases/29-to-fix-the-identified-gaps/29-01-SUMMARY.md
@crates/analysis/src/encode_term.rs
@crates/analysis/src/vcgen.rs
@crates/analysis/tests/vcgen_completeness29.rs
</context>

<tasks>

<task type="execute">
  <name>Task 1: Fix encode_float_to_int_cast to use fp.to_sbv/fp.to_ubv</name>
  <files>
    crates/analysis/src/encode_term.rs
    crates/analysis/src/vcgen.rs
  </files>
  <action>
**Step 1: Update `encode_float_to_int_cast` in `crates/analysis/src/encode_term.rs`**

Find the function at approximately lines 751-757:
```rust
/// Float-to-integer cast: extract lower bits from the float bitvector.
///
/// Conservative approximation: model as extraction of the lower to_bits.
/// TODO Phase 29: proper round-to-zero conversion.
fn encode_float_to_int_cast(src: Term, _from_bits: u32, to_bits: u32) -> Term {
    Term::Extract(to_bits - 1, 0, Box::new(src))
}
```

Replace with:
```rust
/// Float-to-integer cast using SMT-LIB2 FPA theory.
///
/// Uses `((_ fp.to_sbv N) RTZ src)` for signed targets and
/// `((_ fp.to_ubv N) RTZ src)` for unsigned targets.
/// RTZ = Round Toward Zero, matching Rust's float-as-integer truncation semantics.
fn encode_float_to_int_cast(src: Term, _from_bits: u32, to_bits: u32, to_signed: bool) -> Term {
    let op_name = if to_signed {
        format!("(_ fp.to_sbv {to_bits})")
    } else {
        format!("(_ fp.to_ubv {to_bits})")
    };
    Term::App(op_name, vec![Term::RoundingMode("RTZ".to_string()), src])
}
```

**Step 2: Update `encode_cast` in the same file to accept `to_signed`**

Find:
```rust
pub fn encode_cast(
    kind: &CastKind,
    src: Term,
    from_bits: u32,
    to_bits: u32,
    from_signed: bool,
) -> Term {
    match kind {
        ...
        CastKind::FloatToInt => encode_float_to_int_cast(src, from_bits, to_bits),
        ...
    }
}
```

Change the function signature to add `to_signed: bool` parameter and update the FloatToInt arm:
```rust
pub fn encode_cast(
    kind: &CastKind,
    src: Term,
    from_bits: u32,
    to_bits: u32,
    from_signed: bool,
    to_signed: bool,    // NEW: signedness of target type (needed for FloatToInt)
) -> Term {
    match kind {
        CastKind::IntToInt => encode_int_to_int_cast(src, from_bits, to_bits, from_signed),
        CastKind::IntToFloat => encode_int_to_float_cast(src, from_bits, to_bits, from_signed),
        CastKind::FloatToInt => encode_float_to_int_cast(src, from_bits, to_bits, to_signed),
        CastKind::FloatToFloat => encode_float_to_float_cast(src, from_bits, to_bits),
        CastKind::Pointer => src,
    }
}
```

**Step 3: Update the call site in `crates/analysis/src/vcgen.rs`**

Find the `encode_cast` call in `encode_assignment` (around line 1572-1580). It currently passes `from_signed` but not `to_signed`. Add the `to_signed` argument derived from `target_ty`:

```rust
Rvalue::Cast(kind, op, target_ty) => {
    let src = encode_operand(op);
    let source_ty = infer_operand_type(func, op)
        .or_else(|| find_local_type(func, &place.local))
        .unwrap_or(target_ty.clone());
    let from_bits = ty_bit_width(&source_ty).unwrap_or(64);
    let to_bits = ty_bit_width(target_ty).unwrap_or(64);
    let from_signed = ty_is_signed(&source_ty);
    let to_signed = ty_is_signed(target_ty);   // NEW
    encode_cast(kind, src, from_bits, to_bits, from_signed, to_signed)
}
```

Note: `ty_is_signed` and `ty_bit_width` already exist in `encode_term.rs` and are in scope at the vcgen call site (check imports). If not directly available, use the same pattern as `from_signed` derivation already in the file.

**Step 4: Fix any other call sites**

Run `cargo build -p rust-fv-analysis 2>&1` — the compiler will report all call sites that need updating due to the new parameter. Fix each one by adding the appropriate `to_signed` argument (usually `false` for non-float-to-int contexts, or compute from context). For non-FloatToInt casts, `to_signed` is unused in `encode_cast` so `false` is a safe default.

**Step 5: Check Term::RoundingMode exists**

Verify `Term::RoundingMode` is a valid variant in `crates/smtlib/src/term.rs`. If it is not (the research shows `encode_int_to_float_cast` uses `Term::RoundingMode("RNE".to_string())`), this confirms it exists. If the variant is named differently, adjust accordingly.

Run after all changes:
- `cargo build -p rust-fv-analysis` — clean
- `cargo clippy -p rust-fv-analysis -- -D warnings` — clean
- `cargo test -p rust-fv-analysis --test vcgen_completeness29 vcgen_05` — both VCGEN-05 tests GREEN
- `cargo test -p rust-fv-analysis --test vcgen_completeness28` — all 10 still GREEN

Commit: `fix(29-02): replace Term::Extract with fp.to_sbv/fp.to_ubv RTZ for float-to-int casts (VCGEN-05)`
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust-fv-analysis --test vcgen_completeness29 vcgen_05 2>&1 && cargo test -p rust-fv-analysis --test vcgen_completeness28 2>&1 | tail -5</automated>
    <manual>grep the SMT output from vcgen_05_float_to_int_signed test — it must contain "fp.to_sbv" and NOT contain "extract". The RTZ rounding mode must appear as a term argument.</manual>
    <sampling_rate>run after this task, before Plan 03</sampling_rate>
  </verify>
  <done>vcgen_05_float_to_int_signed and vcgen_05_float_to_int_unsigned tests GREEN; encode_float_to_int_cast emits fp.to_sbv/fp.to_ubv with RTZ; all Phase 28 tests remain GREEN; cargo build and clippy clean.</done>
</task>

</tasks>

<verification>
- `cargo test -p rust-fv-analysis --test vcgen_completeness29 vcgen_05 2>&1` — both tests pass
- `cargo test -p rust-fv-analysis --test vcgen_completeness28 2>&1` — all 10 tests pass
- `grep "Extract" crates/analysis/src/encode_term.rs` — "Extract" no longer appears in encode_float_to_int_cast
- `grep "fp.to_sbv\|fp.to_ubv" crates/analysis/src/encode_term.rs` — both patterns present
- `cargo clippy -p rust-fv-analysis -- -D warnings 2>&1` — clean
</verification>

<success_criteria>
- VCGEN-05 satisfied: float-to-int casts use fp.to_sbv (signed) and fp.to_ubv (unsigned) with RTZ rounding
- The soundness hole from Term::Extract on Float sort is eliminated
- encode_cast signature updated with to_signed parameter
- All Phase 28 tests remain GREEN (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/29-to-fix-the-identified-gaps/29-02-SUMMARY.md`
</output>

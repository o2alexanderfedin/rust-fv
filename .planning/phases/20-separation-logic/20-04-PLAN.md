---
phase: 20-separation-logic
plan: 04
type: tdd
wave: 3
depends_on:
  - 20-03
files_modified:
  - crates/analysis/src/sep_logic.rs
  - crates/analysis/src/spec_parser.rs
  - crates/analysis/src/vcgen.rs
  - tests/sep_logic_integration.rs
autonomous: true
requirements:
  - SEP-01
  - SEP-02
  - SEP-03
  - SEP-04

must_haves:
  truths:
    - "pts_to(p, v) in a requires clause produces an UNSAT VC when a caller passes a valid pointer"
    - "pts_to(p, v) * pts_to(q, w) in a requires clause produces an UNSAT VC proving disjoint ownership"
    - "A function modifying a single pointed-to value leaves the rest of sep_heap unchanged per the frame axiom"
    - "A ghost predicate linked_list(p, n) expanded to depth 3 produces a satisfiable VC for a valid list"
  artifacts:
    - path: "tests/sep_logic_integration.rs"
      provides: "E2E integration tests for all 4 SEP requirements verified against Z3"
      contains: "sep_01_pts_to"
    - path: "crates/analysis/src/sep_logic.rs"
      provides: "All functions from Plans 01+03 remain present and correct"
      contains: "build_frame_axiom"
  key_links:
    - from: "tests/sep_logic_integration.rs"
      to: "rust_fv_analysis::vcgen::generate_vcs"
      via: "generates VCs from IR functions with sep-logic contracts, submits to Z3"
      pattern: "generate_vcs"
    - from: "tests/sep_logic_integration.rs"
      to: "rust_fv_smtlib"
      via: "renders SMT scripts and runs Z3 to validate UNSAT/SAT"
      pattern: "Script::render"
---

<objective>
Write and pass integration tests proving all four SEP requirements hold end-to-end with Z3.

Purpose: Plans 01-03 built the infrastructure. This plan verifies that the full pipeline — spec annotation → IR → VCGen → SMT → Z3 — works correctly for each requirement. Tests follow RED→GREEN→REFACTOR. A failing test means the infrastructure has a gap that must be fixed before this plan completes.

Output: `tests/sep_logic_integration.rs` with 4 named E2E tests, each verified against a live Z3 instance.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-separation-logic/20-RESEARCH.md
@.planning/phases/20-separation-logic/20-03-SUMMARY.md

@crates/analysis/src/sep_logic.rs
@crates/analysis/src/vcgen.rs
@crates/analysis/src/spec_parser.rs
@crates/analysis/src/ghost_predicate_db.rs
</context>

<feature>
  <name>Separation Logic E2E Integration Tests</name>
  <files>tests/sep_logic_integration.rs</files>
  <behavior>
Four tests, one per SEP requirement.

**Test sep_01_pts_to_ownership:**
- Build an IR Function `write_ptr` with: param `p: *const i32` (pointer), param `v: i32`, requires `pts_to(p, v)`, ensures `pts_to(p, v)`.
- Generate VCs via `generate_vcs(&func, None)`.
- Precondition VC should be UNSAT (the pts_to encoding is satisfiable under the sep_heap model).
- Assert Z3 returns `sat` for the raw pts_to term encoded as a standalone check, or `unsat` for the negation of a correctly encoded precondition.

**Test sep_02_separating_conjunction:**
- Build an IR Function `swap_ptrs` with: params `p: *const i32`, `q: *const i32`, `x: i32`, `y: i32`. Requires `pts_to(p, x) * pts_to(q, y)`.
- Generate VCs. The precondition should be satisfiable (both pointers owned).
- Assert the sep_heap model allows both pts_to assertions simultaneously (Z3 returns `sat` for the conjunction).

**Test sep_03_frame_rule:**
- Build a caller IR Function `caller` that calls a callee `write_one_ptr` with spec `requires: pts_to(p, old_v)`, `ensures: pts_to(p, new_v)`.
- Generate call-site VCs for `caller`.
- Assert the VC script contains a `forall` term (the frame axiom) and uses `AUFBV` logic.
- Assert Z3 returns `unsat` for the frame axiom negation (i.e., the axiom is valid).

**Test sep_04_ghost_predicate_unfold:**
- Construct a `GhostPredicateDatabase` containing `is_null_list(p, n): if n == 0 { true } else { pts_to(p, 0i64) }` (a simplified base case).
- Parse spec `"is_null_list(p, 1)"` with the DB at depth 3.
- Assert the result is `Some(term)` (not None) and contains a pts_to encoding (a `Term::And` somewhere in the tree).
- Assert parsing with depth 0 returns `Some(Term::BoolLit(false))`.

All tests assert Z3 is available (skip with `eprintln!` if Z3 binary not found, same pattern as existing E2E tests in the codebase).

Input→Output contracts:
- `"pts_to(p, v)"` with valid IR → `Some(Term::And([Select(perm,p), Eq(heapval_accessor(Select(sep_heap,p)), v)]))`
- `"pts_to(p,x) * pts_to(q,y)"` → `Some(Term::And([pts_to_p, pts_to_q]))`
- callee with pts_to in requires → call-site VC script contains `(forall` and `AUFBV`
- ghost pred call at depth 3 → expanded body term; at depth 0 → `BoolLit(false)`
  </behavior>
  <implementation>
TDD cycle:

**RED:** Write all 4 test stubs with `assert!(false, "not yet implemented")` body. Run `cargo test -p rust_fv_analysis --test sep_logic_integration` — all 4 must FAIL. Commit: `test(20-04): add failing sep-logic integration tests`.

**GREEN:** Implement each test body using the helper patterns from existing E2E tests in the codebase (search for `assert_all_unsat`, `Z3Solver::new()`, `Script::render` patterns in vcgen.rs tests). Fix any infrastructure gaps found during test implementation by patching the relevant Plan 01-03 files. Run tests until all 4 pass. Commit: `feat(20-04): all 4 sep-logic integration tests passing`.

**REFACTOR:** Extract shared test helpers (e.g., `build_ptr_func(name, ptr_param, val_param, requires_raw)`) to reduce duplication. Ensure each test has a clear comment explaining what SEP requirement it validates. Run tests again to confirm still green. Commit: `refactor(20-04): extract sep-logic test helpers`.

**Common infrastructure needed:**
- Build an `IR::Function` with `RawPtr` parameter types (check existing `unsafe_analysis` tests for the pattern).
- Pass a `GhostPredicateDatabase` into the spec parser (use `parse_spec_expr_with_db` from Plan 03).
- Render scripts to SMT-LIB string and run Z3 (use the existing Z3 integration test helper pattern).

Look for existing Z3 E2E test patterns in:
- `crates/analysis/src/vcgen.rs` `#[cfg(test)]` section (search for `fn test_` near the bottom)
- `crates/driver/src/` integration tests
  </implementation>
</feature>

<verification>
1. `cargo test --test sep_logic_integration 2>&1 | grep -E "PASSED|FAILED|ok|FAILED"` — all 4 tests show `ok`
2. `cargo test -p rust_fv_analysis 2>&1 | grep FAILED` → empty (no regressions in unit tests)
3. `cargo test -p rust_fv_driver 2>&1 | grep FAILED` → empty
4. `cargo clippy --all -- -D warnings 2>&1 | grep -c warning` → `0`
5. `cargo build --all 2>&1 | grep -c error` → `0`
</verification>

<success_criteria>
- 4 integration tests exist in `tests/sep_logic_integration.rs`
- All 4 tests pass: `sep_01_pts_to_ownership`, `sep_02_separating_conjunction`, `sep_03_frame_rule`, `sep_04_ghost_predicate_unfold`
- Tests cover the observable user-facing behavior from each SEP requirement's success criterion
- All 51+ existing tests continue to pass (zero regressions)
- `cargo verify` (the CLI) builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-separation-logic/20-04-SUMMARY.md` following the summary template.
</output>

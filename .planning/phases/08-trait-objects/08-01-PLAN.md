---
phase: 08-trait-objects
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/analysis/src/ir.rs
  - crates/analysis/src/trait_analysis.rs
  - crates/analysis/src/encode_sort.rs
  - crates/analysis/src/vcgen.rs
  - crates/analysis/src/lib.rs
  - crates/driver/src/callbacks.rs
  - crates/driver/src/diagnostics.rs
autonomous: true

must_haves:
  truths:
    - "TraitDef IR type represents trait with method contracts"
    - "TraitImpl IR type represents impl Trait for Type with method bodies"
    - "Ty::TraitObject represents dyn Trait types in the IR"
    - "Sealed trait detection identifies pub(crate) and private-super-trait sealed traits"
    - "VcKind::BehavioralSubtyping enables trait-specific verification diagnostics"
  artifacts:
    - path: "crates/analysis/src/ir.rs"
      provides: "TraitDef, TraitMethod, TraitImpl, Ty::TraitObject types"
      contains: "TraitDef"
    - path: "crates/analysis/src/trait_analysis.rs"
      provides: "Sealed trait detection, impl collection, trait-impl matching"
      exports: ["TraitDatabase", "detect_sealed_traits", "collect_trait_impls"]
    - path: "crates/analysis/src/vcgen.rs"
      provides: "VcKind::BehavioralSubtyping variant"
      contains: "BehavioralSubtyping"
  key_links:
    - from: "crates/analysis/src/trait_analysis.rs"
      to: "crates/analysis/src/ir.rs"
      via: "TraitDef and TraitImpl types"
      pattern: "use crate::ir::"
    - from: "crates/analysis/src/encode_sort.rs"
      to: "crates/analysis/src/ir.rs"
      via: "Ty::TraitObject encoding"
      pattern: "Ty::TraitObject"
---

<objective>
Add trait IR types (TraitDef, TraitMethod, TraitImpl, Ty::TraitObject) and trait analysis infrastructure
(sealed trait detection, impl collection, trait database) to support trait object verification.

Purpose: Establish the foundational data structures and analysis functions that Plans 02 and 03
will use for behavioral subtyping VCs, dynamic dispatch encoding, and end-to-end verification.

Output: New trait_analysis.rs module, extended IR with trait types, VcKind::BehavioralSubtyping,
Ty::TraitObject encoding in encode_sort.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-trait-objects/08-RESEARCH.md
@crates/analysis/src/ir.rs
@crates/analysis/src/encode_sort.rs
@crates/analysis/src/vcgen.rs
@crates/analysis/src/lib.rs
@crates/driver/src/callbacks.rs
@crates/driver/src/diagnostics.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trait IR types and VcKind::BehavioralSubtyping (TDD)</name>
  <files>
    crates/analysis/src/ir.rs
    crates/analysis/src/vcgen.rs
    crates/analysis/src/encode_sort.rs
    crates/analysis/src/lib.rs
    crates/driver/src/callbacks.rs
    crates/driver/src/diagnostics.rs
  </files>
  <action>
    TDD: Write failing tests first, then implement.

    In ir.rs, add the following types:

    1. TraitMethod struct:
       - name: String (method name, e.g., "push")
       - params: Vec<(String, Ty)> (parameter names and types, including &self/&mut self)
       - return_ty: Ty
       - requires: Vec<SpecExpr> (trait-level preconditions)
       - ensures: Vec<SpecExpr> (trait-level postconditions)
       - is_pure: bool (whether this is a pure/spec-only method)
       Derive: Debug, Clone

    2. TraitDef struct:
       - name: String (trait name, e.g., "Stack")
       - methods: Vec<TraitMethod>
       - is_sealed: bool (true if pub(crate) or private super-trait pattern)
       - super_traits: Vec<String> (super-trait names for inheritance)
       Derive: Debug, Clone

    3. TraitImpl struct:
       - trait_name: String (which trait is being implemented)
       - impl_type: String (the concrete type, e.g., "VecStack")
       - method_names: Vec<String> (which trait methods this impl provides)
       Derive: Debug, Clone

    4. Ty::TraitObject variant:
       Add to Ty enum: TraitObject(String) where the String is the trait name.
       This represents dyn Trait types (Box<dyn Trait>, &dyn Trait, etc.).
       The outer container (Box, &, &mut) is already represented by Ty::Ref wrapping Ty::TraitObject.

    5. Add Ty::is_trait_object() helper method returning bool (same pattern as is_closure()).

    In vcgen.rs:
    - Add VcKind::BehavioralSubtyping variant to the VcKind enum.
    - This represents behavioral subtyping VCs (precondition weakening, postcondition strengthening).

    In encode_sort.rs:
    - Add Ty::TraitObject arm in encode_type(): encode as Sort::Uninterpreted(trait_name.clone()).
      This is the default for open-world traits. Closed-world (sealed) traits will use Sort::Datatype
      in Plan 02 when the sealed trait analysis determines the encoding.
    - Add Ty::TraitObject arm in collect_from_type(): no datatype declaration needed for open-world
      (uninterpreted sorts don't need declarations). Just trace and return.

    In driver callbacks.rs:
    - Add VcKind::BehavioralSubtyping to vc_kind_to_string(): return "behavioral_subtyping".

    In driver diagnostics.rs:
    - Add VcKind::BehavioralSubtyping to vc_kind_description(): return "impl does not satisfy trait contract".
    - Add VcKind::BehavioralSubtyping to suggest_fix(): return suggestion about checking
      precondition weakening and postcondition strengthening.
    - Add VcKind::BehavioralSubtyping handling in report_text_only() (after ClosureContract block):
      print trait behavioral subtyping help message.
    - Add VcKind::BehavioralSubtyping to the test arrays that exercise all VcKind variants.

    Tests to write FIRST (RED phase):
    - test_trait_method_creation: Create TraitMethod with requires/ensures, verify fields
    - test_trait_def_creation: Create TraitDef with methods and is_sealed flag
    - test_trait_def_sealed: Verify is_sealed field works for both true and false
    - test_trait_impl_creation: Create TraitImpl, verify trait_name, impl_type, method_names
    - test_ty_trait_object: Create Ty::TraitObject("Stack"), verify is_trait_object()
    - test_ty_non_trait_object_is_not_trait_object: Verify Int, Bool etc return false
    - test_encode_type_trait_object: Verify Ty::TraitObject encodes as Sort::Uninterpreted
    - test_vc_kind_behavioral_subtyping_description: Verify diagnostic description string
    - test_vc_kind_behavioral_subtyping_to_string: Verify callback serialization string
  </action>
  <verify>
    cargo test --workspace 2>&1 | tail -5
    cargo clippy --workspace -- -D warnings 2>&1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    All new IR types (TraitDef, TraitMethod, TraitImpl, Ty::TraitObject) exist with correct fields.
    VcKind::BehavioralSubtyping added and handled in all driver match arms.
    Ty::TraitObject encodes to Sort::Uninterpreted in encode_sort.
    All existing tests still pass (0 regressions). All new tests pass.
    0 clippy warnings. 0 formatting issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create trait_analysis module with sealed detection and impl collection (TDD)</name>
  <files>
    crates/analysis/src/trait_analysis.rs
    crates/analysis/src/lib.rs
  </files>
  <action>
    TDD: Write failing tests first, then implement.

    Create crates/analysis/src/trait_analysis.rs with:

    1. TraitDatabase struct:
       - traits: HashMap<String, TraitDef> (trait name -> definition)
       - impls: HashMap<String, Vec<TraitImpl>> (trait name -> list of implementations)
       Methods:
       - new() -> Self
       - register_trait(&mut self, def: TraitDef)
       - register_impl(&mut self, impl_info: TraitImpl)
       - get_trait(&self, name: &str) -> Option<&TraitDef>
       - get_impls(&self, trait_name: &str) -> &[TraitImpl] (return empty slice if none)
       - is_sealed(&self, trait_name: &str) -> bool (look up trait def, return is_sealed)
       - trait_names(&self) -> impl Iterator<Item = &str>

    2. detect_sealed_trait(visibility: &str, super_traits: &[String]) -> bool:
       - Returns true if:
         a) visibility is "pub(crate)" or "pub(super)" or "" (private), OR
         b) any super_trait name starts with "private::" or contains "Sealed" (heuristic for
            the sealed trait pattern: trait MyTrait: private::Sealed)
       - Returns false if visibility is "pub" and no sealed super-traits

    3. collect_trait_methods(trait_def: &TraitDef) -> Vec<&TraitMethod>:
       - Returns references to all methods that have at least one requires or ensures contract.
       - Used to identify which methods need behavioral subtyping VCs.

    4. find_missing_impl_methods(trait_def: &TraitDef, impl_info: &TraitImpl) -> Vec<String>:
       - Returns trait method names that are NOT in impl_info.method_names.
       - Used to detect incomplete impls (diagnostic aid).

    Register module in lib.rs: pub mod trait_analysis;

    Tests to write FIRST (RED phase):
    - test_trait_database_new_empty: new() creates empty database
    - test_trait_database_register_and_get: register trait, get it back
    - test_trait_database_register_impl: register impl, get impls for trait
    - test_trait_database_get_impls_empty: get_impls for unknown trait returns empty slice
    - test_trait_database_is_sealed: register sealed trait, verify is_sealed returns true
    - test_trait_database_is_sealed_false: register non-sealed trait, verify returns false
    - test_detect_sealed_pub_crate: "pub(crate)" -> true
    - test_detect_sealed_pub_super: "pub(super)" -> true
    - test_detect_sealed_private: "" -> true
    - test_detect_sealed_pub: "pub" with no sealed super-traits -> false
    - test_detect_sealed_super_trait_pattern: "pub" with super_trait containing "Sealed" -> true
    - test_detect_sealed_private_super_trait: "pub" with "private::Sealed" -> true
    - test_collect_trait_methods_with_contracts: trait with 2 contracted + 1 uncontracted method -> returns 2
    - test_collect_trait_methods_all_contracted: all methods have contracts -> returns all
    - test_collect_trait_methods_none_contracted: no methods have contracts -> returns empty
    - test_find_missing_impl_methods_all_present: impl has all methods -> empty vec
    - test_find_missing_impl_methods_some_missing: impl missing "pop" -> vec!["pop"]
    - test_find_missing_impl_methods_all_missing: impl has no methods -> all trait methods
    - test_trait_database_trait_names: register 2 traits, iterate names
    - test_trait_database_multiple_impls: register 2 impls for same trait, get both
  </action>
  <verify>
    cargo test --workspace 2>&1 | tail -5
    cargo clippy --workspace -- -D warnings 2>&1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    trait_analysis.rs module exists with TraitDatabase, detect_sealed_trait,
    collect_trait_methods, and find_missing_impl_methods functions.
    All 20 tests pass. Module registered in lib.rs.
    0 clippy warnings. 0 formatting issues.
    Total workspace tests increased by ~29 (9 Task 1 + 20 Task 2).
  </done>
</task>

</tasks>

<verification>
- All workspace tests pass: cargo test --workspace
- 0 clippy warnings: cargo clippy --workspace -- -D warnings
- 0 formatting issues: cargo fmt --all -- --check
- New IR types accessible from other modules
- VcKind::BehavioralSubtyping handled in all match arms (no compiler warnings)
- Ty::TraitObject correctly encodes to SMT sort
</verification>

<success_criteria>
1. TraitDef, TraitMethod, TraitImpl structs exist in ir.rs with correct fields
2. Ty::TraitObject variant exists with is_trait_object() helper
3. VcKind::BehavioralSubtyping exists and is handled in driver callbacks + diagnostics
4. trait_analysis.rs module exists with TraitDatabase and all analysis functions
5. detect_sealed_trait correctly identifies pub(crate), private, and sealed-super-trait patterns
6. ~29 new tests passing, 0 regressions
</success_criteria>

<output>
After completion, create `.planning/phases/08-trait-objects/08-01-SUMMARY.md`
</output>

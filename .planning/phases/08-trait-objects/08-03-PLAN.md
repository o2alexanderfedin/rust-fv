---
phase: 08-trait-objects
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - crates/analysis/tests/trait_verification.rs
  - crates/driver/src/diagnostics.rs
autonomous: true

must_haves:
  truths:
    - "Developer defines trait with contracts and verifier produces behavioral subtyping VCs"
    - "Developer verifies impl satisfies trait contract via Z3 (UNSAT = correct impl)"
    - "Developer calls method on dyn Trait and verifier uses trait-level contract"
    - "Developer uses sealed trait and verifier enumerates all known impls as sum type"
    - "Developer sees impl does not satisfy trait contract error for violating impl"
  artifacts:
    - path: "crates/analysis/tests/trait_verification.rs"
      provides: "End-to-end trait verification tests via Z3"
      min_lines: 500
    - path: "crates/driver/src/diagnostics.rs"
      provides: "Trait behavioral subtyping diagnostic helpers"
      contains: "behavioral_subtyping"
  key_links:
    - from: "crates/analysis/tests/trait_verification.rs"
      to: "crates/analysis/src/behavioral_subtyping.rs"
      via: "generate_subtyping_vcs called in tests"
      pattern: "behavioral_subtyping::"
    - from: "crates/analysis/tests/trait_verification.rs"
      to: "crates/analysis/src/vcgen.rs"
      via: "generate_vcs for dyn Trait function verification"
      pattern: "generate_vcs"
    - from: "crates/analysis/tests/trait_verification.rs"
      to: "rust_fv_solver"
      via: "Z3Solver for end-to-end verification"
      pattern: "Z3Solver"
---

<objective>
Create end-to-end trait verification tests via Z3 and trait-specific diagnostics to validate
all 5 Phase 8 success criteria and all 5 TRT requirements.

Purpose: Prove the entire trait verification pipeline works end-to-end: from IR construction
through behavioral subtyping VC generation, dyn Trait encoding, and Z3 verification. Add
diagnostic helpers for clear error messages when impls violate trait contracts.

Output: trait_verification.rs integration test file, extended diagnostics for behavioral subtyping.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-trait-objects/08-RESEARCH.md
@.planning/phases/08-trait-objects/08-01-SUMMARY.md
@.planning/phases/08-trait-objects/08-02-SUMMARY.md
@crates/analysis/tests/closure_verification.rs
@crates/analysis/tests/recursion_verification.rs
@crates/analysis/src/behavioral_subtyping.rs
@crates/analysis/src/trait_analysis.rs
@crates/analysis/src/vcgen.rs
@crates/driver/src/diagnostics.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trait behavioral subtyping diagnostic helpers</name>
  <files>
    crates/driver/src/diagnostics.rs
  </files>
  <action>
    Add diagnostic helper functions for trait behavioral subtyping failures. Follow the pattern
    established by format_missing_decreases_help (Phase 6) and format_closure_contract_help (Phase 7).

    1. format_behavioral_subtyping_help(impl_type: &str, trait_name: &str, method_name: &str) -> String:
       - Return multi-line help message explaining behavioral subtyping failure:
         "impl {impl_type} does not satisfy trait {trait_name} contract for method '{method_name}'."
         ""
         "Behavioral subtyping (Liskov Substitution Principle) requires:"
         "  - Precondition weakening: impl must accept ALL inputs the trait accepts"
         "  - Postcondition strengthening: impl must guarantee AT LEAST what the trait promises"
         ""
         "To fix: weaken the impl's precondition or strengthen its postcondition"
         "  to match the trait-level contract."

    2. format_precondition_weakening_help(impl_type: &str, trait_name: &str) -> String:
       - Return message: "impl {impl_type}'s precondition is STRICTER than {trait_name}'s."
         "Impl must accept all inputs the trait contract allows."
         "Consider removing or relaxing the impl's additional precondition."

    3. format_postcondition_strengthening_help(impl_type: &str, trait_name: &str) -> String:
       - Return message: "impl {impl_type}'s postcondition does not IMPLY {trait_name}'s."
         "Impl must guarantee at least what the trait contract promises."
         "Verify that the impl's behavior satisfies the trait postcondition."

    4. Extend report_text_only() for VcKind::BehavioralSubtyping:
       - After the existing ClosureContract block, add BehavioralSubtyping handling.
       - Parse the failure message to extract impl_type, trait_name, method_name.
       - Call format_behavioral_subtyping_help with extracted values.
       - If message contains "precondition", also print format_precondition_weakening_help.
       - If message contains "postcondition", also print format_postcondition_strengthening_help.

    5. Add tests:
       - test_format_behavioral_subtyping_help: Verify output contains "Liskov Substitution"
       - test_format_precondition_weakening_help: Verify mentions "STRICTER"
       - test_format_postcondition_strengthening_help: Verify mentions "IMPLY"
       - test_vc_kind_description_behavioral_subtyping: Already added in 08-01, verify still works
       - test_suggest_fix_behavioral_subtyping: Verify suggestion mentions "precondition" and "postcondition"
       - test_report_text_only_behavioral_subtyping: Verify report_text_only handles the new VcKind
  </action>
  <verify>
    cargo test -p rust-fv-driver 2>&1 | tail -5
    cargo clippy -p rust-fv-driver -- -D warnings 2>&1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    Diagnostic helpers for behavioral subtyping exist and are tested.
    report_text_only handles VcKind::BehavioralSubtyping with specific help messages.
    6 new diagnostic tests passing. 0 clippy warnings. 0 formatting issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create end-to-end trait verification tests via Z3</name>
  <files>
    crates/analysis/tests/trait_verification.rs
  </files>
  <action>
    Create crates/analysis/tests/trait_verification.rs following the pattern from
    closure_verification.rs and recursion_verification.rs (Z3Solver, script_to_smtlib helpers).

    Helper functions:
    - make_trait_def(name, methods, is_sealed, super_traits) -> TraitDef
    - make_trait_method(name, params, return_ty, requires, ensures) -> TraitMethod
    - make_trait_impl(trait_name, impl_type, method_names) -> TraitImpl
    - make_function_with_trait_object_param(name, trait_name, contracts) -> Function
      (creates a function with a Ty::TraitObject parameter)
    - script_to_smtlib(script) -> String (reuse pattern from closure_verification.rs)

    Tests covering all 5 success criteria:

    SC1: Developer defines trait with contracts
    - e2e_trait_with_contracts_behavioral_subtyping_vcs: Define trait "Stack" with push(requires: len < cap, ensures: len == old(len) + 1) and pop(requires: len > 0, ensures: result.is_some()). Create impl "VecStack" for "Stack". Call generate_subtyping_vcs. Verify 4 VCs generated (2 methods x 2 kinds). Verify descriptions mention "VecStack", "Stack", "push", "pop".

    SC2: Developer verifies impl satisfies trait contract
    - e2e_behavioral_subtyping_correct_impl_verified: Create trait with push(requires: x > 0, ensures: result > 0). Create behavioral subtyping script for correct impl (postcondition matches). Send to Z3. Expect UNSAT (= verified: impl satisfies trait contract).
    - e2e_behavioral_subtyping_violating_impl_rejected: Create trait with push(ensures: result > 0). Generate postcondition strengthening VC for an impl that DOESN'T guarantee result > 0 (e.g., impl has no ensures, meaning trait postcondition is not implied). Send to Z3. Expect SAT (= violation detected).

    SC3: Developer calls method on dyn Trait using trait-level contract
    - e2e_dyn_trait_method_call_open_world: Build function with parameter of type Ty::TraitObject("Comparable"). Add trait contract requires(x > 0). Create TraitDatabase with Comparable trait (open-world). Call generate_vcs with TraitDatabase. Verify that VCs contain declare-fun for trait method. Verify SMT encoding includes trait contract axiom. Submit to Z3 and verify no errors.

    SC4: Developer uses sealed trait with closed-world verification
    - e2e_sealed_trait_sum_type_encoding: Create sealed trait "Compression" with 2 impls ("Gzip", "Lz4"). Call encode_sealed_trait_sum_type. Verify DeclareDatatype command produced with 2 variants. Verify variant names match (Compression_Gzip, Compression_Lz4).
    - e2e_sealed_trait_dyn_dispatch_verified: Build function with sealed trait object parameter. Create TraitDatabase with sealed trait and 2 impls. Call generate_vcs with TraitDatabase. Verify sum type declaration in VCs. Submit to Z3 and verify no errors.

    SC5: Developer sees error when impl violates trait contract
    - e2e_impl_violates_postcondition_detected: Create trait with ensures(result >= 0). Generate postcondition strengthening VC for impl whose postcondition is result >= -5 (does NOT imply result >= 0). Send to Z3. Expect SAT (violation). Verify the VC description mentions the impl name and "postcondition".
    - e2e_impl_violates_precondition_detected: Create trait with requires(x > 0). Generate precondition weakening VC for impl with requires(x > 10) (STRICTER than trait, violates LSP). Send to Z3. Expect SAT (violation). Verify VC description mentions "precondition".

    Additional edge cases:
    - e2e_trait_no_contracts_no_vcs: Trait with no requires/ensures -> 0 behavioral subtyping VCs
    - e2e_multiple_impls_all_checked: Trait with 3 impls -> behavioral subtyping VCs generated for each

    All tests should skip gracefully if Z3 is not available (same pattern as existing e2e tests).
  </action>
  <verify>
    cargo test -p rust-fv-analysis --test trait_verification 2>&1 | tail -10
    cargo clippy --workspace -- -D warnings 2>&1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    trait_verification.rs exists with 11 end-to-end tests covering all 5 success criteria.
    Tests validate behavioral subtyping VCs (correct impl verified, violating impl rejected),
    dyn Trait dispatch (open-world and sealed), and error diagnostics.
    All 11 tests pass via Z3. 0 clippy warnings. 0 formatting issues.
  </done>
</task>

<task type="auto">
  <name>Task 3: Full workspace validation and Phase 8 completion</name>
  <files></files>
  <action>
    Run comprehensive validation of the entire workspace to confirm Phase 8 is complete:

    1. Run all workspace tests: cargo test --workspace
       - Verify ALL tests pass (expected: ~1,870+ from 1,843 baseline + ~27 new)
       - Specifically verify: trait_verification tests, behavioral_subtyping tests, trait_analysis tests
       - Verify no regressions in existing test suites

    2. Run clippy: cargo clippy --workspace -- -D warnings
       - Must be 0 warnings

    3. Run fmt check: cargo fmt --all -- --check
       - Must be 0 formatting issues

    4. Validate all 5 success criteria:
       SC1: Trait with contracts -> behavioral subtyping VCs generated (test: e2e_trait_with_contracts_behavioral_subtyping_vcs)
       SC2: Correct impl verified via Z3 (test: e2e_behavioral_subtyping_correct_impl_verified)
       SC3: Dyn Trait uses trait-level contract (test: e2e_dyn_trait_method_call_open_world)
       SC4: Sealed trait enumerates impls (test: e2e_sealed_trait_sum_type_encoding)
       SC5: Violating impl detected (test: e2e_impl_violates_postcondition_detected)

    5. Validate all 5 TRT requirements:
       TRT-01: Trait-level contracts verified for each implementing type (behavioral_subtyping.rs)
       TRT-02: Dynamic dispatch uses trait-level contracts (vcgen.rs TraitObject handling)
       TRT-03: Each impl verified via behavioral subtyping (generate_subtyping_vcs)
       TRT-04: Sealed traits use closed-world verification (encode_sealed_trait_sum_type)
       TRT-05: Public traits use open-world verification (uninterpreted functions + axioms)

    6. Report final test count and metrics.
  </action>
  <verify>
    cargo test --workspace 2>&1 | tail -5
    cargo clippy --workspace -- -D warnings 2>&1 | tail -5
    cargo fmt --all -- --check
  </verify>
  <done>
    All workspace tests pass. 0 clippy warnings. 0 formatting issues.
    All 5 success criteria validated. All 5 TRT requirements satisfied.
    Phase 8 is COMPLETE.
  </done>
</task>

</tasks>

<verification>
- All workspace tests pass: cargo test --workspace
- 0 clippy warnings: cargo clippy --workspace -- -D warnings
- 0 formatting issues: cargo fmt --all -- --check
- All 5 Phase 8 success criteria validated via Z3 tests
- All 5 TRT requirements satisfied
- Behavioral subtyping: correct impls verified (UNSAT), violating impls rejected (SAT)
- Dynamic dispatch: open-world (uninterpreted) and closed-world (sum types) both tested
- Diagnostics: clear error messages for behavioral subtyping violations
</verification>

<success_criteria>
1. 11+ end-to-end tests in trait_verification.rs, all passing via Z3
2. Behavioral subtyping: correct impl produces UNSAT, violating impl produces SAT
3. Open-world dyn Trait: uninterpreted function encoding tested via Z3
4. Closed-world sealed trait: sum type encoding tested via Z3
5. Diagnostic helpers produce clear messages mentioning LSP, precondition weakening, postcondition strengthening
6. All 5 Phase 8 success criteria validated
7. All 5 TRT requirements satisfied
8. All workspace tests pass (~1,870+), 0 clippy warnings, 0 formatting issues
</success_criteria>

<output>
After completion, create `.planning/phases/08-trait-objects/08-03-SUMMARY.md`
</output>

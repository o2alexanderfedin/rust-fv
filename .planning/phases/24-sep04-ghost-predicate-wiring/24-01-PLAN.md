---
phase: 24-sep04-ghost-predicate-wiring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/driver/src/parallel.rs
  - crates/analysis/src/vcgen.rs
  - crates/driver/src/callbacks.rs
autonomous: true
requirements: [SEP-04]
gap_closure: true

must_haves:
  truths:
    - "VerificationTask struct carries ghost_pred_db: Arc<GhostPredicateDatabase> field"
    - "VerificationTask construction in callbacks.rs includes ghost_pred_db populated from self.ghost_pred_db"
    - "generate_vcs_with_db() accepts &GhostPredicateDatabase and passes it to parse_spec()"
    - "parse_spec() in vcgen.rs calls parse_spec_expr_with_db (not the db-less parse_spec_expr)"
    - "cargo clippy and cargo test --lib pass with zero new warnings"
  artifacts:
    - path: "crates/driver/src/parallel.rs"
      provides: "VerificationTask with ghost_pred_db field"
      contains: "ghost_pred_db: Arc<GhostPredicateDatabase>"
    - path: "crates/analysis/src/vcgen.rs"
      provides: "generate_vcs_with_db() shim and updated parse_spec()"
      contains: "parse_spec_expr_with_db"
    - path: "crates/driver/src/callbacks.rs"
      provides: "ghost_pred_db populated at VerificationTask push"
      contains: "ghost_pred_db: Arc::clone"
  key_links:
    - from: "crates/driver/src/callbacks.rs"
      to: "crates/driver/src/parallel.rs VerificationTask"
      via: "Arc::clone(&ghost_pred_db_arc) at tasks.push()"
      pattern: "ghost_pred_db: Arc::clone"
    - from: "crates/driver/src/parallel.rs verify_single()"
      to: "crates/analysis/src/vcgen.rs generate_vcs_with_db()"
      via: "&task.ghost_pred_db passed to generate_vcs_with_db"
      pattern: "generate_vcs_with_db.*ghost_pred_db"
    - from: "crates/analysis/src/vcgen.rs parse_spec()"
      to: "crates/analysis/src/spec_parser.rs parse_spec_expr_with_db()"
      via: "ghost_pred_db parameter threaded through generate_vcs_with_db → parse_spec"
      pattern: "parse_spec_expr_with_db"
---

<objective>
Thread `GhostPredicateDatabase` through the production verification pipeline via three surgical changes:
1. Add `ghost_pred_db: Arc<GhostPredicateDatabase>` field to `VerificationTask` (parallel.rs:21-44)
2. Populate it at task construction in callbacks.rs:631
3. Add `generate_vcs_with_db()` shim + update `parse_spec()` to call `parse_spec_expr_with_db`

Purpose: Close the SEP-04 critical wiring gap — ghost predicates extracted in callbacks.rs but silently ignored in production vcgen.
Output: Three modified files; `cargo test --lib` passes with no regressions.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-sep04-ghost-predicate-wiring/24-RESEARCH.md
</context>

<feature>
  <name>Ghost Predicate DB Production Wiring</name>
  <files>
    crates/driver/src/parallel.rs,
    crates/analysis/src/vcgen.rs,
    crates/driver/src/callbacks.rs
  </files>
  <behavior>
    Given: A VerificationTask with ghost_pred_db containing {"owned": GhostPredicate{params:["p"], body:"pts_to(p,0)"}}
    When: verify_single(task) calls generate_vcs_with_db(&task.ir_func, Some(&task.contract_db), &task.ghost_pred_db)
    Then: parse_spec("owned(p)", func, &ghost_pred_db) calls parse_spec_expr_with_db and expands "owned(p)" to the pts_to term
    NOT: parse_spec("owned(p)", func) calling db-less parse_spec_expr which returns None for ghost predicate references

    Unit test cases (write RED first):
    1. VerificationTask can be constructed with a ghost_pred_db field (struct field presence test)
    2. generate_vcs_with_db() with a GhostPredicateDatabase containing "is_pos(x) = x > 0"
       applied to a function with requires: "is_pos(_1)" produces at least one precondition VC
       (not zero VCs as would happen with db-less path where "is_pos(_1)" parses to None)
  </behavior>
  <implementation>
    Follow TDD: RED → GREEN → REFACTOR.

    RED phase — write failing tests FIRST, commit, confirm failure:

    Test 1 (compile-time check): In crates/driver/src/parallel.rs tests module, add:
    ```rust
    #[test]
    fn verification_task_has_ghost_pred_db_field() {
        // This test fails to compile until VerificationTask has the ghost_pred_db field.
        // Remove after GREEN phase — it is a compile-time sentinel.
        let _: fn() -> rust_fv_analysis::ghost_predicate_db::GhostPredicateDatabase = || {
            rust_fv_analysis::ghost_predicate_db::GhostPredicateDatabase::new()
        };
        // If VerificationTask has the field, this assertion trivially passes.
        // If not, the struct construction below fails to compile.
    }
    ```

    Test 2 (functional RED test): In crates/analysis/src/vcgen.rs tests module, add:
    ```rust
    #[test]
    fn generate_vcs_with_db_expands_ghost_predicate_in_requires() {
        use crate::ghost_predicate_db::{GhostPredicate, GhostPredicateDatabase};
        // ghost predicate: is_pos(x) := x > 0
        let mut db = GhostPredicateDatabase::new();
        db.insert("is_pos".to_string(), GhostPredicate {
            param_names: vec!["x".to_string()],
            body_raw: "x > 0".to_string(),
        });
        // Build function with requires: "is_pos(_1)"
        // (db-less parse_spec_expr returns None for "is_pos(_1)" — no VC generated)
        // (generate_vcs_with_db with db returns Some(x > 0) — precondition VC generated)
        let func = make_simple_func_with_requires("is_pos(_1)");  // reuse existing test helper
        let vcs = generate_vcs_with_db(&func, None, &db);
        let pre_vc = vcs.conditions.iter().find(|c| c.description.contains("precondition") || c.description.contains("requires"));
        assert!(pre_vc.is_some(), "Ghost predicate in requires must produce a precondition VC via generate_vcs_with_db");
    }
    ```
    Run `cargo test -p rust-fv-analysis -- generate_vcs_with_db_expands_ghost` and confirm FAIL
    (function `generate_vcs_with_db` not found). Commit: `test(24-01): RED — failing ghost predicate wiring tests`

    GREEN phase — implement three surgical changes:

    **Change 1: Add ghost_pred_db field to VerificationTask (parallel.rs:21-44)**
    Add import: `use rust_fv_analysis::ghost_predicate_db::GhostPredicateDatabase;`
    Add field after `contract_db`:
    ```rust
    /// Shared ghost predicate database (populated from #[ghost_predicate] doc attrs)
    pub ghost_pred_db: Arc<GhostPredicateDatabase>,
    ```

    **Change 2: Populate ghost_pred_db at task construction (callbacks.rs:631)**
    Before the task-push loop (around line ~461, before `for (name, ir_func, ...)`), add:
    ```rust
    let ghost_pred_db_arc = std::sync::Arc::new(self.ghost_pred_db.clone());
    ```
    Inside `tasks.push(crate::parallel::VerificationTask { ... })` at line 631, add:
    ```rust
    ghost_pred_db: std::sync::Arc::clone(&ghost_pred_db_arc),
    ```
    NOTE: `self.ghost_pred_db` is already populated at line 401 (`self.ghost_pred_db = extract_ghost_predicates(tcx)`). The Arc must be created ONCE before the per-function loop to avoid N allocations.

    **Change 3: Add generate_vcs_with_db() + update parse_spec() (vcgen.rs)**

    Step 3a: Add `generate_vcs_with_db()` as a backward-compatible shim right after `generate_vcs()` at line ~224:
    ```rust
    /// Like `generate_vcs` but with ghost predicate expansion.
    /// Called by `verify_single()` in the driver; `generate_vcs()` delegates to this.
    pub fn generate_vcs_with_db(
        func: &Function,
        contract_db: Option<&ContractDatabase>,
        ghost_pred_db: &GhostPredicateDatabase,
    ) -> FunctionVCs {
        // Identical to generate_vcs body but passes ghost_pred_db into parse_spec
        // ... (copy body of generate_vcs, update parse_spec calls)
    }
    ```
    Do NOT change the `generate_vcs()` signature — it is the public API called by 6+ test sites.
    Instead, make `generate_vcs()` delegate to `generate_vcs_with_db` with an empty DB:
    ```rust
    pub fn generate_vcs(func: &Function, contract_db: Option<&ContractDatabase>) -> FunctionVCs {
        let empty_db = GhostPredicateDatabase::new();
        generate_vcs_with_db(func, contract_db, &empty_db)
    }
    ```

    Step 3b: Add `ghost_pred_db: &GhostPredicateDatabase` parameter to the private `parse_spec()` at line 3091:
    ```rust
    fn parse_spec(spec: &str, func: &Function, ghost_pred_db: &GhostPredicateDatabase) -> Option<Term> {
        let term = spec_parser::parse_spec_expr_with_db(spec, func, ghost_pred_db)
            .or_else(|| parse_simple_spec(spec, func))?;
        // ... rest unchanged
    }
    ```
    The Rust compiler will flag ALL call sites of parse_spec() within vcgen.rs (14 sites per research).
    Update each: `parse_spec(spec, func)` → `parse_spec(spec, func, ghost_pred_db)`.
    The `ghost_pred_db` is available in `generate_vcs_with_db()` scope and threads through all intermediate helpers.

    Step 3c: Update `verify_single()` in parallel.rs:261 to call `generate_vcs_with_db`:
    ```rust
    let mut func_vcs = rust_fv_analysis::vcgen::generate_vcs_with_db(
        &task.ir_func,
        Some(&task.contract_db),
        &task.ghost_pred_db,
    );
    ```

    Also check `has_sep_logic_spec()` gate in vcgen.rs (the syntactic pts_to substring check).
    If the gate is used to decide whether to inject sep_heap declarations, verify it also checks if any ghost predicate in the spec transitively expands to pts_to. If the raw spec is "owned(p)" and the gate only checks for "pts_to" substring, ghost pred expansion will produce pts_to terms without the sep_heap declaration — Z3 will error. Fix: after `generate_vcs_with_db` resolves ghost preds, check expanded terms too. This is a low-confidence pitfall from the research — inspect `has_sep_logic_spec()` during implementation and fix if needed.

    Run `cargo test -p rust-fv-analysis -p rust-fv-driver` — all tests must pass.
    Run `cargo clippy --all -- -D warnings` — zero new warnings.
    Commit: `feat(24-01): GREEN — thread ghost_pred_db through VerificationTask → generate_vcs_with_db → parse_spec`

    REFACTOR phase:
    Run `cargo fmt --all`.
    Confirm tests still pass.
    Commit: `refactor(24-01): fmt and cleanup after ghost_pred_db wiring`
  </implementation>
</feature>

<verification>
Run all of the following and confirm zero failures:

```bash
cargo test -p rust-fv-analysis -- generate_vcs_with_db
cargo test -p rust-fv-driver
cargo clippy --all -- -D warnings
cargo fmt --all --check
```

Confirm:
- `generate_vcs_with_db` function exists in vcgen.rs public API
- `VerificationTask` struct in parallel.rs has `ghost_pred_db: Arc<GhostPredicateDatabase>` field
- `parse_spec()` in vcgen.rs line ~3091 calls `parse_spec_expr_with_db` not `parse_spec_expr`
- `callbacks.rs` task push at line ~631 includes `ghost_pred_db` field

Grep checks:
```bash
grep -n "ghost_pred_db" /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/driver/src/parallel.rs
grep -n "parse_spec_expr_with_db" /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/analysis/src/vcgen.rs
grep -n "ghost_pred_db_arc\|Arc::clone.*ghost" /Users/alexanderfedin/Projects/hapyy/rust-fv/crates/driver/src/callbacks.rs
```
All must return matches.
</verification>

<success_criteria>
- VerificationTask.ghost_pred_db field present in parallel.rs
- callbacks.rs creates Arc::new(self.ghost_pred_db.clone()) once before loop, Arc::clone per task
- generate_vcs_with_db() public function exists in vcgen.rs, accepting &GhostPredicateDatabase
- generate_vcs() delegates to generate_vcs_with_db with empty DB (backward-compatible shim)
- parse_spec() in vcgen.rs accepts ghost_pred_db param and calls parse_spec_expr_with_db
- All 14 parse_spec() call sites in vcgen.rs pass ghost_pred_db
- verify_single() in parallel.rs calls generate_vcs_with_db (not generate_vcs)
- cargo test --lib passes for both analysis and driver crates (zero failures)
- cargo clippy passes with zero new warnings
</success_criteria>

<output>
After completion, create `.planning/phases/24-sep04-ghost-predicate-wiring/24-01-SUMMARY.md`
</output>

---
phase: 35-opaque-callee-diagnostics
plan: 02
type: execute
wave: 2
depends_on:
  - 35-01
files_modified:
  - crates/analysis/src/vcgen.rs
autonomous: true
requirements:
  - OPAQUE-01
  - OPAQUE-02

must_haves:
  truths:
    - "An integration test verifies V060 warning fires for a safe verified caller calling an uncontracted callee"
    - "An integration test verifies V061 error fires when an uncontracted callee is called from within an unsafe block"
    - "An integration test verifies zero OpaqueCallee VCs when all callees have contracts (no regression)"
    - "cargo test passes for all new integration tests"
  artifacts:
    - path: "crates/analysis/src/vcgen.rs"
      provides: "Integration-level unit tests covering V060/V061 diagnostic paths end-to-end within the VCGen pipeline"
      contains: "test_opaque_callee_safe_warning"
  key_links:
    - from: "test_opaque_callee_safe_warning"
      to: "VcKind::OpaqueCallee in result.conditions"
      via: "generate_vcs with ContractDatabase missing callee entry"
      pattern: "OpaqueCallee"
    - from: "test_opaque_callee_unsafe_error"
      to: "VcKind::OpaqueCalleeUnsafe in result.conditions"
      via: "generate_vcs with func.is_unsafe_fn = true and missing callee contract"
      pattern: "OpaqueCalleeUnsafe"
---

<objective>
Add integration-level unit tests in `vcgen.rs` that exercise the full generate_vcs → generate_call_site_vcs → OpaqueCallee/OpaqueCalleeUnsafe path, proving the V060/V061 diagnostics fire correctly end-to-end and that contracted callees remain clean.

Purpose: Regression guard for OPAQUE-01 and OPAQUE-02 — prevents silent-skip from being re-introduced.
Output: Three new #[test] functions in vcgen.rs tests module.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/35-opaque-callee-diagnostics/35-CONTEXT.md
@.planning/phases/35-opaque-callee-diagnostics/35-01-SUMMARY.md

<interfaces>
<!-- Key test scaffolding patterns from existing vcgen.rs tests (around line 7856). -->

Pattern for building a Function that calls a callee:
- Add a BasicBlock with `Terminator::Call { func_name, args, destination, target }` to basic_blocks
- Add callee to ContractDatabase to simulate contracted case; omit for opaque case
- Pass ContractDatabase to generate_vcs as `Some(&contract_db)`
- Filter result.conditions by vc_kind to assert diagnostic presence/absence

Existing test template (from test_vcgen_missing_contracts_warning):
```rust
let func = Function {
    name: "caller_fn".to_string(),
    params: vec![],
    return_local: Local::new("_0", Ty::Unit),
    locals: vec![],
    basic_blocks: vec![/* include Call terminator here */],
    contracts: Contracts::default(),
    generic_params: vec![],
    loops: vec![],
    prophecies: vec![],
    lifetime_params: vec![],
    outlives_constraints: vec![],
    borrow_info: vec![],
    reborrow_chains: vec![],
    unsafe_blocks: vec![],        // populate for unsafe test
    unsafe_operations: vec![],
    unsafe_contracts: None,
    is_unsafe_fn: false,          // true for unsafe fn test
    thread_spawns: vec![],
    atomic_ops: vec![],
    sync_ops: vec![],
    lock_invariants: vec![],
    concurrency_config: None,
    source_names: std::collections::HashMap::new(),
    coroutine_info: None,
};
let result = generate_vcs(&func, Some(&contract_db));
```

ContractDatabase usage:
```rust
let mut contract_db = ContractDatabase::new();
// omit insert for opaque case; insert summary for contracted case
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Integration tests — V060 (safe), V061 (unsafe), and no-regression (contracted)</name>
  <files>crates/analysis/src/vcgen.rs</files>
  <behavior>
    - Test `test_opaque_callee_safe_warning`: safe caller fn with a Call terminator to "uncontracted_fn" (not in ContractDatabase) → result.conditions contains exactly one VC with `vc_kind == VcKind::OpaqueCallee`; VC description contains "uncontracted_fn"; VC description contains "no verification contract"
    - Test `test_opaque_callee_unsafe_error`: caller fn with `is_unsafe_fn: true` and a Call terminator to "uncontracted_fn" (not in ContractDatabase) → result.conditions contains exactly one VC with `vc_kind == VcKind::OpaqueCalleeUnsafe`
    - Test `test_opaque_callee_unsafe_block_error`: caller fn with `is_unsafe_fn: false` but `unsafe_blocks: vec![UnsafeBlockInfo { block_index: 0 }]` and Call terminator at block 0 → result.conditions contains one VC with `vc_kind == VcKind::OpaqueCalleeUnsafe`
    - Test `test_opaque_callee_no_diagnostic_for_contracted`: caller fn with a Call terminator to "contracted_fn" that IS in ContractDatabase (empty requires, empty ensures) → result.conditions contains ZERO VCs with `vc_kind == VcKind::OpaqueCallee` or `VcKind::OpaqueCalleeUnsafe`
    - Test `test_opaque_callee_dedup_same_callee`: caller fn with TWO Call terminators both to "uncontracted_fn" → result.conditions contains exactly ONE OpaqueCallee VC (dedup working); if dedup is not implemented yet, assert >= 1 and leave a FIXME comment
  </behavior>
  <action>
    Add five test functions in the `#[cfg(test)] mod tests` block of `crates/analysis/src/vcgen.rs`, after the existing `test_vcgen_missing_contracts_warning` test (~line 7856).

    For the Call terminator in BasicBlock, use whatever Call variant exists in the Terminator enum — look at existing test helpers or the Terminator enum definition to find the correct Call variant and field names. Do NOT guess field names — grep the file for `Terminator::Call` to find the pattern.

    The ContractDatabase insert call should use a FunctionSummary with empty contracts and empty alias_preconditions for the contracted-callee case.

    Use `generate_vcs(&func, Some(&contract_db))` (not `generate_vcs(&func, None)`) so the call-site VC path is triggered.

    Run after writing: `cargo test -p rust-fv-analysis -- test_opaque_callee 2>&1`
  </action>
  <verify>
    <automated>cargo test -p rust-fv-analysis -- test_opaque_callee 2>&1 | tail -20</automated>
  </verify>
  <done>
    Five tests pass: test_opaque_callee_safe_warning, test_opaque_callee_unsafe_error, test_opaque_callee_unsafe_block_error, test_opaque_callee_no_diagnostic_for_contracted, test_opaque_callee_dedup_same_callee. No existing tests broken.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full suite + clippy + fmt verification</name>
  <files></files>
  <action>
    Run the complete quality gate:

    1. `cargo test -p rust-fv-analysis -p rust-fv-driver 2>&1 | tail -20`
    2. `cargo clippy -p rust-fv-analysis -p rust-fv-driver -- -D warnings 2>&1 | tail -20`
    3. `cargo fmt --check -p rust-fv-analysis -p rust-fv-driver 2>&1`

    Fix any issues. If a clippy lint fires on the new test code, apply the suggested fix or add a targeted `#[allow(...)]` with a comment explaining why.

    Commit the final state: `git add crates/analysis/src/vcgen.rs crates/driver/src/diagnostics.rs crates/driver/src/callbacks.rs && git commit -m "feat(35): implement OpaqueCallee/OpaqueCalleeUnsafe diagnostics V060/V061"`
  </action>
  <verify>
    <automated>cargo test -p rust-fv-analysis -p rust-fv-driver 2>&1 | grep -E "^test result|FAILED" | tail -10</automated>
  </verify>
  <done>
    Both crates report "test result: ok". Zero clippy errors. Zero fmt differences. Changes committed.
  </done>
</task>

</tasks>

<verification>
End-to-end gate for Phase 35:
1. `cargo test -p rust-fv-analysis` — all tests green including the 5 new opaque_callee tests
2. `cargo test -p rust-fv-driver` — all tests green
3. VcKind::OpaqueCallee present in vcgen.rs (grep confirms)
4. VcKind::OpaqueCalleeUnsafe present in vcgen.rs (grep confirms)
5. diagnostics.rs contains "OpaqueCallee" in warning branch and vc_kind_description
6. callbacks.rs contains "opaque_callee" in vc_kind_to_string
7. The pattern `tracing::debug!.*treating as opaque.*continue` is gone from generate_call_site_vcs (replaced)
</verification>

<success_criteria>
1. Five new integration tests pass, covering safe warning, unsafe fn error, unsafe block error, contracted no-diagnostic, and dedup
2. All existing tests (regression) remain GREEN
3. `cargo clippy -- -D warnings` passes with zero errors
4. Phase 35 requirements OPAQUE-01 and OPAQUE-02 are demonstrably satisfied by the test suite
</success_criteria>

<output>
After completion, create `.planning/phases/35-opaque-callee-diagnostics/35-02-SUMMARY.md`
</output>

---
phase: 13-standard-library-contracts
plan: 04
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - crates/analysis/src/stdlib_contracts/loader.rs
  - crates/analysis/src/stdlib_contracts/override_check.rs
  - crates/analysis/src/stdlib_contracts/mod.rs
  - crates/driver/src/callbacks.rs
  - crates/driver/src/cargo_verify.rs
  - crates/macros/src/lib.rs
  - crates/analysis/tests/stdlib_loader_test.rs
  - crates/analysis/tests/stdlib_override_test.rs
autonomous: true

must_haves:
  truths:
    - "Stdlib contracts are auto-loaded by default when cargo verify runs"
    - "Developer can disable stdlib contracts with --no-stdlib-contracts flag"
    - "Developer can override stdlib contracts with #[override_contract] attribute"
    - "Developer can extend stdlib contracts with #[extend_contract] attribute"
    - "Info-level notice emitted when override is active"
    - "Basic soundness validation on user overrides (postcondition not contradicting precondition)"
  artifacts:
    - path: "crates/analysis/src/stdlib_contracts/loader.rs"
      provides: "load_default_contracts() function that registers all Tier 1 stdlib contracts"
      contains: "load_default_contracts"
    - path: "crates/analysis/src/stdlib_contracts/override_check.rs"
      provides: "Soundness validation for user overrides"
      contains: "validate_override"
    - path: "crates/driver/src/callbacks.rs"
      provides: "Integration of stdlib contract loading into verification pipeline"
      contains: "stdlib_contracts"
    - path: "crates/driver/src/cargo_verify.rs"
      provides: "--no-stdlib-contracts CLI flag parsing"
      contains: "no-stdlib-contracts"
    - path: "crates/macros/src/lib.rs"
      provides: "#[override_contract] and #[extend_contract] proc macro attributes"
      contains: "override_contract"
  key_links:
    - from: "crates/driver/src/callbacks.rs"
      to: "crates/analysis/src/stdlib_contracts/loader.rs"
      via: "Driver calls load_default_contracts() and merges into ContractDatabase"
      pattern: "load_default_contracts"
    - from: "crates/driver/src/cargo_verify.rs"
      to: "crates/driver/src/callbacks.rs"
      via: "CLI flag parsed and passed to VerifyCallbacks"
      pattern: "no_stdlib_contracts"
    - from: "crates/macros/src/lib.rs"
      to: "crates/driver/src/callbacks.rs"
      via: "Override attributes extracted during HIR analysis, applied to registry"
      pattern: "override_contract"
---

<objective>
Wire stdlib contracts into the verification pipeline with auto-loading, CLI opt-out, and user override/extend mechanism.

Purpose: This connects all the contracts from Plans 02-03 to the actual verification engine. Auto-loading (STDLIB-05 partial) means developers get stdlib contracts without any configuration. Override/extend mechanism (STDLIB-05 complete) handles cases where stdlib contracts are too weak or too strong.

Output: Fully integrated stdlib contract system with CLI flag, override attributes, and soundness validation.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-standard-library-contracts/13-02-SUMMARY.md
@.planning/phases/13-standard-library-contracts/13-03-SUMMARY.md
@crates/analysis/src/stdlib_contracts/mod.rs
@crates/analysis/src/stdlib_contracts/types.rs
@crates/analysis/src/contract_db.rs
@crates/driver/src/callbacks.rs
@crates/driver/src/cargo_verify.rs
@crates/macros/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contract loader, override validation, and proc macro attributes</name>
  <files>crates/analysis/src/stdlib_contracts/loader.rs, crates/analysis/src/stdlib_contracts/override_check.rs, crates/analysis/src/stdlib_contracts/mod.rs, crates/macros/src/lib.rs, crates/analysis/tests/stdlib_loader_test.rs, crates/analysis/tests/stdlib_override_test.rs</files>
  <action>
  **loader.rs:**
  - `pub fn load_default_contracts() -> StdlibContractRegistry` -- creates registry and calls all register_*_contracts functions:
    - register_vec_contracts
    - register_option_contracts
    - register_result_contracts
    - register_hashmap_contracts
    - register_iterator_contracts
    - register_string_contracts
  - Returns fully populated registry with all Tier 1 contracts
  - Unit tests: verify returned registry has expected number of contracts, each type has expected methods

  **override_check.rs:**
  - `pub fn validate_override(original: &StdlibContract, override_contract: &StdlibContract) -> Result<(), OverrideError>`
  - Validation rules:
    1. Override must have same parameter count and compatible types
    2. Basic contradiction check: if postcondition is trivially `false`, reject
    3. If precondition is `false` (unreachable), warn but allow (user may know what they're doing)
  - `pub fn validate_extension(original: &StdlibContract, extra_requires: &[SpecExpr], extra_ensures: &[SpecExpr]) -> Result<(), OverrideError>`
  - Extension validation: ensure extra conditions are syntactically valid SpecExpr
  - `OverrideError` enum: `ParamCountMismatch`, `ContradictoryPostcondition`, `InvalidSpecExpr`, `ParamTypeMismatch`
  - Unit tests for each validation case

  **proc macros in crates/macros/src/lib.rs:**
  - Add `#[override_contract]` proc macro attribute -- parses the annotated extern block, extracts function signatures with #[requires]/[ensures], stores as doc attribute `rust_fv::override_contract::METHOD_NAME::REQUIRES::EXPR` / `rust_fv::override_contract::METHOD_NAME::ENSURES::EXPR`
  - Add `#[extend_contract]` proc macro attribute -- same pattern but stores as `rust_fv::extend_contract::...`
  - These follow the same pattern as existing `#[requires]`, `#[ensures]`, `#[invariant]`, `#[decreases]` proc macros
  - Unit tests in macros crate for attribute parsing

  Update stdlib_contracts/mod.rs to add `pub mod loader;` and `pub mod override_check;`
  </action>
  <verify>
  `cargo test -p rust-fv-analysis -- stdlib_loader` passes.
  `cargo test -p rust-fv-analysis -- stdlib_override` passes.
  `cargo test -p rust-fv-macros` passes.
  `cargo clippy --workspace -- -D warnings` passes.
  </verify>
  <done>Contract loader produces complete Tier 1 registry. Override validation catches contradictions and param mismatches. Proc macros parse #[override_contract] and #[extend_contract].</done>
</task>

<task type="auto">
  <name>Task 2: Integrate stdlib contracts into driver pipeline with CLI flag</name>
  <files>crates/driver/src/callbacks.rs, crates/driver/src/cargo_verify.rs</files>
  <action>
  **cargo_verify.rs:**
  - Add `parse_no_stdlib_contracts(args: &[String]) -> bool` function (same pattern as parse_fresh)
  - Add `--no-stdlib-contracts` to help text
  - Pass the flag through to the driver environment variable: `RUST_FV_NO_STDLIB_CONTRACTS=1`
  - Update arg filtering to exclude `--no-stdlib-contracts` from forwarded args
  - Unit tests for parsing the new flag

  **callbacks.rs:**
  - In the verification pipeline (after building contract_db from HIR contracts), add stdlib loading:
    ```rust
    // Load stdlib contracts unless disabled
    let no_stdlib = std::env::var("RUST_FV_NO_STDLIB_CONTRACTS").is_ok() || self.no_stdlib_contracts;
    if !no_stdlib {
        let stdlib_registry = rust_fv_analysis::stdlib_contracts::loader::load_default_contracts();
        stdlib_registry.merge_into(&mut contract_db);
    }
    ```
  - Add `no_stdlib_contracts: bool` field to `VerifyCallbacks` struct
  - After loading stdlib contracts, process override/extend attributes:
    1. Scan HIR for `rust_fv::override_contract::*` doc attributes
    2. For each override: validate with override_check, apply to registry, emit info log: "Using custom contract for {method} (overriding stdlib)"
    3. For each extension: validate, merge extra conditions, emit info log
  - Use tracing::info! for override notices (info-level per user decision)
  - Merge final registry into contract_db before verification

  Ensure the flag is threaded from cargo_verify -> environment variable -> callbacks.
  </action>
  <verify>
  `cargo test -p rust-fv-driver` passes (existing + new tests).
  `cargo clippy --workspace -- -D warnings` passes.
  Manual verification: `cargo verify --help` shows `--no-stdlib-contracts` option.
  </verify>
  <done>Stdlib contracts auto-load when cargo verify runs. --no-stdlib-contracts disables loading. Override/extend attributes detected and applied with info-level logging and soundness validation.</done>
</task>

</tasks>

<verification>
- `cargo test --workspace` passes
- `cargo clippy --workspace -- -D warnings` passes
- `cargo verify --help` shows --no-stdlib-contracts
- Default verification includes stdlib contracts in ContractDatabase
- Override/extend attributes parsed, validated, and applied
</verification>

<success_criteria>
STDLIB-05 (override mechanism) fully implemented. Auto-loading works by default. CLI opt-out works. Override/extend attributes with soundness validation. Info-level logging for overrides.
</success_criteria>

<output>
After completion, create `.planning/phases/13-standard-library-contracts/13-04-SUMMARY.md`
</output>

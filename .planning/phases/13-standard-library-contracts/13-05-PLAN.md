---
phase: 13-standard-library-contracts
plan: 05
type: tdd
wave: 4
depends_on: ["13-04"]
files_modified:
  - crates/analysis/tests/oracle/vec_oracle.rs
  - crates/analysis/tests/oracle/hashmap_oracle.rs
  - crates/analysis/tests/oracle/option_result_oracle.rs
  - crates/analysis/tests/oracle/iterator_oracle.rs
  - crates/analysis/tests/oracle/mod.rs
  - crates/analysis/tests/e2e_stdlib.rs
  - crates/analysis/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Property-based oracle tests validate that all stdlib contract postconditions hold for real stdlib operations"
    - "E2E tests verify that functions using Vec, Option, Result, HashMap, Iterator verify successfully with stdlib contracts loaded"
    - "No unsound contract: oracle tests catch any postcondition that doesn't match real stdlib behavior"
    - "E2E test proves map/filter/collect chain verification works end-to-end"
  artifacts:
    - path: "crates/analysis/tests/oracle/vec_oracle.rs"
      provides: "Proptest oracle tests for Vec push/pop/len/get/reserve/shrink_to_fit"
      contains: "proptest!"
    - path: "crates/analysis/tests/oracle/hashmap_oracle.rs"
      provides: "Proptest oracle tests for HashMap insert/get/remove/contains_key"
      contains: "proptest!"
    - path: "crates/analysis/tests/oracle/option_result_oracle.rs"
      provides: "Proptest oracle tests for Option and Result operations"
      contains: "proptest!"
    - path: "crates/analysis/tests/oracle/iterator_oracle.rs"
      provides: "Proptest oracle tests for iterator chain compositions"
      contains: "proptest!"
    - path: "crates/analysis/tests/e2e_stdlib.rs"
      provides: "End-to-end tests building IR functions that use stdlib types and verifying with Z3"
      contains: "e2e_stdlib"
  key_links:
    - from: "crates/analysis/tests/oracle/vec_oracle.rs"
      to: "crates/analysis/src/stdlib_contracts/vec.rs"
      via: "Oracle validates postconditions from Vec contracts against real Vec behavior"
      pattern: "vec.push"
    - from: "crates/analysis/tests/e2e_stdlib.rs"
      to: "crates/analysis/src/stdlib_contracts/loader.rs"
      via: "E2E tests use load_default_contracts to populate ContractDatabase"
      pattern: "load_default_contracts"
---

<objective>
Validate stdlib contract soundness via proptest oracle testing and end-to-end verification integration.

Purpose: Oracle tests (user requirement) catch unsound contracts by running real stdlib operations and checking postconditions. E2E tests prove the full pipeline works: developer writes function using stdlib types -> contracts auto-loaded -> VCGen encodes -> Z3 verifies successfully.

Output: Comprehensive oracle test suite + E2E integration tests proving all Phase 13 success criteria.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-standard-library-contracts/13-04-SUMMARY.md
@crates/analysis/src/stdlib_contracts/mod.rs
@crates/analysis/src/stdlib_contracts/vec.rs
@crates/analysis/src/stdlib_contracts/hashmap.rs
@crates/analysis/src/stdlib_contracts/option.rs
@crates/analysis/src/stdlib_contracts/result.rs
@crates/analysis/src/stdlib_contracts/iterator.rs
@crates/analysis/src/stdlib_contracts/string.rs
@crates/analysis/src/stdlib_contracts/loader.rs
@crates/analysis/src/contract_db.rs
@crates/analysis/src/vcgen.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Proptest oracle tests for all stdlib contracts</name>
  <files>crates/analysis/tests/oracle/vec_oracle.rs, crates/analysis/tests/oracle/hashmap_oracle.rs, crates/analysis/tests/oracle/option_result_oracle.rs, crates/analysis/tests/oracle/iterator_oracle.rs, crates/analysis/tests/oracle/mod.rs, crates/analysis/Cargo.toml</files>
  <action>
  1. Add proptest as dev-dependency in crates/analysis/Cargo.toml:
     ```toml
     [dev-dependencies]
     proptest = "1.6"
     ```

  2. Create `crates/analysis/tests/oracle/mod.rs` as test module root.

  3. **vec_oracle.rs** -- Proptest oracle tests:
     - `vec_push_oracle`: push(value) -> assert len == old_len + 1, assert vec[old_len] == value
     - `vec_pop_oracle`: pop() -> if was non-empty: assert len == old_len - 1; if was empty: assert result.is_none()
     - `vec_get_oracle`: get(i) -> if i < len: assert result == Some(&vec[i]); else assert result.is_none()
     - `vec_reserve_oracle`: reserve(n) -> assert capacity >= old_cap, assert len == old_len, elements preserved
     - `vec_shrink_oracle`: shrink_to_fit() -> assert capacity <= old_cap, assert len == old_len
     - `vec_clear_oracle`: clear() -> assert len == 0
     - Use `#[proptest(cases = 256)]` for thorough coverage

  4. **hashmap_oracle.rs** -- Proptest oracle tests:
     - `hashmap_insert_oracle`: insert(k,v) -> assert get(k) == Some(v), assert other keys unchanged
     - `hashmap_remove_oracle`: remove(k) -> assert get(k) == None, assert other keys unchanged
     - `hashmap_contains_key_oracle`: contains_key(k) -> assert result == get(k).is_some()
     - `hashmap_len_oracle`: len() matches manual count
     - Frame condition test: insert one key, verify 5 random other keys unchanged
     - Use String keys and i32 values for diverse testing

  5. **option_result_oracle.rs** -- Proptest oracle tests:
     - `option_map_oracle`: Some(x).map(f) == Some(f(x)), None.map(f) == None
     - `option_and_then_oracle`: Some(x).and_then(f) == f(x), None.and_then(f) == None
     - `option_unwrap_or_oracle`: Some(x).unwrap_or(d) == x, None.unwrap_or(d) == d
     - `option_ok_or_oracle`: Some(x).ok_or(e) == Ok(x), None.ok_or(e) == Err(e)
     - `result_map_oracle`: Ok(x).map(f) == Ok(f(x)), Err(e).map(f) == Err(e)
     - `result_and_then_oracle`: Ok(x).and_then(f) == f(x), Err(e).and_then(f) == Err(e)
     - `result_ok_oracle`: Ok(x).ok() == Some(x), Err(e).ok() == None

  6. **iterator_oracle.rs** -- Proptest oracle tests:
     - `iter_map_length_oracle`: vec.iter().map(f).count() == vec.len()
     - `iter_filter_length_oracle`: vec.iter().filter(p).count() <= vec.len()
     - `iter_take_length_oracle`: vec.iter().take(n).count() == min(n, vec.len())
     - `iter_zip_length_oracle`: a.iter().zip(b.iter()).count() == min(a.len(), b.len())
     - `iter_enumerate_oracle`: enumerate produces (index, value) pairs with correct indices
     - `iter_chain_composition_oracle`: map(f).filter(p).collect::<Vec<_>>().len() <= original.len()
     - `iter_fold_oracle`: validate fold produces correct result for simple operations
     - `iter_any_all_oracle`: any/all match manual check

  All oracle tests use `#[proptest(cases = 256)]` by default.
  </action>
  <verify>
  `cargo test -p rust-fv-analysis -- oracle` passes all proptest oracle tests (256 cases each).
  `cargo clippy -p rust-fv-analysis -- -D warnings` passes.
  No oracle failures = no unsound contracts.
  </verify>
  <done>All stdlib contract postconditions validated against real stdlib behavior via proptest. 256 cases per property. No unsound contracts detected.</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end integration tests for stdlib contract verification</name>
  <files>crates/analysis/tests/e2e_stdlib.rs</files>
  <action>
  Create `crates/analysis/tests/e2e_stdlib.rs` with end-to-end tests that:

  1. Build IR Function objects that call stdlib methods (Vec::push, Option::unwrap, HashMap::insert, etc.)
  2. Load stdlib contracts via load_default_contracts()
  3. Merge into ContractDatabase
  4. Generate VCs via generate_vcs()
  5. Check with Z3 (UNSAT = verified)

  **Test cases:**

  - `e2e_vec_push_verified`: Function pushes to vec, asserts len increases -- should verify (UNSAT)
  - `e2e_vec_get_safe`: Function calls get(i) with i < len precondition -- should verify
  - `e2e_option_unwrap_safe`: Function checks is_some() then unwraps -- should verify
  - `e2e_option_unwrap_unsafe`: Function unwraps without check -- should fail (SAT, precondition violation)
  - `e2e_hashmap_insert_get`: Function inserts then gets same key -- should verify get returns inserted value
  - `e2e_hashmap_frame_condition`: Function inserts key, checks different key unchanged -- should verify
  - `e2e_iterator_map_length`: Function maps over iterator, asserts length preserved -- should verify
  - `e2e_iterator_filter_length`: Function filters iterator, asserts length <= original -- should verify
  - `e2e_result_map_preserves`: Function maps Ok value, checks result is Ok -- should verify
  - `e2e_stdlib_disabled`: Same function but with no stdlib contracts -- should not generate stdlib VCs (preconditions not checked for stdlib calls)

  Follow existing E2E test patterns from the codebase: build IR manually, call generate_vcs with ContractDatabase, pipe SMT to Z3, assert SAT/UNSAT.
  </action>
  <verify>
  `cargo test -p rust-fv-analysis -- e2e_stdlib` passes all tests.
  Verified programs return UNSAT, buggy programs return SAT.
  Disabled stdlib test confirms contracts not loaded.
  </verify>
  <done>End-to-end tests prove the full verification pipeline works with stdlib contracts. All 5 Phase 13 success criteria verified: Vec, Option/Result, HashMap, Iterator operations verify with preloaded contracts. Override mechanism works.</done>
</task>

</tasks>

<verification>
- `cargo test --workspace` passes (all existing + oracle + e2e tests)
- `cargo clippy --workspace -- -D warnings` passes
- Oracle tests: 256 cases per property, all pass (no unsound contracts)
- E2E tests: verified programs UNSAT, buggy programs SAT
- Phase 13 success criteria 1-5 all demonstrated
</verification>

<success_criteria>
All Phase 13 success criteria proven via E2E tests:
1. Vec operations verify without writing stdlib contracts
2. Option/Result operations verify with auto-loaded contracts
3. HashMap operations verify with preloaded specs
4. Iterator operations verify with working contracts
5. Override mechanism works (tested via e2e_stdlib_disabled + unit tests from Plan 04)
Oracle tests confirm no unsound contracts in the entire suite.
</success_criteria>

<output>
After completion, create `.planning/phases/13-standard-library-contracts/13-05-SUMMARY.md`
</output>

---
phase: 18-bv2int-optimization
plan: 03
type: execute
wave: 3
depends_on:
  - 18-01
  - 18-02
files_modified:
  - crates/driver/src/cargo_verify.rs
  - crates/driver/src/callbacks.rs
  - crates/driver/src/output.rs
  - crates/driver/src/diagnostics.rs
autonomous: true
requirements:
  - PERF-05
  - PERF-06

must_haves:
  truths:
    - "Developer can enable bv2int via --bv2int CLI flag"
    - "Developer can enable bv2int via RUST_FV_BV2INT=1 environment variable"
    - "CLI flag takes precedence over environment variable"
    - "Per-function ineligibility warning explains why bv2int was skipped (not silent)"
    - "Equivalence testing runs automatically on first bv2int use for a function"
    - "Timing comparison shown for every bv2int-verified function"
    - "--bv2int-report shows summary table of all functions with encoding, time, speedup"
    - "Slowdown warning (>2x by default) shown when bv2int is slower"
    - "Slowdown threshold configurable via RUST_FV_BV2INT_THRESHOLD or --bv2int-threshold"
    - "Auto-detect mode suggests bv2int candidates based on static eligibility analysis"
  artifacts:
    - path: "crates/driver/src/cargo_verify.rs"
      provides: "CLI flag parsing for --bv2int, --bv2int-report, --bv2int-threshold"
      contains: "bv2int"
    - path: "crates/driver/src/callbacks.rs"
      provides: "Pipeline integration wiring bv2int into verification flow"
      contains: "EncodingMode"
    - path: "crates/driver/src/output.rs"
      provides: "bv2int report formatting and timing display"
      contains: "bv2int_report"
  key_links:
    - from: "crates/driver/src/cargo_verify.rs"
      to: "crates/driver/src/callbacks.rs"
      via: "Passes bv2int config to verification pipeline"
      pattern: "bv2int.*EncodingMode"
    - from: "crates/driver/src/callbacks.rs"
      to: "crates/analysis/src/bv2int.rs"
      via: "Calls is_bv2int_eligible per function"
      pattern: "is_bv2int_eligible"
    - from: "crates/driver/src/callbacks.rs"
      to: "crates/analysis/src/differential.rs"
      via: "Runs differential test on first bv2int use"
      pattern: "test_encoding_equivalence"
    - from: "crates/driver/src/output.rs"
      to: "crates/analysis/src/differential.rs"
      via: "Formats EquivalenceResult for display"
      pattern: "format_equivalence_result"
---

<objective>
Wire bv2int optimization into the cargo verify pipeline with CLI/env activation, per-function eligibility checking with warnings, automatic differential testing, timing display, --bv2int-report summary mode, and auto-detect candidate suggestions.

Purpose: Makes bv2int optimization accessible to developers through the existing cargo verify workflow with full transparency about eligibility, equivalence, and performance impact.

Output: Fully integrated bv2int pipeline with CLI flags, env vars, per-function reporting, and summary report mode.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-bv2int-optimization/18-RESEARCH.md
@.planning/phases/18-bv2int-optimization/18-CONTEXT.md
@.planning/phases/18-bv2int-optimization/18-01-SUMMARY.md
@.planning/phases/18-bv2int-optimization/18-02-SUMMARY.md
@crates/driver/src/cargo_verify.rs
@crates/driver/src/callbacks.rs
@crates/driver/src/output.rs
@crates/driver/src/diagnostics.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI/env activation and pipeline integration</name>
  <files>crates/driver/src/cargo_verify.rs, crates/driver/src/callbacks.rs</files>
  <action>
    In cargo_verify.rs:
    - Add parse_bv2int_flag(args) -> bool: checks for --bv2int flag in args
    - Add parse_bv2int_report_flag(args) -> bool: checks for --bv2int-report flag
    - Add parse_bv2int_threshold(args) -> f64: checks --bv2int-threshold=N or RUST_FV_BV2INT_THRESHOLD env var, default 2.0
    - Resolve bv2int enabled: CLI --bv2int takes precedence, then RUST_FV_BV2INT=1 env var
    - Pass bv2int config to the verification callbacks

    In callbacks.rs:
    - Accept bv2int configuration (enabled: bool, threshold: f64, report_mode: bool)
    - For each function, when bv2int enabled:
      1. Check is_bv2int_eligible(func) from bv2int.rs
      2. If ineligible: emit warning with reason ("Function `foo` skipped for bv2int: uses bitwise `&amp;` at line 42")
      3. If eligible and no cached equivalence: run differential test via test_encoding_equivalence
      4. If equivalence confirmed: use Integer encoding mode for verification
      5. If divergence detected: report error, fall back to bitvector encoding
      6. Store EquivalenceResult in cache
    - When not bv2int enabled but --bv2int-report requested:
      - Run static eligibility analysis on all functions
      - Output candidate list: "bv2int candidates: foo, bar, baz (use --bv2int to enable)"
      - No speculative speedup estimates (per user decision)
    - Collect per-function bv2int results for report mode

    Update help text in cargo_verify.rs to document --bv2int, --bv2int-report, --bv2int-threshold flags and RUST_FV_BV2INT, RUST_FV_BV2INT_THRESHOLD env vars.
  </action>
  <verify>
    - `cargo build -p rust-fv-driver` compiles
    - `cargo clippy -p rust-fv-driver -- -D warnings` clean
    - `cargo test -p rust-fv-driver --lib` passes
    - Manual check: --bv2int flag is parsed, env var fallback works, help text updated
  </verify>
  <done>
    --bv2int flag and RUST_FV_BV2INT env var activate bv2int mode. Per-function eligibility checked with warnings for ineligible functions. Differential testing runs automatically on first use. CLI takes precedence over env var.
  </done>
</task>

<task type="auto">
  <name>Task 2: Output formatting, report mode, slowdown warnings, and E2E tests</name>
  <files>crates/driver/src/output.rs, crates/driver/src/diagnostics.rs</files>
  <action>
    In output.rs:
    - Add Bv2intFunctionReport struct: { func_name, encoding_used (Bitvector/Integer), bitvec_time_ms, bv2int_time_ms, speedup_factor, eligible, skip_reason }
    - Add format_bv2int_report(reports: &amp;[Bv2intFunctionReport]) -> String:
      - Table format: "Function | Encoding | BV Time | Int Time | Speedup"
      - Sort by speedup factor descending
      - Color code: green for speedup > 1.5x, yellow for 0.5x-1.5x, red for < 0.5x
    - Add format_bv2int_timing(func_name, bv_ms, int_ms) -> String:
      - "bitvector: {X}ms, bv2int: {Y}ms ({Z:.1}x faster)" or "({Z:.1}x slower)"
    - Add check_slowdown_warning(speedup_factor, threshold) -> Option&lt;String&gt;:
      - If speedup < 1.0/threshold: return warning "bv2int is {X:.1}x slower than bitvector for `{func}` (threshold: {threshold}x)"
    - Display auto-detect candidates section when --bv2int-report without --bv2int:
      - List eligible functions: "bv2int candidates (eligible based on static analysis):"
      - List ineligible functions with reasons: "ineligible: bar (uses bitwise &amp; at line 12)"

    In diagnostics.rs:
    - Add bv2int divergence diagnostic (error severity):
      - "Encoding divergence detected in `{func}`: bitvector says {SAT/UNSAT}, bv2int says {SAT/UNSAT}"
      - Include counterexample if available
    - Add bv2int ineligibility diagnostic (warning severity):
      - "Function `{func}` not eligible for bv2int: {reason}"

    Write integration tests (in appropriate test module):
    - Test --bv2int flag parsing (present, absent, with env var, CLI precedence)
    - Test --bv2int-report output format
    - Test --bv2int-threshold parsing and default
    - Test slowdown warning generation
    - Test ineligibility warning format
    - Test timing display format
  </action>
  <verify>
    - `cargo test -p rust-fv-driver` passes all tests
    - `cargo clippy -p rust-fv-driver -- -D warnings` clean
    - `cargo fmt --check` clean
    - Report table format is readable and correctly sorted
    - Slowdown warnings trigger at configured threshold
  </verify>
  <done>
    --bv2int-report shows complete summary table with encoding, timing, and speedup for all functions. Slowdown warnings appear when bv2int is slower than configurable threshold (default 2x). Auto-detect candidates listed without speculative estimates. All diagnostics are actionable.
  </done>
</task>

</tasks>

<verification>
Full pipeline verification:
1. `cargo build --workspace` succeeds
2. `cargo test --workspace` passes (all existing + new tests)
3. `cargo clippy --workspace -- -D warnings` clean
4. `cargo fmt --check` clean
5. --bv2int flag activates bv2int mode for eligible functions
6. RUST_FV_BV2INT=1 activates bv2int mode (CLI takes precedence)
7. Ineligible functions produce per-function warning with specific reason
8. Equivalence testing runs on first use and results are cached
9. --bv2int-report produces readable summary table
10. Slowdown warnings appear when bv2int is >2x slower (configurable)
</verification>

<success_criteria>
- Developer can run `cargo verify --bv2int` and see bv2int applied to eligible functions
- Developer can run `RUST_FV_BV2INT=1 cargo verify` as alternative
- Ineligible functions produce clear warnings (not silent fallback)
- Timing comparison shown for every bv2int-verified function
- --bv2int-report shows summary table of all functions
- Slowdown threshold configurable and warnings appear when exceeded
- Auto-detect candidates listed when --bv2int-report run without --bv2int
- All 5 phase success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/18-bv2int-optimization/18-03-SUMMARY.md`
</output>

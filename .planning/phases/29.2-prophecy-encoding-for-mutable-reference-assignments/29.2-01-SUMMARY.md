---
phase: 29.2-prophecy-encoding-for-mutable-reference-assignments
plan: "01"
subsystem: spec-parser
tags: [prophecy, postcondition, mutable-reference, vcgen, tdd]
dependency_graph:
  requires: []
  provides: [parse_spec_expr_postcondition_with_db, parse_spec_postcondition]
  affects: [vcgen.rs, spec_parser.rs, e2e_verification.rs]
tech_stack:
  added: []
  patterns: [in_postcondition parameter threading, prophecy variable resolution]
key_files:
  created: []
  modified:
    - crates/analysis/src/spec_parser.rs
    - crates/analysis/src/vcgen.rs
    - crates/analysis/tests/e2e_verification.rs
decisions:
  - "in_postcondition parameter threaded through convert_expr_with_db chain — minimal invasive change, compiler-enforced coverage of all call sites"
  - "Inside old(): in_postcondition=false — old() always captures initial value, never prophecy"
  - "parse_spec_postcondition in vcgen.rs delegates to parse_spec_expr_postcondition_with_db, same quantifier annotation logic as parse_spec"
  - "All existing entry points (parse_spec_expr, parse_spec_expr_with_db, etc.) pass in_postcondition=false — backward compatible"
metrics:
  duration: 594
  completed_date: "2026-02-26"
  tasks_completed: 2
  files_modified: 3
requirements: [PROPHECY-01]
---

# Phase 29.2 Plan 01: Prophecy Encoding for Mutable Reference Assignments Summary

**One-liner:** Postcondition-aware deref — `*_1` in ensures resolves to `_1_prophecy` via `in_postcondition` parameter threaded through `convert_expr_with_db` chain.

## What Was Built

Fixed the `#[ignore]` test `test_prophecy_basic` by making `*_1` in postcondition (ensures) context resolve to `_1_prophecy` instead of `_1`.

### Root Cause

`convert_deref` had no way to distinguish postcondition context from normal context, so `_1_prophecy` never appeared in generated VC scripts despite the prophecy infrastructure (`encode_prophecy.rs`) being complete.

### Implementation

**`spec_parser.rs`:**
- Added `in_postcondition: bool` parameter to `convert_deref`, `convert_expr_with_db`, `convert_expr_with_bounds`, `convert_call`, and `convert_call_with_db`
- `convert_deref` now: `in_old` → `_initial`, `in_postcondition` → `_prophecy`, normal → `param`
- `old()` handler passes `in_postcondition=false` — old() context never wants prophecy
- All existing entry points (`parse_spec_expr`, `parse_spec_expr_with_db`, etc.) pass `in_postcondition=false` — backward compatible
- New public entry point: `parse_spec_expr_postcondition_with_db` with `in_postcondition=true`

**`vcgen.rs`:**
- New private helper `parse_spec_postcondition` wrapping the postcondition-aware entry point
- `generate_contract_vcs` ensures loop updated: `parse_spec` → `parse_spec_postcondition`
- Only ONE line change in the ensures loop — all other parse_spec calls unchanged

**`e2e_verification.rs`:**
- Removed `#[ignore]` from `test_prophecy_basic` (line 2764-2765)

## Tests

| Test | Status | Description |
|------|--------|-------------|
| `parse_postcondition_deref_resolves_to_prophecy` | GREEN | `*_1` in postcondition → `_1_prophecy` |
| `parse_postcondition_old_deref_still_resolves_to_initial` | GREEN | `old(*_1)` in postcondition → `_1_initial` |
| `test_prophecy_basic` | GREEN (was `#[ignore]`) | SMT script contains both `_1_initial` and `_1_prophecy` |
| Full analysis suite | GREEN (1400+ tests, 0 failures) | No regressions |
| clippy | Clean | No warnings |

## Commits

| Task | Commit | Description |
|------|--------|-------------|
| Task 1 + 2 (combined) | 7fca7a5 | feat(29.2-01): implement postcondition-aware deref resolution for prophecy variables |

Note: Tasks 1 (RED) and 2 (GREEN) were combined into a single commit because the pre-commit hook requires all crate targets to compile — a compile-error RED state cannot be committed. The TDD sequence was followed in implementation order (tests written first, implementation second).

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] RED test commit prevented by pre-commit hook**
- **Found during:** Task 1 commit attempt
- **Issue:** Pre-commit hook runs clippy, which requires all targets to compile. A RED test that fails to compile (missing function) cannot be committed.
- **Fix:** Combined Task 1 (RED tests) and Task 2 (GREEN implementation) into a single commit after verifying the RED state locally before implementing GREEN. TDD spirit preserved: tests were written first, implementation added second.
- **Files modified:** N/A (process deviation, not file change)

## Self-Check: PASSED

| Check | Result |
|-------|--------|
| crates/analysis/src/spec_parser.rs exists | FOUND |
| crates/analysis/src/vcgen.rs exists | FOUND |
| crates/analysis/tests/e2e_verification.rs exists | FOUND |
| commit 7fca7a5 exists | FOUND |
| parse_spec_expr_postcondition_with_db in spec_parser.rs | FOUND |
| parse_spec_postcondition in vcgen.rs | FOUND |
| test_prophecy_basic function exists | FOUND |
| #[ignore] removed from e2e_verification.rs | CONFIRMED |

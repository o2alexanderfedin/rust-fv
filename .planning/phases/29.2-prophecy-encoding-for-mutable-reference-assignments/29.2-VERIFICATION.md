---
phase: 29.2-prophecy-encoding-for-mutable-reference-assignments
verified: 2026-02-25T00:00:00Z
status: passed
score: 5/5 must-haves verified
re_verification: false
---

# Phase 29.2: Prophecy Encoding for Mutable Reference Assignments — Verification Report

**Phase Goal:** Fix `#[ignore]` test `test_prophecy_basic` — make `*_1` in postcondition context resolve to `_1_prophecy` via `convert_deref` postcondition awareness. Postcondition specs like `*_1 == old(*_1)` on `&mut T` params must correctly reference `_1_prophecy` and `_1_initial` SMT variables in generated VC scripts.
**Verified:** 2026-02-25
**Status:** PASSED
**Re-verification:** No — initial verification

---

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | `test_prophecy_basic` passes without `#[ignore]` | VERIFIED | `cargo test --test e2e_verification test_prophecy_basic` → `test test_prophecy_basic ... ok` (1 passed, 0 failed, 0 ignored) |
| 2 | In postcondition context `*_1` resolves to `_1_prophecy` (not `_1`) | VERIFIED | `spec_parser::tests::parse_postcondition_deref_resolves_to_prophecy ... ok` — asserts `Term::Const("_1_prophecy")` |
| 3 | In `old()` context `*_1` still resolves to `_1_initial` regardless of postcondition flag | VERIFIED | `spec_parser::tests::parse_postcondition_old_deref_still_resolves_to_initial ... ok` — asserts `Term::Const("_1_initial")` |
| 4 | In precondition context `*_1` still resolves to `_1` (no change) | VERIFIED | `spec_parser::tests::parse_ensures_with_old_and_deref ... ok` — asserts `Term::Const("_1")` as LHS in non-postcondition parse; all 1202 lib unit tests pass with no regression |
| 5 | Generated SMT script contains both `_1_initial` and `_1_prophecy` for the postcondition VC | VERIFIED | `test_prophecy_basic` directly asserts `script_text.contains("_1_initial") && script_text.contains("_1_prophecy")` — test passes |

**Score:** 5/5 truths verified

---

## Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `crates/analysis/src/spec_parser.rs` | `parse_spec_expr_postcondition_with_db` entry point + `in_postcondition`-aware `convert_deref` | VERIFIED | `parse_spec_expr_postcondition_with_db` at line 62; `in_postcondition: bool` threaded through `convert_expr_with_db` (line 138), `convert_expr_with_bounds` (line 138), `convert_call_with_db` (line 673), `convert_deref` (line 1477); branch `else if in_postcondition { _prophecy }` at line 1496 |
| `crates/analysis/src/vcgen.rs` | `parse_spec_postcondition` private helper used in ensures loop | VERIFIED | `parse_spec_postcondition` defined at line 3426; ensures loop at line 2013-2014 uses it with comment "Use parse_spec_postcondition so that *_1 in ensures resolves to _1_prophecy" |
| `crates/analysis/tests/e2e_verification.rs` | `fn test_prophecy_basic` without `#[ignore]` | VERIFIED | Line 2764: `#[test]`, line 2765: `fn test_prophecy_basic()` — no `#[ignore]` attribute present; test passes |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `vcgen.rs:generate_contract_vcs` ensures loop | `spec_parser.rs:parse_spec_expr_postcondition_with_db` | `parse_spec_postcondition()` wrapper in vcgen.rs | WIRED | Line 2014: `parse_spec_postcondition(&post.raw, func, ghost_pred_db)`; line 3431: `spec_parser::parse_spec_expr_postcondition_with_db(spec, func, ghost_pred_db)` |
| `spec_parser.rs:convert_expr_with_db` | `spec_parser.rs:convert_deref` | `in_postcondition` parameter threaded through | WIRED | Line 235: `return convert_deref(&unary_expr.expr, func, in_old, in_postcondition, bound_vars)` — parameter passed from `convert_expr_with_db` to `convert_deref` |

---

## Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| PROPHECY-01 | 29.2-01-PLAN.md | Fix prophecy encoding: `*_1` in postcondition resolves to `_1_prophecy` (from ROADMAP.md line 340) | SATISFIED | `test_prophecy_basic` GREEN; both `_1_initial` and `_1_prophecy` present in generated VC script; `parse_spec_expr_postcondition_with_db` and `parse_spec_postcondition` implemented |

**Note:** PROPHECY-01 is defined in ROADMAP.md (line 340) but does not appear in `.planning/REQUIREMENTS.md`. The requirement is declared only at the ROADMAP level. This is an orphaned requirement relative to REQUIREMENTS.md — however, it is fully implemented and satisfied by the phase implementation.

---

## Anti-Patterns Found

No anti-patterns detected in the modified files:

- No `TODO`/`FIXME`/`PLACEHOLDER` comments in the changed code paths
- No `return null` / empty stubs in `convert_deref` or `parse_spec_postcondition`
- `test_prophecy_basic` has no `#[ignore]` attribute
- No `console.log`-equivalent stub handlers

---

## Human Verification Required

None. All aspects of this phase are verifiable programmatically:

- Correct SMT variable naming (`_1_prophecy`, `_1_initial`) in generated scripts — verified by `test_prophecy_basic` string assertions
- Context-dependent resolution logic — verified by unit tests in `spec_parser::tests`
- No regressions — verified by full 1202-test suite passing with 0 failures

---

## Full Test Suite Results

```
cargo test -p rust-fv-analysis 2>&1
```

- 1202 unit tests (lib): 0 failed, 0 ignored
- All integration test suites: 0 failed
- Total: zero test failures across entire analysis crate
- `cargo clippy -p rust-fv-analysis -- -D warnings`: clean (0 warnings)

---

## Gaps Summary

No gaps. All must-haves are verified at all three levels (exists, substantive, wired). The phase goal is fully achieved.

---

_Verified: 2026-02-25_
_Verifier: Claude (gsd-verifier)_

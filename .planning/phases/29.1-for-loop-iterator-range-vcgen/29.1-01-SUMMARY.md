---
phase: 29.1-for-loop-iterator-range-vcgen
plan: "01"
subsystem: analysis/vcgen
tags: [tdd, ir-extension, for-loop, vcgen, red-tests]
dependency_graph:
  requires: []
  provides: [for_loop_vcgen stub module, IteratorKind enum, RangeBound enum, 8 RED tests]
  affects: [crates/analysis/src/ir.rs, crates/analysis/src/lib.rs, crates/analysis/src/for_loop_vcgen.rs, crates/analysis/tests/vcgen_completeness29_1.rs]
tech_stack:
  added: [for_loop_vcgen.rs stub module]
  patterns: [TDD RED state, stub module with todo!() panic]
key_files:
  created:
    - crates/analysis/src/for_loop_vcgen.rs
    - crates/analysis/tests/vcgen_completeness29_1.rs
  modified:
    - crates/analysis/src/lib.rs
    - crates/analysis/tests/loop_verification.rs
    - crates/analysis/benches/stress_bench.rs
    - crates/analysis/src/ir.rs
decisions:
  - "Stub for_loop_vcgen module with todo!() panic preferred over compile-failure RED — pre-commit hook requires all targets to compile; runtime panic is valid TDD RED state"
  - "IteratorKind and RangeBound already existed in ir.rs from prior research; Task 1 focused on fixing construction sites"
  - "vc.location.vc_kind used in test 8 (not vc.kind) — VerificationCondition has no top-level kind field, it is nested in VcLocation"
metrics:
  duration: 480
  completed: "2026-02-25"
  tasks_completed: 2
  files_modified: 6
---

# Phase 29.1 Plan 01: TDD Scaffold + IR Extension Summary

**One-liner:** TDD RED scaffold for for-loop VCGen with IteratorKind IR extension, 8 panic-failing tests, and for_loop_vcgen stub module.

## What Was Built

### Task 1: LoopInfo Construction Site Fixes

`IteratorKind`, `RangeBound` enums and the extended `LoopInfo` struct already existed in `ir.rs` from prior research commits. Task 1 fixed all construction sites that were missing the new `iterator_kind: None, loop_var: None` fields:

- `crates/analysis/tests/loop_verification.rs`: 4 construction sites fixed
- `crates/analysis/benches/stress_bench.rs`: 1 construction site fixed
- `crates/analysis/src/ir.rs`: rustfmt reformatted `StdAdapter` variant

All 1200+ existing tests compile and pass after the fix.

### Task 2: 8 RED TDD Tests

Created `vcgen_completeness29_1.rs` with 8 tests covering the for-loop VCGen requirements:

| Test | IteratorKind | What is Verified |
|------|-------------|------------------|
| vcgen_for_01_range_half_open | Range(0..n) | AUFLIA + forall quantifier |
| vcgen_for_02_range_inclusive | RangeInclusive(0..=n) | <= for end bound, no (< i n) |
| vcgen_for_03_range_literal | Range(0..5) | No DeclareConst for bound var |
| vcgen_for_04_bounded_unrolling | Range(0..n) | QF_LIA bounded unrolling VC |
| vcgen_for_05_slice_iter | SliceIter(arr) | arr_len naming convention |
| vcgen_for_06_enumerate | Enumerate(SliceIter(arr)) | index_ and elem_ constants |
| vcgen_for_07_unknown_iterator | Unknown(CustomIter) | single true VC |
| vcgen_for_08_element_bounds_check | SliceIter(data) + loop_var | MemorySafety VcKind |

Also created `for_loop_vcgen.rs` stub module with `generate_for_loop_vcs()` that panics with `todo!()` — enabling the tests to compile (satisfying pre-commit clippy) while remaining RED (failing at runtime).

## RED State Confirmation

```
test vcgen_for_01_range_half_open ... FAILED
test vcgen_for_02_range_inclusive ... FAILED
test vcgen_for_03_range_literal ... FAILED
test vcgen_for_04_bounded_unrolling ... FAILED
test vcgen_for_05_slice_iter ... FAILED
test vcgen_for_06_enumerate ... FAILED
test vcgen_for_07_unknown_iterator ... FAILED
test vcgen_for_08_element_bounds_check ... FAILED

test result: FAILED. 0 passed; 8 failed; 0 ignored; 0 measured
```

Failure mode: `not yet implemented: for_loop_vcgen::generate_for_loop_vcs is not yet implemented (Plan 29.1-02)`

## Existing Tests Status

- `detect_loops` tests: 3 passed
- `vcgen_completeness28` tests: 10 passed
- `loop_verification` tests: 10 passed
- All 1200+ tests in the suite: 0 failures

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing functionality] Stub for_loop_vcgen module required**
- **Found during:** Task 2
- **Issue:** Plan specified RED state as compile failure (missing module), but pre-commit hook runs `cargo clippy --all-targets` which treats compile errors as failures
- **Fix:** Created `for_loop_vcgen.rs` stub with `todo!()` panic — tests compile but fail at runtime (valid TDD RED state)
- **Files modified:** `crates/analysis/src/for_loop_vcgen.rs`, `crates/analysis/src/lib.rs`
- **Commit:** 51283cb

**2. [Rule 1 - Bug] Wrong field access for VcKind in test 8**
- **Found during:** Task 2 review
- **Issue:** Test used `vc.kind` but `VerificationCondition` has no top-level `kind` field — VcKind is nested inside `vc.location.vc_kind`
- **Fix:** Changed to `vc.location.vc_kind == VcKind::MemorySafety`
- **Files modified:** `crates/analysis/tests/vcgen_completeness29_1.rs`
- **Commit:** 51283cb

**3. [Rule 1 - Bug] Format string escape in test 5**
- **Found during:** Task 2
- **Issue:** `{arr}` in assert message string was interpreted as a format argument
- **Fix:** Escaped to `{{arr}}`
- **Files modified:** `crates/analysis/tests/vcgen_completeness29_1.rs`
- **Commit:** 51283cb

## Commits

| Commit | Description |
|--------|-------------|
| 14f5b23 | feat(29.1-01): extend LoopInfo construction sites with iterator_kind/loop_var |
| 51283cb | test(29.1-01): add 8 RED TDD tests for for-loop VCGen scaffold |

## Self-Check: PASSED

- [x] `crates/analysis/src/for_loop_vcgen.rs` exists
- [x] `crates/analysis/tests/vcgen_completeness29_1.rs` exists (8 RED tests)
- [x] `crates/analysis/src/lib.rs` has `pub mod for_loop_vcgen`
- [x] Commits 14f5b23 and 51283cb exist
- [x] All existing tests pass
- [x] IteratorKind and RangeBound enums in ir.rs
- [x] LoopInfo has iterator_kind and loop_var fields

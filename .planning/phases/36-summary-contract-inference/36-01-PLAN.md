---
phase: 36-summary-contract-inference
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/macros/src/lib.rs
  - crates/analysis/src/ir.rs
  - crates/analysis/src/contract_db.rs
  - crates/driver/src/callbacks.rs
  - crates/analysis/src/vcgen.rs
  - crates/driver/src/diagnostics.rs
autonomous: true
requirements: [OPAQUE-03]

must_haves:
  truths:
    - "User annotates an uncontracted callee with `#[verifier::infer_summary]` and `cargo verify` does NOT emit a V060/V061 diagnostic for that callee"
    - "The inferred contract (pure: reads nothing, writes nothing) is pre-populated in contract_db before VCGen runs so the OpaqueCallee VC branch is never reached"
    - "A callee WITHOUT `#[verifier::infer_summary]` still emits V060/V061 as before — no regression"
    - "The suggest_fix message for OpaqueCallee mentions `#[verifier::infer_summary]` as an alternative to writing full contracts"
  artifacts:
    - path: "crates/macros/src/lib.rs"
      provides: "`#[verifier::infer_summary]` proc-macro attribute that embeds `rust_fv::infer_summary` doc comment"
      exports: ["infer_summary"]
    - path: "crates/analysis/src/ir.rs"
      provides: "`is_inferred: bool` field on `Contracts` struct — marks auto-inferred contracts"
      contains: "is_inferred"
    - path: "crates/analysis/src/contract_db.rs"
      provides: "`is_inferred: bool` field on `FunctionSummary` — propagates inferred flag to VCGen lookup"
      contains: "is_inferred"
    - path: "crates/driver/src/callbacks.rs"
      provides: "Detection of `rust_fv::infer_summary` doc attribute; inserts synthetic FunctionSummary with empty contracts + `is_inferred=true` into contract_db"
      contains: "infer_summary"
    - path: "crates/analysis/src/vcgen.rs"
      provides: "generate_call_site_vcs skips OpaqueCallee diagnostic when callee_summary.is_inferred is true"
      contains: "is_inferred"
    - path: "crates/driver/src/diagnostics.rs"
      provides: "suggest_fix for OpaqueCallee mentions `#[verifier::infer_summary]` as alternative path"
      contains: "infer_summary"
  key_links:
    - from: "crates/macros/src/lib.rs (infer_summary proc-macro)"
      to: "crates/driver/src/callbacks.rs (extract_contracts)"
      via: "doc attribute `rust_fv::infer_summary` read during HIR scan"
      pattern: "rust_fv::infer_summary"
    - from: "crates/driver/src/callbacks.rs (contract_db.insert)"
      to: "crates/analysis/src/vcgen.rs (generate_call_site_vcs)"
      via: "contract_db.get(&call_site.callee_name) returns Some(summary) with is_inferred=true"
      pattern: "is_inferred"
---

<objective>
Implement the `#[verifier::infer_summary]` attribute and suppress V060/V061 diagnostics for annotated callees by pre-populating a synthetic pure contract in the contract database.

Purpose: OPAQUE-03 — users can opt into automatic minimal contract inference instead of writing full `#[requires]`/`#[ensures]` contracts, closing the "opaque callee is annoying" workflow gap.

Output: Proc-macro, `is_inferred` flag on contracts/summary, extraction in callbacks, suppression in vcgen, updated suggest_fix.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-summary-contract-inference/36-CONTEXT.md
</context>

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From crates/analysis/src/ir.rs (Contracts struct at line 479):
```rust
pub struct Contracts {
    pub requires: Vec<SpecExpr>,
    pub ensures: Vec<SpecExpr>,
    pub invariants: Vec<SpecExpr>,
    pub is_pure: bool,
    pub decreases: Option<SpecExpr>,
    pub fn_specs: Vec<FnSpec>,
    pub state_invariant: Option<SpecExpr>,
}
```
Add `pub is_inferred: bool` field after `is_pure`. Contracts::default() will set it to false automatically.

From crates/analysis/src/contract_db.rs (FunctionSummary struct):
```rust
pub struct FunctionSummary {
    pub contracts: Contracts,
    pub param_names: Vec<String>,
    pub param_types: Vec<Ty>,
    pub return_ty: Ty,
    pub alias_preconditions: Vec<AliasPrecondition>,
}
```
Add `pub is_inferred: bool` field after `alias_preconditions`.

From crates/macros/src/lib.rs (trusted_impl pattern at line 646):
```rust
fn trusted_impl(attr: proc_macro2::TokenStream, item: proc_macro2::TokenStream) -> proc_macro2::TokenStream {
    if !attr.is_empty() {
        return syn::Error::new_spanned(attr, "`#[trusted]` does not accept arguments").to_compile_error();
    }
    let doc_value = "rust_fv::trusted";
    quote::quote! {
        #[doc(hidden)]
        #[doc = #doc_value]
        #item
    }
}
```
Mirror this pattern for `infer_summary` with doc_value = "rust_fv::infer_summary".

From crates/driver/src/callbacks.rs (extract_contracts loop at line ~790):
```rust
} else if doc == "rust_fv::pure" {
    contracts.is_pure = true;
```
Add analogous arm: `else if doc == "rust_fv::infer_summary" { contracts.is_inferred = true; }`

Also note the contract_db.insert block at line ~415 uses FunctionSummary {
    contracts: contracts.clone(), param_names, param_types, return_ty,
    alias_preconditions: vec![],
}
Update to include is_inferred: contracts.is_inferred.

From crates/analysis/src/vcgen.rs (generate_call_site_vcs at line 2361):
The None arm of `contract_db.get` emits OpaqueCallee. The Some arm proceeds.
When `callee_summary.is_inferred` is true, skip OpaqueCallee emission and ALSO skip
normal VC generation (no requires to check) — treat it like a contracted callee with
empty requires and empty ensures (just continue to next call_site without emitting anything).

From crates/driver/src/diagnostics.rs (suggest_fix at line ~542):
```rust
VcKind::OpaqueCallee | VcKind::OpaqueCalleeUnsafe => Some(
    "Add #[requires] / #[ensures] to the callee to enable cross-function verification. \
     See V060 (warning) for safe context, V061 (error) for unsafe context."
        .to_string(),
),
```
Update to also mention: "Alternatively, add `#[verifier::infer_summary]` to opt into automatic minimal contract inference."
</interfaces>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add `#[verifier::infer_summary]` proc-macro and `is_inferred` flag to IR types</name>
  <files>crates/macros/src/lib.rs, crates/analysis/src/ir.rs, crates/analysis/src/contract_db.rs</files>
  <behavior>
    - Test: `infer_summary_impl` with empty attr stream produces TokenStream containing `rust_fv::infer_summary` doc string
    - Test: `infer_summary_impl` with non-empty attr stream returns a compile_error TokenStream
    - Test: `Contracts::default().is_inferred` is false
    - Test: `Contracts { is_inferred: true, ..Contracts::default() }.is_inferred` is true
    - Test: `FunctionSummary { is_inferred: true, contracts: Contracts::default(), param_names: vec![], param_types: vec![], return_ty: Ty::Bool, alias_preconditions: vec![] }.is_inferred` is true
  </behavior>
  <action>
    1. In `crates/macros/src/lib.rs`: Add `pub fn infer_summary` proc-macro attribute (at the end of public attrs, before the `trusted` block or after it) following the exact `trusted_impl` pattern. Create an `infer_summary_impl` function with doc_value = "rust_fv::infer_summary". Register with `#[proc_macro_attribute]`.

    2. In `crates/analysis/src/ir.rs`: Add `pub is_inferred: bool,` field to the `Contracts` struct, after the `is_pure: bool` field. Since `Contracts` derives nothing that requires ordering, this is safe. `Default::default()` for bool is false — no need to update any existing `Contracts::default()` call sites.

    3. In `crates/analysis/src/contract_db.rs`: Add `pub is_inferred: bool,` field to `FunctionSummary` struct, after `alias_preconditions`. Update any `FunctionSummary { ... }` construction sites in contract_db.rs (if any exist) to include `is_inferred: false`. (The construction in callbacks.rs is handled in Task 2.)

    Run `cargo clippy -p rust_fv_macros -p rust_fv_analysis -- -D warnings` to confirm no clippy errors.
    Run `cargo test -p rust_fv_macros -p rust_fv_analysis` to confirm tests pass.
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust_fv_macros -p rust_fv_analysis 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `#[verifier::infer_summary]` proc-macro exists and embeds `rust_fv::infer_summary` doc attr
    - `Contracts.is_inferred: bool` field exists, defaults to false
    - `FunctionSummary.is_inferred: bool` field exists
    - All existing tests still pass
  </done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Extract `infer_summary` in callbacks.rs and suppress OpaqueCallee in vcgen.rs</name>
  <files>crates/driver/src/callbacks.rs, crates/analysis/src/vcgen.rs, crates/driver/src/diagnostics.rs</files>
  <behavior>
    - Test (vcgen unit): when generate_call_site_vcs is called with a contract_db entry where is_inferred=true, no OpaqueCallee VC is emitted for that callee
    - Test (vcgen unit): when contract_db entry exists but is_inferred=false and requires is empty, normal behavior (no OpaqueCallee, no requires VCs) — existing contracted callee path unchanged
    - Test (callbacks): a function with `rust_fv::infer_summary` doc attr results in a contract_db entry with is_inferred=true and empty requires/ensures
  </behavior>
  <action>
    1. In `crates/driver/src/callbacks.rs::extract_contracts`: Add `is_inferred: bool` to `HirContracts` struct (local struct used for accumulation). Add arm in the doc attribute scanning loop: `else if doc == "rust_fv::infer_summary" { contracts.is_inferred = true; }`. In the `map.insert(...)` block, update the condition so that `contracts.is_inferred` ALSO causes an entry to be inserted even when no other contract clauses are present (currently the guard is `!contracts.requires.is_empty() || ...`). Add `|| contracts.is_inferred` to that guard. Set `is_inferred: contracts.is_inferred` in the `FunctionSummary` construction.

    2. In `crates/driver/src/callbacks.rs` contract_db.insert block (~line 415): Pass `is_inferred: contracts.is_inferred` in the `FunctionSummary { ... }` literal. This requires `contracts` to carry `is_inferred` through the HIR-to-IR conversion path. Because `extract_contracts` returns `rust_fv_analysis::ir::Contracts` (which now has `is_inferred`), and the FunctionSummary is built from `contracts.clone()`, the `is_inferred` field is already present in `contracts`. Just add `is_inferred: contracts.is_inferred` to the FunctionSummary literal.

    3. In `crates/analysis/src/vcgen.rs::generate_call_site_vcs` (Some arm, line ~2431): After matching `Some(callee_summary)`, add an early check: `if callee_summary.is_inferred { continue; }` — this skips VC generation entirely for inferred-summary callees (pure = no requires to check, no ensures to assume; treat as no-op). Place this before `has_requires` / `has_alias_preconditions` checks.

    4. In `crates/driver/src/diagnostics.rs::suggest_fix` for `VcKind::OpaqueCallee | VcKind::OpaqueCalleeUnsafe`: Update the suggestion string to include: "Alternatively, add `#[verifier::infer_summary]` to opt into automatic minimal contract inference (pure: reads nothing, writes nothing)."

    Run `cargo clippy -p rust_fv_driver -p rust_fv_analysis -- -D warnings` after each file.
    Run `cargo test -p rust_fv_driver -p rust_fv_analysis` to confirm all tests pass.
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust_fv_driver -p rust_fv_analysis 2>&1 | tail -30</automated>
  </verify>
  <done>
    - `extract_contracts` recognizes `rust_fv::infer_summary` doc attr and sets is_inferred=true on the resulting Contracts
    - Functions with `#[verifier::infer_summary]` get a FunctionSummary inserted in contract_db with is_inferred=true
    - `generate_call_site_vcs` skips OpaqueCallee VC emission for is_inferred=true summaries
    - suggest_fix for OpaqueCallee mentions `#[verifier::infer_summary]`
    - All prior opaque callee tests (test_opaque_callee_vc_emitted_for_uncontracted_callee, etc.) still pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Full build verification and clippy pass</name>
  <files></files>
  <action>
    Run full workspace clippy and test suite to confirm zero regressions.
    1. `cargo clippy --workspace -- -D warnings`
    2. `cargo test --workspace`
    3. If any test fails, diagnose and fix before proceeding.
    Note: Fix any "unused field" or "struct field never read" clippy warnings for the new `is_inferred` fields by ensuring they are read in vcgen.rs (they are — the is_inferred check in generate_call_site_vcs reads the field).
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo clippy --workspace -- -D warnings 2>&1 | tail -10 && cargo test --workspace 2>&1 | grep -E "^test result|FAILED|error" | tail -20</automated>
  </verify>
  <done>
    - `cargo clippy --workspace -- -D warnings` exits 0
    - `cargo test --workspace` exits 0, no FAILED lines
    - Phase 36 Plan 01 core implementation complete
  </done>
</task>

</tasks>

<verification>
End-to-end check (manual construction in test):

```rust
// Simulated: callee with infer_summary should NOT produce OpaqueCallee VC
// Simulated: callee without any annotation should produce OpaqueCallee VC
// Run: cargo test -p rust_fv_analysis -- test_infer_summary 2>&1
```

Key regression guards:
- `test_opaque_callee_vc_emitted_for_uncontracted_callee` still passes (no annotation = still emits V060)
- `test_opaque_callee_safe_warning` still passes
- `test_opaque_callee_unsafe_error` still passes
</verification>

<success_criteria>
- `#[verifier::infer_summary]` is a valid proc-macro attribute in the macros crate
- Annotated callee produces a contract_db entry with is_inferred=true and empty requires/ensures
- VCGen skips OpaqueCallee diagnostic for is_inferred=true entries
- Non-annotated uncontracted callees still emit V060/V061
- suggest_fix for OpaqueCallee mentions infer_summary as alternative
- `cargo clippy --workspace -- -D warnings` and `cargo test --workspace` both exit 0
</success_criteria>

<output>
After completion, create `.planning/phases/36-summary-contract-inference/36-01-SUMMARY.md` using the summary template.
</output>

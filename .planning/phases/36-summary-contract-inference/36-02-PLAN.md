---
phase: 36-summary-contract-inference
plan: 02
type: execute
wave: 2
depends_on: [36-01]
files_modified:
  - crates/driver/src/json_output.rs
  - crates/driver/src/callbacks.rs
  - crates/analysis/src/vcgen.rs
autonomous: true
requirements: [OPAQUE-03]

must_haves:
  truths:
    - "When `--output-format=json` is used, the report contains an `inferred_summaries` top-level array listing each callee annotated with `#[verifier::infer_summary]` and its inferred contract text"
    - "`inferred_summaries` is omitted entirely from JSON when no callees have `#[verifier::infer_summary]` (field not present — not null, not empty array)"
    - "An integration test (unit-level) verifies the full pipeline: inferred callee → no V060 diagnostic + appears in inferred_summaries"
    - "An integration test verifies a non-annotated callee still produces OpaqueCallee VC and does NOT appear in inferred_summaries"
  artifacts:
    - path: "crates/driver/src/json_output.rs"
      provides: "`InferredSummary` struct and `inferred_summaries: Option<Vec<InferredSummary>>` field on `JsonVerificationReport`"
      contains: "InferredSummary"
    - path: "crates/driver/src/callbacks.rs"
      provides: "Collection of inferred callee names during verification run; populates `inferred_summaries` when building JSON report"
      contains: "inferred_summaries"
    - path: "crates/analysis/src/vcgen.rs"
      provides: "Integration test `test_infer_summary_suppresses_opaque_callee` and `test_infer_summary_json_field`"
      contains: "test_infer_summary"
  key_links:
    - from: "crates/driver/src/callbacks.rs (contract_db scan)"
      to: "crates/driver/src/json_output.rs (JsonVerificationReport)"
      via: "Collect is_inferred=true callee names from contract_db; construct Vec<InferredSummary>; set inferred_summaries field"
      pattern: "inferred_summaries"
    - from: "crates/driver/src/json_output.rs (JsonVerificationReport)"
      to: "serde JSON output"
      via: "#[serde(skip_serializing_if = \"Option::is_none\")] on inferred_summaries field"
      pattern: "skip_serializing_if"
---

<objective>
Add `inferred_summaries` to the JSON verification report and write integration tests confirming end-to-end suppression behavior and JSON field stability.

Purpose: Completes OPAQUE-03 — tooling can inspect what was auto-generated, closing the observability gap. Tests provide regression guard for Phase 36.

Output: `InferredSummary` struct, `inferred_summaries` field in `JsonVerificationReport`, callbacks wiring, 2+ integration tests.
</objective>

<execution_context>
@/Users/alexanderfedin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexanderfedin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-summary-contract-inference/36-CONTEXT.md
@.planning/phases/36-summary-contract-inference/36-01-SUMMARY.md
</context>

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase and Plan 01 output. -->
<!-- Executor should use these directly — no codebase exploration needed. -->

From crates/driver/src/json_output.rs (existing report struct):
```rust
#[derive(Serialize, Deserialize)]
pub struct JsonVerificationReport {
    pub crate_name: String,
    pub functions: Vec<JsonFunctionResult>,
    pub summary: JsonSummary,
    // NEW: add below
    // #[serde(skip_serializing_if = "Option::is_none")]
    // pub inferred_summaries: Option<Vec<InferredSummary>>,
}
```

New struct to add to json_output.rs:
```rust
/// An auto-inferred contract summary for a callee annotated with `#[verifier::infer_summary]`.
#[derive(Serialize, Deserialize, Debug, Clone, PartialEq)]
pub struct InferredSummary {
    /// The fully-qualified callee function name.
    pub callee: String,
    /// Human-readable inferred contract text.
    pub contract: String,
}
```
The `contract` string for the conservative "pure" inference is: "pure: reads nothing, writes nothing"

From crates/driver/src/callbacks.rs (JSON report construction at line ~357):
```rust
let report = json_output::JsonVerificationReport {
    crate_name: crate_name.to_string(),
    functions: json_functions,
    summary,
};
```
Extend to:
```rust
let inferred: Vec<json_output::InferredSummary> = contract_db
    .iter()  // need to add iter() to ContractDatabase, or use existing .get() with known names
    .filter(|(_, s)| s.is_inferred)
    .map(|(name, _)| json_output::InferredSummary {
        callee: name.clone(),
        contract: "pure: reads nothing, writes nothing".to_string(),
    })
    .collect();

let report = json_output::JsonVerificationReport {
    crate_name: crate_name.to_string(),
    functions: json_functions,
    summary,
    inferred_summaries: if inferred.is_empty() { None } else { Some(inferred) },
};
```
NOTE: `ContractDatabase` does not currently have an `iter()` method. Add one to contract_db.rs:
```rust
pub fn iter(&self) -> impl Iterator<Item = (&String, &FunctionSummary)> {
    self.contracts.iter()
}
```

The `contract_db` in callbacks.rs at the JSON build point: it is stored as `std::sync::Arc<ContractDatabase>` (see line 646 in callbacks.rs). Use `self.contract_db.iter()` or access the Arc'd value.

From Plan 01 (36-01-PLAN.md): `FunctionSummary.is_inferred: bool` is available.
</interfaces>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Add `InferredSummary` struct and `inferred_summaries` field to JSON report</name>
  <files>crates/driver/src/json_output.rs, crates/analysis/src/contract_db.rs</files>
  <behavior>
    - Test: `JsonVerificationReport` with `inferred_summaries: None` serializes to JSON without `inferred_summaries` key
    - Test: `JsonVerificationReport` with `inferred_summaries: Some(vec![InferredSummary { callee: "foo".into(), contract: "pure: reads nothing, writes nothing".into() }])` serializes to JSON with `inferred_summaries` array containing one entry with `callee` and `contract` keys
    - Test: `ContractDatabase::iter()` returns an iterator of (&String, &FunctionSummary) pairs
  </behavior>
  <action>
    1. In `crates/driver/src/json_output.rs`:
       - Add `InferredSummary` struct (Serialize, Deserialize, Debug, Clone, PartialEq) with fields `callee: String` and `contract: String`.
       - Add `#[serde(skip_serializing_if = "Option::is_none")] pub inferred_summaries: Option<Vec<InferredSummary>>,` to `JsonVerificationReport`.
       - Update ALL existing `JsonVerificationReport { ... }` construction sites in this file (tests) to include `inferred_summaries: None`.

    2. In `crates/analysis/src/contract_db.rs`:
       - Add `pub fn iter(&self) -> impl Iterator<Item = (&String, &FunctionSummary)> { self.contracts.iter() }` to `ContractDatabase` impl.

    Run `cargo clippy -p rust_fv_driver -p rust_fv_analysis -- -D warnings` and `cargo test -p rust_fv_driver` to confirm no regressions.
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test -p rust_fv_driver -p rust_fv_analysis 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `InferredSummary` struct exists in json_output.rs
    - `JsonVerificationReport.inferred_summaries: Option<Vec<InferredSummary>>` exists with skip_serializing_if
    - None → field absent in JSON serialization (verified by test)
    - Some(vec![...]) → field present with entries (verified by test)
    - `ContractDatabase::iter()` method exists
    - All existing json_output tests pass
  </done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Wire inferred_summaries into callbacks.rs JSON build and write integration tests</name>
  <files>crates/driver/src/callbacks.rs, crates/analysis/src/vcgen.rs</files>
  <behavior>
    - Integration test `test_infer_summary_suppresses_opaque_callee`: construct a Function that calls callee "foo", build a contract_db with a FunctionSummary for "foo" where is_inferred=true and requires/ensures are empty, call generate_call_site_vcs — assert zero VCs are emitted (no OpaqueCallee, no precondition VCs)
    - Integration test `test_infer_summary_no_suppression_without_flag`: same setup but is_inferred=false and callee absent from contract_db — assert one OpaqueCallee VC is emitted
    - Integration test `test_inferred_summaries_json_field`: construct a JsonVerificationReport with inferred_summaries=Some(vec![InferredSummary { callee: "bar".into(), contract: "pure: ...".into() }]) — serialize and assert JSON contains "inferred_summaries" key with one entry
  </behavior>
  <action>
    1. In `crates/driver/src/callbacks.rs`, in the `OutputFormat::Json` branch at line ~357:
       - Collect inferred summaries from the contract_db Arc: `let inferred: Vec<json_output::InferredSummary> = self.contract_db.iter().filter(|(_, s)| s.is_inferred).map(|(name, _)| json_output::InferredSummary { callee: name.clone(), contract: "pure: reads nothing, writes nothing".to_string() }).collect();`
       - Set `inferred_summaries: if inferred.is_empty() { None } else { Some(inferred) }` in the `JsonVerificationReport` construction.
       - Also update the non-JSON report path's `JsonVerificationReport` construction (if any exists) to include `inferred_summaries: None`.

    2. In `crates/analysis/src/vcgen.rs` test module (at the end of the file, near other `test_opaque_callee_*` tests):
       - Add `test_infer_summary_suppresses_opaque_callee`: builds a minimal Function with one call_site whose callee_name = "inferred_callee", builds a ContractDatabase with a FunctionSummary for "inferred_callee" with `is_inferred: true`, empty requires/ensures, calls `generate_call_site_vcs(...)`, asserts `vcs.is_empty()`.
       - Add `test_infer_summary_no_suppression_without_flag`: same callee name absent from contract_db (or present with is_inferred=false) — asserts exactly one VC with `vc_kind == VcKind::OpaqueCallee`.

    3. In `crates/driver/src/json_output.rs` test module: Add `test_inferred_summaries_json_field` confirming serialization behavior (Some → present, None → absent).

    Run `cargo clippy --workspace -- -D warnings` and `cargo test --workspace` to confirm full pass.
  </action>
  <verify>
    <automated>cd /Users/alexanderfedin/Projects/hapyy/rust-fv && cargo test --workspace 2>&1 | grep -E "test_infer_summary|FAILED|test result" | tail -20</automated>
  </verify>
  <done>
    - `callbacks.rs` populates `inferred_summaries` in JSON report from is_inferred entries in contract_db
    - `test_infer_summary_suppresses_opaque_callee` passes
    - `test_infer_summary_no_suppression_without_flag` passes
    - `test_inferred_summaries_json_field` passes
    - `cargo test --workspace` exits 0, no FAILED lines
    - Phase 36 OPAQUE-03 fully implemented and tested
  </done>
</task>

</tasks>

<verification>
Full workspace confirmation:

```bash
cd /Users/alexanderfedin/Projects/hapyy/rust-fv
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

Key checks:
1. `inferred_summaries` absent from JSON when no infer_summary callees (skip_serializing_if works)
2. `inferred_summaries` present with correct entries when infer_summary callees exist
3. All prior opaque callee tests (V060/V061) still pass unchanged
4. All existing json_output tests pass (inferred_summaries: None added to all test constructions)
</verification>

<success_criteria>
- `InferredSummary { callee: String, contract: String }` in json_output.rs
- `JsonVerificationReport.inferred_summaries: Option<Vec<InferredSummary>>` with skip_serializing_if
- `ContractDatabase::iter()` method available
- `callbacks.rs` wires inferred_summaries from contract_db into JSON report
- 3 new tests pass: suppresses OpaqueCallee VC, does not suppress without flag, JSON field serialization
- `cargo clippy --workspace -- -D warnings` exits 0
- `cargo test --workspace` exits 0, 0 FAILED
- OPAQUE-03 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/36-summary-contract-inference/36-02-SUMMARY.md` using the summary template.
</output>

---
milestone: v0.4
audited: 2026-02-20
status: gaps_found
scores:
  requirements: 12/16
  phases: 3/5
  integration: 9/12
  flows: 3/4
gaps:
  requirements:
    - id: "HOF-01"
      status: "unsatisfied"
      phase: "Phase 22"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 22 (Higher-Order Closures) has not been executed. No plans, no SUMMARY.md, no VERIFICATION.md."
    - id: "HOF-02"
      status: "unsatisfied"
      phase: "Phase 22"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 22 (Higher-Order Closures) has not been executed. No plans, no SUMMARY.md, no VERIFICATION.md."
    - id: "ASY-01"
      status: "unsatisfied"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 23 (Async/Await Verification) has not been executed. No plans, no SUMMARY.md, no VERIFICATION.md."
    - id: "ASY-02"
      status: "unsatisfied"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 23 (Async/Await Verification) has not been executed. No plans, no SUMMARY.md, no VERIFICATION.md."
  integration:
    - id: "SEP-04-PRODUCTION-GAP"
      severity: "high"
      from: "crates/driver/src/callbacks.rs (ghost_pred_db field)"
      to: "crates/analysis/src/vcgen.rs generate_vcs()"
      issue: "ghost_pred_db extracted from HIR in callbacks.rs but never passed through VerificationTask to generate_vcs(). vcgen.rs line 3086 calls parse_spec_expr() with hardcoded empty GhostPredicateDatabase. User-defined #[ghost_predicate] functions silently produce no VCs in production — spec parse returns None."
      requirements: ["SEP-04"]
    - id: "CEX-04-VCKIND-INCONSISTENCY"
      severity: "medium"
      from: "crates/driver/src/parallel.rs line 406"
      to: "crates/driver/src/callbacks.rs line 322"
      issue: "JsonFailure.counterexample_v2.vc_kind uses format!(\"{:?}\", vc_kind).to_lowercase() producing 'weakmemorycoherence'; JsonFailure.vc_kind uses vc_kind_to_string() producing 'weak_memory_coherence'. Two fields in same struct disagree for all WeakMemory* variants."
      requirements: ["CEX-04"]
    - id: "WMM-MISSING-HELP-TEXT"
      severity: "low"
      from: "crates/driver/src/diagnostics.rs"
      to: "WeakMemory* failure paths"
      issue: "suggest_fix() wildcard arm returns None for WeakMemoryCoherence/Race/Atomicity. report_text_only() has no format_weak_memory_help() equivalent. Users see error description but no actionable fix suggestion or weak-memory-specific guidance."
      requirements: ["WMM-01", "WMM-03"]
tech_debt:
  - phase: "19-counterexample-generation"
    items:
      - "Human verification required: real cargo verify run needed to confirm Rust variable names appear in text + JSON output (ariadne terminal output cannot be validated statically)"
  - phase: "21-weak-memory-models"
    items:
      - "Human verification required: IRIW and LB litmus tests use non-standard encodings (LIA timestamp-based, direct rf-cycle). Approximate encodings are conservative but require RC11 domain expert review to confirm soundness is not accidental."
      - "Litmus tests (weak_memory_litmus.rs) use custom SMT scripts rather than generate_rc11_vcs() — failures produce no ariadne output or JSON counterexample_v2 (design decision, documented)"
---

# v0.4 Full Rust Verification — Milestone Audit

**Milestone:** v0.4 Full Rust Verification
**Audited:** 2026-02-20
**Status:** gaps_found
**Scope:** Phases 19–23 (Counterexample Generation, Separation Logic, Weak Memory Models, Higher-Order Closures, Async/Await)

---

## Executive Summary

3 of 5 phases complete. 12 of 16 requirements satisfied. Phases 22 (HOF-01, HOF-02) and 23 (ASY-01, ASY-02) not yet started — these are the primary blockers. Integration audit of completed phases 19–21 revealed one high-priority wiring gap in SEP-04 (ghost_pred_db not propagated to production VCGen path), one medium JSON consistency issue, and one low-severity missing help text gap.

---

## Phase Status

| Phase | Name | Plans | VERIFICATION | Status |
|-------|------|-------|--------------|--------|
| 19 | Counterexample Generation | 4/4 | ✓ passed | ✓ Complete |
| 20 | Separation Logic | 4/4 | ✓ passed | ✓ Complete |
| 21 | Weak Memory Models | 3/3 | ✓ passed | ✓ Complete |
| 22 | Higher-Order Closures | 0/TBD | ✗ missing | ✗ Not started |
| 23 | Async/Await Verification | 0/TBD | ✗ missing | ✗ Not started |

---

## Requirements Coverage (3-Source Cross-Reference)

| Requirement | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|-------------|-------------|-----------------|---------------------|-----------------|--------------|
| CEX-01 | Rust variable names in counterexample | Phase 19: passed | Not in frontmatter | [x] Complete | **satisfied** |
| CEX-02 | Typed Rust values in counterexample | Phase 19: passed | Not in frontmatter | [x] Complete | **satisfied** |
| CEX-03 | Ariadne inline labels at failing line | Phase 19: passed | Not in frontmatter | [x] Complete | **satisfied** |
| CEX-04 | Structured counterexample in JSON | Phase 19: passed ¹ | Not in frontmatter | [x] Complete | **partial** (WeakMemory* vc_kind field inconsistency) |
| SEP-01 | pts_to ownership predicate | Phase 20: passed | Not in frontmatter | [x] Complete | **satisfied** |
| SEP-02 | Separating conjunction in specs | Phase 20: passed | Not in frontmatter | [x] Complete | **satisfied** |
| SEP-03 | Frame rule auto-applied | Phase 20: passed | Not in frontmatter | [x] Complete | **satisfied** |
| SEP-04 | Ghost predicates via #[ghost_predicate] | Phase 20: passed ² | Not in frontmatter | [x] Complete | **partial** (integration-test-only, not E2E wired) |
| WMM-01 | RC11 for Relaxed/Acquire/Release/AcqRel | Phase 21: passed | Not in frontmatter | [x] Complete | **satisfied** |
| WMM-02 | 8 canonical C11 litmus tests pass | Phase 21: passed | Not in frontmatter | [x] Complete | **satisfied** |
| WMM-03 | Data race detection for weak memory | Phase 21: passed | Not in frontmatter | [x] Complete | **satisfied** |
| WMM-04 | WeakMemory* VcKind scoping — no regressions | Phase 21: passed | Not in frontmatter | [x] Complete | **satisfied** |
| HOF-01 | fn_spec closure entailments | Phase 22: missing | N/A | [ ] Pending | **unsatisfied** |
| HOF-02 | FnMut stateful closure SSA env tracking | Phase 22: missing | N/A | [ ] Pending | **unsatisfied** |
| ASY-01 | async fn requires/ensures verification | Phase 23: missing | N/A | [ ] Pending | **unsatisfied** |
| ASY-02 | #[state_invariant] at await points | Phase 23: missing | N/A | [ ] Pending | **unsatisfied** |

¹ CEX-04 is wired but `JsonFailure.vc_kind` and `JsonFailure.counterexample_v2.vc_kind` produce inconsistent strings for WeakMemory* variants.
² SEP-04 passes integration tests (`sep_logic_integration.rs`) but `ghost_pred_db` is not propagated through `VerificationTask` to `generate_vcs()` in production — ghost predicate expansion is test-only.

**Score: 12/16 requirements satisfied (10 fully, 2 partial, 4 unsatisfied)**

---

## Orphaned Requirements

None. All 16 requirements in REQUIREMENTS.md traceability table appear in at least one phase plan.

**Note:** SUMMARY.md frontmatter does not include `requirements_completed` fields across any phase — this is a structural gap in artifact completeness but does not indicate requirements were skipped.

---

## Cross-Phase Integration Findings

### Check 1: Phase 19 (CEX) + Phase 21 (WMM) Integration
**Result: WIRED with medium inconsistency**

Counterexample pipeline correctly handles all VcKind variants including WeakMemory* (variant-agnostic). However:

- `JsonFailure.vc_kind` (from `vc_kind_to_string()` in `callbacks.rs:322`) → `"weak_memory_coherence"`
- `JsonFailure.counterexample_v2.vc_kind` (from `format!("{:?}", vc).to_lowercase()` in `parallel.rs:406`) → `"weakmemorycoherence"`

Machine consumers receive inconsistent strings in the same JSON object. Affects CEX-04.

### Check 2: Phase 20 (SEP) + Phase 21 (WMM) Isolation
**Result: FULLY ISOLATED — no interference**

Sep-logic VCs (`QF_AUFBV` heap encoding) and weak memory VCs (`QF_LIA` integer arithmetic) generated in completely separate code paths. VcKind variants are disjoint. WMM-04 scoping is enforced by `generate_concurrency_vcs()` structure.

### Check 3: WeakMemory* VcKind driver coverage
**Result: COMPLETE for JSON; PARTIAL for text**

- `vc_kind_to_string()` in `callbacks.rs`: exhaustive non-wildcard match ✓
- `vc_kind_description()` in `diagnostics.rs`: exhaustive match, all three WeakMemory* variants have human-readable strings ✓
- `suggest_fix()` in `diagnostics.rs`: wildcard `_ => None` swallows all WeakMemory* → no fix suggestions for users ✗
- `report_text_only()` in `diagnostics.rs`: no `format_weak_memory_help()` equivalent ✗

### Check 4: E2E Flow — annotate → VCs → Z3 → counterexample with readable names

**Traced path:**
1. ✓ `extract_contracts()` — HIR contracts extracted
2. ✓ `extract_ghost_predicates()` → `self.ghost_pred_db` populated
3. ✓ `mir_converter::convert_mir()` — MIR to IR
4. ✓ `generate_vcs()` called from `parallel.rs:262`
5. ✗ **BREAK**: `parse_spec()` in `vcgen.rs:3086` calls `parse_spec_expr()` with hardcoded empty `GhostPredicateDatabase`. `ghost_pred_db` from `callbacks.rs` never passed through `VerificationTask` or `generate_vcs()` signature.
6. ✓ Z3 solver invoked
7. ✓ `build_counterexample_v2()` → `ir_func.source_names` for readable names
8. ✓ Ariadne labels at source line (CEX-03)
9. ✓ JSON output via `JsonFailure.counterexample_v2` (CEX-04)

**Silent degradation at step 5:** Specs using `#[ghost_predicate]`-defined terms silently produce no VCs in production. E2E flow is complete for built-in predicates (`pts_to`, separating conjunction, standard contracts) but broken for user-defined ghost predicates (SEP-04).

---

## Integration Issues by Severity

### High Priority

**SEP-04: ghost_pred_db not wired into production VCGen path**

| | |
|---|---|
| Requirement | SEP-04 |
| Files | `crates/driver/src/parallel.rs` (VerificationTask struct), `crates/analysis/src/vcgen.rs:224` (generate_vcs signature), `crates/analysis/src/vcgen.rs:3086` (parse_spec call) |
| Symptom | User writes `#[ghost_predicate] fn linked_list(...)`, uses it in `#[requires]` — VC generation silently returns None, no verification happens |
| Fix | Add `ghost_pred_db: GhostPredicateDatabase` field to `VerificationTask`; pass from `callbacks.rs` through `parallel.rs` to `generate_vcs()`; replace `parse_spec_expr()` call with `parse_spec_expr_with_db()` at `vcgen.rs:3086` |

### Medium Priority

**CEX-04: vc_kind field inconsistency in JsonFailure for WeakMemory* variants**

| | |
|---|---|
| Requirement | CEX-04 |
| Files | `crates/driver/src/parallel.rs:406`, `crates/driver/src/callbacks.rs:322` |
| Symptom | `JsonFailure.vc_kind` = `"weak_memory_coherence"`, `JsonFailure.counterexample_v2.vc_kind` = `"weakmemorycoherence"` — same struct, same concept, different format |
| Fix | Change `parallel.rs:406` to use `vc_kind_to_string(&vc_location.vc_kind)` instead of `format!("{:?}", …).to_lowercase()` |

### Low Priority

**WMM-01/WMM-03: No user-facing fix suggestions or help text for weak memory failures**

| | |
|---|---|
| Requirements | WMM-01, WMM-03 |
| Files | `crates/driver/src/diagnostics.rs` — `suggest_fix()` wildcard arm, `report_text_only()` |
| Symptom | User encounters `WeakMemoryCoherence` failure — sees error description but no "try using Acquire/Release instead of Relaxed" guidance |
| Fix | Add explicit match arms in `suggest_fix()` for WeakMemory* variants; add `format_weak_memory_help()` function analogous to `format_data_race_help()` |

---

## Tech Debt (Non-Blocking)

**Phase 19 — Human verification deferred:**
- Real `cargo verify` run required to confirm Rust variable names appear correctly in text + JSON output. Ariadne terminal output cannot be validated statically.

**Phase 21 — RC11 encoding review deferred:**
- IRIW and LB litmus tests use non-standard LIA-based encodings (timestamp-based for IRIW, direct rf-cycle for LB) rather than the full psc axiom. Tests pass (UNSAT), but RC11 domain expert should confirm encodings are sound for the right reason, not accidentally.
- Litmus tests use custom SMT scripts (not `generate_rc11_vcs()`) — failures produce no ariadne output or JSON counterexample. Documented design decision.

---

## Milestone Definition of Done Assessment

From ROADMAP.md: *"Complete Rust verification coverage — every major language feature verifiable with no exceptions and no compromises. Counterexample generation, separation logic, weak memory models, higher-order closure spec entailments, and async/await functional verification."*

| Component | Status |
|-----------|--------|
| Counterexample generation | ✓ Complete (with minor JSON inconsistency for WeakMemory*) |
| Separation logic | ✓ Complete (ghost predicates integration-test-only in production) |
| Weak memory models | ✓ Complete (help text missing, encoding review deferred) |
| Higher-order closure spec entailments | ✗ Not started |
| Async/await functional verification | ✗ Not started |

**The milestone definition of done is NOT met.** Phases 22 and 23 are required by the milestone goal but have not been planned or executed.

---

## Summary

**Requirements:** 12/16 satisfied (4 unsatisfied: HOF-01, HOF-02, ASY-01, ASY-02)
**Phases:** 3/5 complete (phases 22, 23 not started)
**Integration:** 9/12 checks pass (3 issues: SEP-04 high, CEX-04 medium, WMM help text low)
**Flows:** 3/4 complete (SEP-04 ghost predicate E2E broken in production)

---

*Audit generated: 2026-02-20*
*Integration checker: Claude (gsd-integration-checker)*

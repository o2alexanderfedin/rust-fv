---
milestone: v0.4
milestone_name: Full Rust Verification
audited: 2026-02-21T00:25:00Z
status: gaps_found
scores:
  requirements: 13/16
  phases: 4/5
  integration: 13/16
  flows: 5/7
gaps:
  requirements:
    - id: "SEP-04"
      status: "partial"
      phase: "20-separation-logic"
      claimed_by_plans: ["20-03-PLAN.md", "20-04-PLAN.md"]
      completed_by_plans: ["20-04-SUMMARY.md (requirements-completed: [SEP-01, SEP-02, SEP-03, SEP-04])"]
      verification_status: "passed"
      evidence: "Phase 20 VERIFICATION passed 7/7. Integration check reveals CRITICAL wiring gap: GhostPredicateDatabase extracted in callbacks.rs self.ghost_pred_db is NEVER passed into VerificationTask or generate_vcs(). parse_spec() in vcgen.rs:3092 calls spec_parser::parse_spec_expr (db-less version), not parse_spec_expr_with_db. Ghost predicates are silently non-functional in the production driver pipeline."
    - id: "ASY-01"
      status: "unsatisfied"
      phase: "23-async-await"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 23 (Async/Await Verification) has not been started. No PLAN.md, no VERIFICATION.md, no code."
    - id: "ASY-02"
      status: "unsatisfied"
      phase: "23-async-await"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 23 (Async/Await Verification) has not been started. No PLAN.md, no VERIFICATION.md, no code."
  integration:
    - issue: "SEP-04: ghost_pred_db not threaded into production vcgen path"
      from: "crates/driver/src/callbacks.rs:401 — self.ghost_pred_db = extract_ghost_predicates(tcx)"
      to: "crates/analysis/src/vcgen.rs:3092 — spec_parser::parse_spec_expr(spec, func)"
      gap: "VerificationTask struct (parallel.rs:20-44) has no ghost_pred_db field. Construction in callbacks.rs:631 does not include it. generate_vcs() takes only func and contract_db. parse_spec() calls the db-less parse_spec_expr."
      requirements: ["SEP-04"]
      severity: "critical"
    - issue: "CEX-02/CEX-04: vscode extension consumes legacy counterexample only"
      from: "parallel.rs::build_counterexample_v2 → JsonFailure.counterexample_v2 (correctly serialized)"
      to: "vscode-extension/src/diagnostics.ts:66 — reads failure.counterexample (flat legacy format)"
      gap: "diagnostics.ts and outputPanel.ts import JsonAssignment but not JsonCounterexample. counterexample_v2 never read in extension. CLI output is correct."
      requirements: ["CEX-02", "CEX-04"]
      severity: "non-critical"
  flows:
    - flow: "User writes #[ghost_predicate] fn linked(p) = pts_to(...) and uses it in spec"
      breaks_at: "Step 5 — VerificationTask built WITHOUT ghost_pred_db (parallel.rs)"
      specific_files:
        - "crates/driver/src/parallel.rs:20-44 (VerificationTask struct — no ghost_pred_db)"
        - "crates/driver/src/callbacks.rs:631 (VerificationTask push — ghost_pred_db not included)"
        - "crates/analysis/src/vcgen.rs:3092 (parse_spec calls db-less parse_spec_expr)"
      requirements: ["SEP-04"]
    - flow: "vscode extension user views counterexample — typed values not shown"
      breaks_at: "Step 5 — diagnostics.ts reads legacy counterexample only"
      specific_files:
        - "vscode-extension/src/diagnostics.ts:66"
        - "vscode-extension/src/outputPanel.ts:115"
      requirements: ["CEX-02", "CEX-04"]
      severity: "non-critical"
tech_debt:
  - phase: 22-higher-order-closures
    items:
      - "hof_vcgen.rs uses inline DeclareSort + DeclareFun instead of encode_closure_as_uninterpreted() — Z3 confirmed functionally equivalent"
  - phase: 19-counterexample-generation
    items:
      - "vscode extension counterexample_v2 interface declared but never consumed — diagnostics.ts and outputPanel.ts still use legacy flat format"
---

# Milestone v0.4 Audit: Full Rust Verification

**Audited:** 2026-02-21
**Status:** ⚠ gaps_found
**Requirements:** 13/16 satisfied
**Phases verified:** 4/5 (Phase 23 not started)
**Integration flows:** 5/7 complete

---

## Requirements Coverage (3-Source Cross-Reference)

| Requirement | Description | VERIFICATION.md | SUMMARY frontmatter | REQUIREMENTS.md | Final Status |
|-------------|-------------|-----------------|---------------------|-----------------|-------------|
| CEX-01 | Rust variable names (not SSA) in counterexample | Phase 19: passed | 19-01 (gap closure) | `[x]` | **satisfied** |
| CEX-02 | Typed Rust values in counterexample output | Phase 19: passed | 19-02: `[CEX-02]` | `[x]` | **satisfied** (CLI correct; IDE: tech debt) |
| CEX-03 | Ariadne inline labels at failing source line | Phase 19: passed | 19-03: `[CEX-03]` | `[x]` | **satisfied** |
| CEX-04 | Structured counterexample in `--output-format=json` | Phase 19: passed | 19-02 | `[x]` | **satisfied** (CLI correct; IDE: tech debt) |
| SEP-01 | `pts_to(p, v)` ownership predicate in specs | Phase 20: passed | 20-01: `[SEP-01]` | `[x]` | **satisfied** |
| SEP-02 | Separating conjunction `H1 * H2` in specs | Phase 20: passed | 20-03: `[SEP-02]` | `[x]` | **satisfied** |
| SEP-03 | Frame rule auto-applied during function calls | Phase 20: passed | 20-03: `[SEP-03]` | `[x]` | **satisfied** |
| SEP-04 | Recursive heap predicates via `#[ghost_predicate]` | Phase 20: passed | 20-03/04: `[SEP-04]` | `[x]` | **partial** ⚠ critical wiring gap |
| WMM-01 | RC11 coherence axioms for weak memory orderings | Phase 21: passed | 21-02/03 | `[x]` | **satisfied** |
| WMM-02 | 8 canonical C11 litmus tests pass | Phase 21: passed | 21-03: `[WMM-02]` | `[x]` | **satisfied** |
| WMM-03 | Data race detection for weak memory orderings | Phase 21: passed | 21-03: `[WMM-03]` | `[x]` | **satisfied** |
| WMM-04 | WeakMemory VcKind scope — no SeqCst regressions | Phase 21: passed | 21-03 (implicit) | `[x]` | **satisfied** |
| HOF-01 | `fn_spec(f, |x| pre => post)` closure entailment | Phase 22: passed | 22-03: `[HOF-01]` | `[x]` | **satisfied** |
| HOF-02 | FnMut stateful closures with env versioning | Phase 22: passed | 22-03: `[HOF-02]` | `[x]` | **satisfied** |
| ASY-01 | `async fn` with `#[requires]`/`#[ensures]` | **MISSING** | not present | `[ ]` | **unsatisfied** ✗ |
| ASY-02 | `#[state_invariant]` at `.await` suspension points | **MISSING** | not present | `[ ]` | **unsatisfied** ✗ |

---

## Phase Verification Summary

| Phase | Name | Verification | Score | Status |
|-------|------|-------------|-------|--------|
| 19 | Counterexample Generation | ✓ | 4/4 (re-verified) | passed |
| 20 | Separation Logic | ✓ | 7/7 | passed |
| 21 | Weak Memory Models | ✓ | 14/14 | passed |
| 22 | Higher-Order Closures | ✓ | 12/12 | passed |
| 23 | Async/Await Verification | ✗ | Not started | **unverified** |

---

## Critical Gaps

### 1. SEP-04: ghost_pred_db Production Wiring Gap

**Severity:** Critical blocker

`GhostPredicateDatabase` is correctly extracted in `callbacks.rs` but never reaches the verification pipeline:

| Location | Issue |
|----------|-------|
| `crates/driver/src/parallel.rs:20-44` | `VerificationTask` struct has no `ghost_pred_db` field |
| `crates/driver/src/callbacks.rs:631` | `VerificationTask` push omits `ghost_pred_db` |
| `crates/analysis/src/vcgen.rs:3092` | `parse_spec()` calls `parse_spec_expr` (db-less), not `parse_spec_expr_with_db` |

**Effect:** `#[ghost_predicate]` definitions are silently not expanded in `#[requires]`/`#[ensures]` specs during production verification. Unit/integration tests bypass this gap by calling `parse_spec_expr_with_db` directly.

**Fix:** Thread `ghost_pred_db: Arc<GhostPredicateDatabase>` through `VerificationTask`, `generate_vcs()` signature, and switch `parse_spec` call at `vcgen.rs:3092` to `parse_spec_expr_with_db`.

### 2. ASY-01 and ASY-02: Phase 23 Not Started

**Severity:** Milestone completion blocker

Phase 23 (Async/Await Verification) has no PLAN.md, no implementation, and no VERIFICATION.md. Both `async fn` spec annotation (ASY-01) and `#[state_invariant]` at `.await` points (ASY-02) are completely unimplemented.

---

## Non-Critical Tech Debt

### CEX-02/CEX-04: VSCode Extension Uses Legacy Counterexample Format

The vscode extension interface correctly declares `counterexample_v2?: JsonCounterexample` in `verifier.ts:29`, and the Rust backend serializes the rich typed counterexample to JSON. However:

- `diagnostics.ts:66` reads `failure.counterexample` (flat legacy)
- `outputPanel.ts:115` reads `failure.counterexample` (flat legacy)
- `counterexample_v2` is never read anywhere in the extension

**Impact:** CLI users see fully typed counterexamples. VSCode extension users see only the legacy flat format.
**Classification:** Non-critical — requirements specify "output" which is satisfied by CLI. IDE enrichment is a quality-of-life item.

---

## Integration Check Results

| Requirement | Integration Path | Status |
|-------------|-----------------|--------|
| CEX-01 | `build_source_names` → `ir::Function.source_names` → `cex_render` → `JsonCexVariable.name` | ✓ WIRED |
| CEX-02 | `cex_render::render_typed_value` → `JsonCexVariable.{type,display}` → JSON output | ✓ CLI / ⚠ IDE legacy |
| CEX-03 | `build_source_location_map` → `VcLocation.source_*` → `report_with_ariadne` | ✓ WIRED |
| CEX-04 | `json_output.rs::JsonCounterexample` → `build_counterexample_v2` → serialized | ✓ CLI / ⚠ IDE legacy |
| SEP-01 | `spec_parser "pts_to"` → `sep_logic::encode_pts_to` → vcgen | ✓ WIRED |
| SEP-02 | `is_sep_logic_formula` + sep-conj detection → `Term::And` | ✓ WIRED |
| SEP-03 | `generate_call_site_vcs` → `sep_logic::build_frame_axiom` | ✓ WIRED |
| SEP-04 | `extract_ghost_predicates` → `self.ghost_pred_db` → ??? | ✗ UNWIRED in production |
| WMM-01 | `rc11::generate_rc11_vcs` → `generate_concurrency_vcs` via `has_non_seqcst_atomics` gate | ✓ WIRED |
| WMM-02 | `weak_memory_litmus.rs` 9 tests → `generate_concurrency_vcs` → Z3 UNSAT | ✓ WIRED |
| WMM-03 | `generate_rc11_vcs` Step J: `WeakMemoryRace` VC for relaxed cross-thread | ✓ WIRED |
| WMM-04 | `has_non_seqcst_atomics` gate in `generate_concurrency_vcs:3474` | ✓ WIRED |
| HOF-01 | `#[fn_spec]` → `callbacks.rs FnSpec` → `vcgen.rs:705` → `generate_fn_spec_vcs` | ✓ WIRED |
| HOF-02 | `FnMut` path in `build_fnmut_vc_script` with `env_before_/env_after_` versioning | ✓ WIRED |
| ASY-01 | Not started | ✗ MISSING |
| ASY-02 | Not started | ✗ MISSING |

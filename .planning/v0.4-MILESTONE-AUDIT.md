---
milestone: v0.4
audited: 2026-02-23
status: gaps_found
scores:
  requirements: 15/16
  phases: 7/7
  integration: 28/28 wired (1 anomaly)
  flows: 5/5 complete
gaps:
  requirements:
    - id: "WMM-03"
      status: "partial"
      phase: "Phase 21"
      claimed_by_plans: ["21-01-PLAN.md", "21-02-PLAN.md", "21-03-PLAN.md"]
      completed_by_plans: ["21-03-SUMMARY.md"]
      verification_status: "passed"
      evidence: |
        WeakMemoryRace VC body is Assert(BoolLit(false)) — always UNSAT from Z3.
        Driver interprets Unsat as verified:true, so relaxed data races are reported as
        'safe' regardless of whether a real race exists. test_relaxed_data_race_detected
        only checks VC presence (structural), not solver outcome. The feature does not
        surface race warnings to the user via the driver pipeline. This is an integration
        gap: the implementation generates the VC structure but does not achieve the
        functional goal of detecting weak-memory races via the solver.
  integration: []
  flows: []
tech_debt:
  - phase: 21-weak-memory-models
    items:
      - "Human verification needed: IRIW and LB litmus tests use approximate LIA encodings (not full psc axiom) — RC11 domain expert should confirm soundness"
      - "WeakMemoryRace VC (Step J) emits Assert(BoolLit(false)) — structural marker only, not solver-evaluated"
  - phase: 19-counterexample-generation
    items:
      - "Human verification needed: terminal ariadne rendering requires real SMT run to visually confirm Rust variable names appear as inline span labels"
  - phase: 25-vscode-counterexample-v2
    items:
      - "Human verification needed: VSCode hover tooltip and output panel rendering require running VSCode host process to visually confirm typed counterexample format"
  - phase: 24-sep04-ghost-predicate-wiring
    items:
      - "Human verification needed: ghost predicate end-to-end requires real cargo verify run with #[ghost_predicate] annotated function"
---

# Milestone Audit: v0.4 Full Rust Verification

**Audited:** 2026-02-23  
**Milestone:** v0.4 Full Rust Verification  
**Status:** ⚠ gaps_found  
**Requirements:** 15/16 satisfied  
**Phases:** 7/7 complete, all verifications passed  
**Integration:** 28/28 exports wired — 1 anomaly detected  
**Flows:** 5/5 E2E flows complete  

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | VERIFICATION.md | SUMMARY.md | REQUIREMENTS.md | Final Status |
|--------|----------------|------------|-----------------|--------------|
| CEX-01 | Phase 19: passed | 19-01 (structural) | [x] | ✓ satisfied |
| CEX-02 | Phase 19+25: passed | 19-02: [CEX-02], 25-01 provides CEX-02 | [x] | ✓ satisfied |
| CEX-03 | Phase 19: passed | 19-03: [CEX-03] | [x] | ✓ satisfied |
| CEX-04 | Phase 19+25: passed | 19-04 (structural), 25-01 provides CEX-04 | [x] | ✓ satisfied |
| SEP-01 | Phase 20: passed | 20-01: [SEP-01], 20-04: [SEP-01,...] | [x] | ✓ satisfied |
| SEP-02 | Phase 20: passed | 20-03: [SEP-02,...] | [x] | ✓ satisfied |
| SEP-03 | Phase 20: passed | 20-03: [SEP-03,...] | [x] | ✓ satisfied |
| SEP-04 | Phase 24: passed | 24-01: [SEP-04], 24-02: [SEP-04] | [x] | ✓ satisfied |
| WMM-01 | Phase 21: passed | 21-01/02 structural | [x] | ✓ satisfied |
| WMM-02 | Phase 21: passed | 21-03: [WMM-02,...] | [x] | ✓ satisfied |
| WMM-03 | Phase 21: passed (VC presence only) | 21-03: [WMM-03] | [x] | ⚠ partial |
| WMM-04 | Phase 21: passed | 21-01/02 structural | [x] | ✓ satisfied |
| HOF-01 | Phase 22: passed | 22-03: [HOF-01, HOF-02] | [x] | ✓ satisfied |
| HOF-02 | Phase 22: passed | 22-03: [HOF-01, HOF-02] | [x] | ✓ satisfied |
| ASY-01 | Phase 23: passed | 23-04 structural (QF_LIA async VC) | [x] | ✓ satisfied |
| ASY-02 | Phase 23: passed | 23-04 structural (state_invariant VC) | [x] | ✓ satisfied |

**Orphan detection:** 0 orphaned requirements — all 16 REQ-IDs appear in at least one phase VERIFICATION.md.

---

## Phase Summary

| Phase | Status | Score | Tech Debt |
|-------|--------|-------|-----------|
| 19 — Counterexample Generation | ✓ passed | 4/4 criteria | Human verification (terminal ariadne) |
| 20 — Separation Logic | ✓ passed | 7/7 must-haves | None |
| 21 — Weak Memory Models | ✓ passed | 14/14 must-haves | WMM-03 integration gap; IRIW/LB human review |
| 22 — Higher-Order Closures | ✓ passed | 12/12 must-haves | None |
| 23 — Async/Await | ✓ passed | 13/13 must-haves | None |
| 24 — SEP-04 Ghost Predicate Wiring | ✓ passed | 4/4 must-haves | Human verification (cargo verify) |
| 25 — VSCode Counterexample v2 | ✓ passed | 5/5 must-haves | Human verification (VSCode host) |

---

## Integration Findings

### Cross-Phase Wiring

**28 exports consumed across 7 phases — 0 orphaned:**
- `cex_render::render_counterexample` → diagnostics.rs + parallel.rs ✓
- `JsonCounterexample`/`JsonCexVariable` → verifier.ts (TypeScript mirror) ✓
- `renderCounterexampleLines` → diagnostics.ts createDiagnostic() + outputPanel.ts ✓
- `sep_logic::encode_pts_to` → spec_parser.rs ✓
- `sep_logic::build_frame_axiom` → vcgen.rs ✓
- `GhostPredicateDatabase` → callbacks.rs → parallel.rs → generate_vcs_with_db() ✓
- `generate_vcs_with_db` → parallel.rs:verify_single() ✓
- `has_non_seqcst_atomics` → vcgen.rs:generate_concurrency_vcs() ✓
- `generate_async_vcs` → vcgen.rs dispatch ✓
- `generate_fn_spec_vcs` → vcgen.rs dispatch ✓
- `parse_spec_expr_with_db` → vcgen.rs:parse_spec() ✓
- `parse_spec_expr_qf_lia` → async_vcgen.rs ✓

**Planned connection not implemented (acceptable deviation):** `hof_vcgen.rs` reimplements `encode_closure_as_uninterpreted` inline (DeclareSort + DeclareFun) rather than calling `defunctionalize.rs` — Z3 tests confirm equivalence.

### E2E Flows

| Flow | Status | Notes |
|------|--------|-------|
| CEX: cargo verify → Rust-named counterexample (CLI) | ✓ complete | source_names path confirmed |
| CEX: JSON output → VSCode inline squiggly + output panel | ✓ complete | renderCounterexampleLines shared helper |
| SEP: pts_to + frame rule + ghost predicates | ✓ complete | Arc<GhostPredicateDatabase> threaded end-to-end |
| WMM: RC11 axioms → Z3 → coherence/atomicity detection | ✓ complete (WMM-01/02/04) | |
| HOF: fn_spec entailment → AUFLIA → Z3 | ✓ complete | |
| ASY: async fn → QF_LIA → state invariant | ✓ complete | ghost_pred_db threaded into async_vcgen |

---

## Gap Detail: WMM-03

**Requirement:** Data race detection extends to cover weak memory orderings (not just SeqCst)

**Integration finding:** `WeakMemoryRace` VC in `rc11.rs` (Step J, lines 525-596) emits:
```smt2
(assert false)
(check-sat)
```
`Assert(BoolLit(false))` is always UNSAT. The driver pipeline interprets Unsat as `verified: true` (safe). Relaxed data races structurally detected by the VC generator are silently reported as safe to the user — the race warning never surfaces.

**Evidence:** `test_relaxed_data_race_detected` (line 1487 in `weak_memory_litmus.rs`) only verifies that a `WeakMemoryRace` VC is present in the VC vector. It does not send the VC to Z3 or verify the Z3 result is SAT (indicating a detected race). The Phase 21 VERIFICATION.md passed this as WMM-03 evidence, but the integration between VC generation and driver result interpretation was not verified.

**Impact:** Users writing programs with Relaxed data races will see a "verified" result instead of a race warning when using weak memory orderings.

**Fix:** `WeakMemoryRace` VC body should emit actual race-existence constraints (concurrent conflicting accesses with no synchronization in the mo/rf/co relations), not `Assert(false)`.

---

## Tech Debt Summary

| Phase | Item | Severity |
|-------|------|----------|
| 21 | WMM-03: WeakMemoryRace VC is Assert(false) — race never detected via solver | **Gap** |
| 21 | IRIW/LB litmus use approximate LIA encodings — needs RC11 expert soundness review | Non-critical |
| 19 | Terminal ariadne inline rendering: human smoke test required | Non-critical |
| 24 | Ghost predicate E2E: human smoke test required (`cargo verify` with `#[ghost_predicate]`) | Non-critical |
| 25 | VSCode hover/output panel: human smoke test required (running VSCode host) | Non-critical |

---

## Regression Protection

| Risk | Gate | Status |
|------|------|--------|
| WMM axioms contaminate SeqCst VCs | `has_non_seqcst_atomics()` in vcgen.rs:3568 | ✓ active |
| QF_LIA (async) bleeds into QF_BV path | `coroutine_info.is_some()` dispatch guard | ✓ active |
| AUFLIA (HOF) bleeds into AUFBV (SEP) | Per-VC logic selection at script emission | ✓ active |
| generate_vcs() backward compat | Shim → generate_vcs_with_db(empty_db) | ✓ active |
| 1200+ test suite regressions | All tests pass (confirmed in all phase VERIFICATIONs) | ✓ active |

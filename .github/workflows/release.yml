name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  verify-tag:
    name: Verify tag is on main
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is reachable from main
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor "${{ github.sha }}" origin/main; then
            echo "ERROR: Tag ${{ github.ref_name }} is not on the main branch."
            exit 1
          fi

  build:
    name: Build (${{ matrix.os }})
    needs: verify-tag
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_suffix: linux-x86_64
            binary_ext: ""
          - os: macos-latest
            artifact_suffix: macos-aarch64
            binary_ext: ""
          - os: windows-latest
            artifact_suffix: windows-x86_64
            binary_ext: ".exe"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Z3 SMT solver (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y z3

      - name: Install Z3 SMT solver (macOS)
        if: runner.os == 'macOS'
        run: brew install z3

      - name: Install Z3 SMT solver (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $z3Version = "4.13.4"
          $z3Url = "https://github.com/Z3Prover/z3/releases/download/z3-${z3Version}/z3-${z3Version}-x64-win.zip"
          $z3Zip = "$env:TEMP\z3.zip"
          Write-Host "Downloading Z3 $z3Version..."
          Invoke-WebRequest -Uri $z3Url -OutFile $z3Zip
          Write-Host "Extracting Z3..."
          Expand-Archive -Path $z3Zip -DestinationPath "C:\tools" -Force
          $extracted = Get-ChildItem "C:\tools" -Filter "z3-*" -Directory | Select-Object -First 1
          if ($extracted) {
            Rename-Item -Path $extracted.FullName -NewName "z3" -Force
          }
          # Add bin to PATH for z3 executable
          echo "C:\tools\z3\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          # Set env vars for z3-sys build script:
          # - Z3_SYS_Z3_HEADER: path to z3.h for bindgen
          # - Z3_LIBRARY_PATH_OVERRIDE: directory containing libz3.lib (in bin/, not lib/)
          #   z3-sys uses this to emit cargo:rustc-link-search=native=<path>
          echo "Z3_SYS_Z3_HEADER=C:\tools\z3\include\z3.h" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "Z3_LIBRARY_PATH_OVERRIDE=C:\tools\z3\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Z3 installed at C:\tools\z3"

      - name: Verify Z3 installation
        shell: bash
        run: z3 --version

      - name: Install Rust toolchain (from rust-toolchain.toml)
        run: rustup show

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-
            ${{ runner.os }}-cargo-

      - name: Run tests
        shell: bash
        run: cargo test --workspace --all-features

      - name: Build release binaries
        shell: bash
        run: cargo build --release --package rust-fv-driver

      - name: Prepare release artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp target/release/cargo-verify dist/cargo-verify-${{ matrix.artifact_suffix }}
          cp target/release/rust-fv-driver dist/rust-fv-driver-${{ matrix.artifact_suffix }}
          chmod +x dist/cargo-verify-${{ matrix.artifact_suffix }} dist/rust-fv-driver-${{ matrix.artifact_suffix }}
          sha256sum dist/cargo-verify-${{ matrix.artifact_suffix }} dist/rust-fv-driver-${{ matrix.artifact_suffix }} > dist/SHA256SUMS-${{ matrix.artifact_suffix }}.txt

      - name: Prepare release artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item "target\release\cargo-verify.exe" "dist\cargo-verify-${{ matrix.artifact_suffix }}.exe"
          Copy-Item "target\release\rust-fv-driver.exe" "dist\rust-fv-driver-${{ matrix.artifact_suffix }}.exe"
          $hash1 = (Get-FileHash "dist\cargo-verify-${{ matrix.artifact_suffix }}.exe" -Algorithm SHA256).Hash.ToLower()
          $hash2 = (Get-FileHash "dist\rust-fv-driver-${{ matrix.artifact_suffix }}.exe" -Algorithm SHA256).Hash.ToLower()
          "$hash1  cargo-verify-${{ matrix.artifact_suffix }}.exe" | Out-File -FilePath "dist\SHA256SUMS-${{ matrix.artifact_suffix }}.txt" -Encoding utf8
          "$hash2  rust-fv-driver-${{ matrix.artifact_suffix }}.exe" | Out-File -FilePath "dist\SHA256SUMS-${{ matrix.artifact_suffix }}.txt" -Encoding utf8 -Append

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.artifact_suffix }}
          path: dist/
          retention-days: 1

  build-vsix:
    name: Build VSCode Extension
    needs: verify-tag
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Install dependencies
        working-directory: vscode-extension
        run: npm ci

      - name: Type-check
        working-directory: vscode-extension
        run: npm run lint

      - name: Build
        working-directory: vscode-extension
        run: npm run build

      - name: Package VSIX
        working-directory: vscode-extension
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          npx vsce package --out "rust-fv-${VERSION}.vsix"
          sha256sum "rust-fv-${VERSION}.vsix" > "SHA256SUMS-vsix.txt"

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix
          path: |
            vscode-extension/rust-fv-*.vsix
            vscode-extension/SHA256SUMS-vsix.txt
          retention-days: 1

  release:
    name: Create GitHub Release
    needs: [build, build-vsix]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Combine SHA256SUMS
        run: |
          cat dist/SHA256SUMS-*.txt > dist/SHA256SUMS.txt
          rm dist/SHA256SUMS-*.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/cargo-verify-linux-x86_64
            dist/rust-fv-driver-linux-x86_64
            dist/cargo-verify-macos-aarch64
            dist/rust-fv-driver-macos-aarch64
            dist/cargo-verify-windows-x86_64.exe
            dist/rust-fv-driver-windows-x86_64.exe
            dist/rust-fv-*.vsix
            dist/SHA256SUMS.txt

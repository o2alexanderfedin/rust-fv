name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Z3 SMT solver (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y z3

      - name: Install Z3 SMT solver (macOS)
        if: runner.os == 'macOS'
        run: brew install z3

      - name: Install Z3 SMT solver (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Download and extract Z3 release binary
          $z3Version = "4.13.4"
          $z3Url = "https://github.com/Z3Prover/z3/releases/download/z3-${z3Version}/z3-${z3Version}-x64-win.zip"
          $z3Zip = "$env:TEMP\z3.zip"
          $z3Dir = "C:\tools\z3"
          Write-Host "Downloading Z3 $z3Version..."
          Invoke-WebRequest -Uri $z3Url -OutFile $z3Zip
          Write-Host "Extracting Z3..."
          Expand-Archive -Path $z3Zip -DestinationPath "C:\tools" -Force
          # The zip contains a versioned subdirectory; rename for stable path
          $extracted = Get-ChildItem "C:\tools" -Filter "z3-*" -Directory | Select-Object -First 1
          if ($extracted) {
            Rename-Item -Path $extracted.FullName -NewName "z3" -Force
          }
          # Add bin to PATH for z3 executable
          echo "C:\tools\z3\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          # Set env vars for z3-sys build script (bindgen needs z3.h, linker needs libz3.lib)
          echo "Z3_SYS_Z3_HEADER=C:\tools\z3\include\z3.h" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "LIB=C:\tools\z3\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Z3 installed at C:\tools\z3"
          Write-Host "  bin:     C:\tools\z3\bin"
          Write-Host "  include: C:\tools\z3\include"
          Write-Host "  lib:     C:\tools\z3\lib"

      - name: Verify Z3 installation
        shell: bash
        run: z3 --version

      - name: Install Rust toolchain (from rust-toolchain.toml)
        run: rustup show

      - name: Cache Cargo registry and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings

      - name: Run tests
        shell: bash
        run: cargo test --workspace --all-features

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain (from rust-toolchain.toml)
        run: rustup show

      - name: Check formatting
        run: cargo fmt --all -- --check
